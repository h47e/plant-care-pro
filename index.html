<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Care Pro - Final Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#22D3EE',
                        secondary: '#0891B2',
                        dark: '#1E293B',
                        darker: '#0F172A',
                        accent: '#10B981'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-darker text-white font-['Inter']">
    <!-- Header -->
    <header class="bg-dark border-b border-gray-700 px-6 py-4 flex items-center justify-between">
        <h1 class="text-lg font-bold text-primary">Plant Care Pro</h1>
        <div class="flex items-center gap-4">
            <button id="settings-btn" class="p-2 hover:bg-gray-700 rounded-lg transition-colors" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Mobile menu button -->
    <button id="mobile-menu-btn" class="fixed top-4 left-4 z-50 lg:hidden p-2 bg-dark border border-gray-600 rounded-lg shadow-lg">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Mobile overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>

    <div class="flex h-screen max-w-7xl mx-auto">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-40 w-80 bg-dark border-r border-gray-700 flex flex-col overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <!-- My Plants Section -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center gap-2 text-primary mb-4">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                    </svg>
                    <h2 class="font-semibold">–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è</h2>
                </div>
                
                <button id="add-plant-btn" class="w-full bg-primary text-darker px-4 py-3 rounded-lg font-medium hover:bg-opacity-90 transition-colors flex items-center justify-center gap-2 mb-4">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ
                </button>

                <!-- Plants List -->
                <div id="plants-list" class="space-y-3">
                    <!-- Plant cards will be rendered here -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-white font-semibold mb-3">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <div class="space-y-2">
                    <button id="quick-water-btn" class="w-full flex items-center gap-3 p-3 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors text-left">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span>–ü–æ–ª–∏–≤ —Å–µ–π—á–∞—Å</span>
                    </button>
                </div>
            </div>

            <!-- Today Events -->
            <div class="p-4">
                <h3 class="text-white font-semibold mb-3">–°–æ–±—ã—Ç–∏—è —Å–µ–≥–æ–¥–Ω—è</h3>
                <div id="sidebar-today-events" class="space-y-2">
                    <!-- Today's events will be rendered here -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden lg:ml-0">
            <!-- Navigation Tabs -->
            <div class="bg-dark border-b border-gray-700 px-6 py-4">
                <nav class="flex gap-4">
                    <button id="tab-dashboard" class="tab-btn flex items-center justify-center w-12 h-10 bg-primary text-darker rounded-lg font-medium" title="–î–∞—à–±–æ—Ä–¥">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </button>
                    <button id="tab-fertilizers" class="tab-btn flex items-center justify-center w-12 h-10 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="–£–¥–æ–±—Ä–µ–Ω–∏—è">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"></path>
                        </svg>
                    </button>
                    <button id="tab-recipes" class="tab-btn flex items-center justify-center w-12 h-10 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="–†–µ—Ü–µ–ø—Ç—ã">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </button>
                    <button id="tab-history" class="tab-btn flex items-center justify-center w-12 h-10 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="–ò—Å—Ç–æ—Ä–∏—è">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </nav>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto bg-darker">
                <!-- Dashboard Tab -->
                <div id="content-dashboard" class="tab-content p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <h1 class="text-2xl font-bold">üìä –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞—Å—Ç–µ–Ω–∏—è</h1>
                        </div>
                        <div class="flex items-center gap-4">
                            <button id="prev-month-btn" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h3 id="current-month" class="text-lg font-medium min-w-32 text-center">–ê–≤–≥—É—Å—Ç 2025</h3>
                            <button id="next-month-btn" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                            <button id="today-btn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-sm">
                                –°–µ–≥–æ–¥–Ω—è
                            </button>
                        </div>
                    </div>

                    <!-- Plant Calendars Container -->
                    <div id="plant-calendars-container" class="space-y-8 max-w-6xl mx-auto">
                        <!-- Individual plant calendars will be rendered here -->
                    </div>

                    <!-- Empty State -->
                    <div id="no-plants-message" class="hidden text-center py-16 text-gray-400">
                        <svg class="w-20 h-20 mx-auto mb-6 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        <h3 class="text-xl font-semibold mb-2">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</h3>
                        <p class="text-gray-500 mb-6">–î–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏—è —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                        <button onclick="app.showPlantModal()" class="bg-primary text-darker px-6 py-3 rounded-lg font-medium hover:bg-opacity-90 transition-colors">
                            –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>



                <!-- Fertilizers Tab -->
                <div id="content-fertilizers" class="tab-content hidden p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-2xl font-bold">üß™ –ö–∞—Ç–∞–ª–æ–≥ —É–¥–æ–±—Ä–µ–Ω–∏–π</h1>
                        <button id="add-fertilizer-btn" class="bg-primary text-darker px-4 py-2 rounded-lg font-medium hover:bg-opacity-90 transition-colors">
                            –î–æ–±–∞–≤–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏–µ
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="fertilizers-grid">
                        <!-- Fertilizers will be rendered here -->
                    </div>
                </div>

                <!-- Recipes Tab -->
                <div id="content-recipes" class="tab-content hidden p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-2xl font-bold">üåø –†–µ—Ü–µ–ø—Ç—ã –ø–æ–ª–∏–≤–∞</h1>
                        <button id="add-recipe-btn" class="bg-primary text-darker px-4 py-2 rounded-lg font-medium hover:bg-opacity-90 transition-colors">
                            –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="recipes-list">
                        <!-- Recipes will be rendered here -->
                    </div>
                </div>

                <!-- History Tab -->
                <div id="content-history" class="tab-content hidden p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-2xl font-bold">üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–∏–≤–æ–≤</h1>
                        <div class="flex items-center gap-4">
                            <select id="history-plant-filter" class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm">
                                <option value="">–í—Å–µ —Ä–∞—Å—Ç–µ–Ω–∏—è</option>
                            </select>
                            <select id="history-period-filter" class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm">
                                <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                                <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                                <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                                <option value="all">–í—Å–µ –∑–∞–ø–∏—Å–∏</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-dark p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-400 mb-1">–í—Å–µ–≥–æ –ø–æ–ª–∏–≤–æ–≤</h3>
                            <div class="text-2xl font-bold text-blue-400" id="total-waterings">0</div>
                        </div>
                        <div class="bg-dark p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-400 mb-1">–û–±—â–∏–π –æ–±—ä–µ–º</h3>
                            <div class="text-2xl font-bold text-cyan-400" id="total-volume">0–ª</div>
                        </div>
                        <div class="bg-dark p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-400 mb-1">–°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º</h3>
                            <div class="text-2xl font-bold text-green-400" id="average-volume">0–ª</div>
                        </div>
                        <div class="bg-dark p-4 rounded-lg">
                            <h3 class="text-sm font-semibold text-gray-400 mb-1">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç</h3>
                            <div class="text-sm font-bold text-purple-400" id="popular-recipe">-</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4" id="watering-history-list">
                        <!-- Watering history will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Plant Modal -->
    <div id="plant-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-dark p-6 rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <h2 id="plant-modal-title" class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ</h2>
            <form id="plant-form">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Basic Info -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-primary mb-3">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input id="plant-name" type="text" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–î–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏</label>
                            <input id="plant-date" type="date" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–°–æ—Ä—Ç</label>
                            <input id="plant-strain" type="text" class="w-full bg-gray-700 text-white p-3 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–í–∏–¥ —Ä–∞—Å—Ç–µ–Ω–∏—è</label>
                            <select id="plant-species" name="plant-species" class="w-full bg-gray-700 text-white p-3 rounded-lg">
                                <option value="">üå± –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥</option>
                                <option value="cannabis-indica">üåø Cannabis Indica</option>
                                <option value="cannabis-sativa">üå≤ Cannabis Sativa</option>
                                <option value="cannabis-hybrid">üå≥ Cannabis Hybrid (–ì–∏–±—Ä–∏–¥)</option>
                                <option value="cannabis-ruderalis">üåæ Cannabis Ruderalis (–ê–≤—Ç–æ—Ü–≤–µ—Ç)</option>
                                <option value="tomato">üçÖ –¢–æ–º–∞—Ç</option>
                                <option value="pepper">üå∂Ô∏è –ü–µ—Ä–µ—Ü</option>
                                <option value="cucumber">ü•í –û–≥—É—Ä–µ—Ü</option>
                                <option value="lettuce">ü•¨ –°–∞–ª–∞—Ç</option>
                                <option value="basil">üåø –ë–∞–∑–∏–ª–∏–∫</option>
                                <option value="mint">üåø –ú—è—Ç–∞</option>
                                <option value="parsley">üåø –ü–µ—Ç—Ä—É—à–∫–∞</option>
                                <option value="cilantro">üåø –ö–∏–Ω–∑–∞</option>
                                <option value="spinach">ü•¨ –®–ø–∏–Ω–∞—Ç</option>
                                <option value="other">‚ùì –î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–°—É–±—Å—Ç—Ä–∞—Ç –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏—è</label>
                            <select id="plant-substrate" class="w-full bg-gray-700 text-white p-3 rounded-lg">
                                <option value="">üå± –í—ã–±–µ—Ä–∏—Ç–µ —Å—É–±—Å—Ç—Ä–∞—Ç</option>
                                <option value="soil-organic">üåç –ü–æ—á–≤–∞ (–æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∞—è)</option>
                                <option value="soil-commercial">üè™ –ü–æ—á–≤–∞ (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è)</option>
                                <option value="coco-coir">ü•• –ö–æ–∫–æ—Å–æ–≤–æ–µ –≤–æ–ª–æ–∫–Ω–æ</option>
                                <option value="perlite-vermiculite">‚ö™ –ü–µ—Ä–ª–∏—Ç + –í–µ—Ä–º–∏–∫—É–ª–∏—Ç</option>
                                <option value="hydroponic-clay">üîµ –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (–∫–µ—Ä–∞–º–∑–∏—Ç)</option>
                                <option value="hydroponic-rockwool">üßΩ –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (–º–∏–Ω–≤–∞—Ç–∞)</option>
                                <option value="hydroponic-dwc">üíß –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (DWC)</option>
                                <option value="hydroponic-nft">üåä –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (NFT)</option>
                                <option value="aeroponic">üí® –ê—ç—Ä–æ–ø–æ–Ω–∏–∫–∞</option>
                                <option value="soilless-mix">üåø –ë–µ—Å–ø–æ—á–≤–µ–Ω–Ω–∞—è —Å–º–µ—Å—å</option>
                                <option value="peat-moss">üçÑ –¢–æ—Ä—Ñ—è–Ω–æ–π –º–æ—Ö</option>
                                <option value="other">‚ùì –î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–í—Ä–µ–º—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</label>
                            <input id="plant-light-on" type="time" class="w-full bg-gray-700 text-white p-3 rounded-lg" value="08:00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–§–æ—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è</label>
                            
                            <!-- Tab buttons for upload method -->
                            <div class="flex gap-2 mb-3">
                                <button type="button" id="plant-upload-file-btn" class="px-3 py-1 bg-primary text-darker rounded text-sm font-medium">
                                    –§–∞–π–ª
                                </button>
                                <button type="button" id="plant-upload-url-btn" class="px-3 py-1 bg-gray-700 text-white rounded text-sm">
                                    –°—Å—ã–ª–∫–∞
                                </button>
                            </div>
                            
                            <!-- File upload -->
                            <div id="plant-file-upload" class="flex flex-col gap-3">
                                <input id="plant-image" type="file" accept="image/*" class="w-full bg-gray-700 text-white p-3 rounded-lg file:mr-3 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-primary file:text-darker hover:file:bg-opacity-90">
                                <div class="text-xs text-gray-400">
                                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, WEBP. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB
                                </div>
                            </div>
                            
                            <!-- URL upload -->
                            <div id="plant-url-upload" class="hidden flex flex-col gap-3">
                                <input id="plant-image-url" type="url" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="https://example.com/image.jpg">
                                <button type="button" id="load-plant-image-url" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm font-medium">
                                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ
                                </button>
                                <div class="text-xs text-gray-400">
                                    –í–≤–µ–¥–∏—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG, PNG, WEBP)
                                </div>
                            </div>
                            
                            <!-- Image preview -->
                            <div id="plant-image-preview" class="hidden mt-3">
                                <img id="plant-preview-img" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="w-full h-32 object-cover rounded-lg">
                                <button type="button" id="remove-plant-image" class="mt-2 text-red-400 hover:text-red-300 text-sm">
                                    –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Growth Phases Configuration -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-primary">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–∑ —Ä–æ—Å—Ç–∞</h3>
                            <div class="flex gap-2">
                                <button type="button" id="date-mode-btn" class="px-3 py-1 bg-primary text-darker rounded text-sm font-medium">
                                    –ü–æ –¥–∞—Ç–∞–º
                                </button>
                                <button type="button" id="duration-mode-btn" class="px-3 py-1 bg-gray-700 text-white rounded text-sm">
                                    –ü–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                                </button>
                            </div>
                        </div>
                        
                        <!-- Date Mode -->
                        <div id="date-mode-config" class="space-y-4">
                            <!-- Vegetation Phase -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-green-400 text-lg">üå±</span>
                                    <h4 class="font-medium text-green-400">–í–µ–≥–µ—Ç–∞—Ü–∏—è (18/6)</h4>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                        <input id="veg-start-date" type="date" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                        <input id="veg-end-date" type="date" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    <span id="veg-duration-display">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 0 –¥–Ω–µ–π</span>
                                </div>
                            </div>

                            <!-- Flowering Phase -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-purple-400 text-lg">üå∏</span>
                                    <h4 class="font-medium text-purple-400">–¶–≤–µ—Ç–µ–Ω–∏–µ (12/12)</h4>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                        <input id="flower-start-date" type="date" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                        <input id="flower-end-date" type="date" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    <span id="flower-duration-display">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 0 –¥–Ω–µ–π</span>
                                </div>
                            </div>

                            <!-- Drying Phase -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-orange-400 text-lg">üçÇ</span>
                                    <h4 class="font-medium text-orange-400">–°—É—à–∫–∞ (0/24)</h4>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                        <input id="dry-start-date" type="date" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                        <input id="dry-end-date" type="date" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    <span id="dry-duration-display">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 0 –¥–Ω–µ–π</span>
                                </div>
                            </div>
                        </div>

                        <!-- Duration Mode -->
                        <div id="duration-mode-config" class="space-y-4 hidden">
                            <!-- Vegetation Phase -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-green-400 text-lg">üå±</span>
                                    <h4 class="font-medium text-green-400">–í–µ–≥–µ—Ç–∞—Ü–∏—è (18/6)</h4>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–∏)</label>
                                        <input id="veg-duration" type="number" min="14" max="70" value="28" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ: 21-42 –¥–Ω—è</label>
                                        <div class="text-xs text-gray-500 mt-1">–û–ø—Ç–∏–º–∞–ª—å–Ω–æ: 28 –¥–Ω–µ–π</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Flowering Phase -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-purple-400 text-lg">üå∏</span>
                                    <h4 class="font-medium text-purple-400">–¶–≤–µ—Ç–µ–Ω–∏–µ (12/12)</h4>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–∏)</label>
                                        <input id="flower-duration" type="number" min="35" max="91" value="63" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ: 49-77 –¥–Ω–µ–π</label>
                                        <div class="text-xs text-gray-500 mt-1">–û–ø—Ç–∏–º–∞–ª—å–Ω–æ: 63 –¥–Ω—è</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Drying Phase -->
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-orange-400 text-lg">üçÇ</span>
                                    <h4 class="font-medium text-orange-400">–°—É—à–∫–∞ (0/24)</h4>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–∏)</label>
                                        <input id="dry-duration" type="number" min="3" max="21" value="10" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ: 5-14 –¥–Ω–µ–π</label>
                                        <div class="text-xs text-gray-500 mt-1">–û–ø—Ç–∏–º–∞–ª—å–Ω–æ: 10 –¥–Ω–µ–π</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Growth Cycle Forecast -->
                <div class="mt-6 bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-primary mb-4">–ü—Ä–æ–≥–Ω–æ–∑ —Ü–∏–∫–ª–∞ —Ä–æ—Å—Ç–∞</h3>
                    <div id="growth-forecast" class="space-y-3">
                        <!-- Growth timeline will be rendered here -->
                    </div>
                    <div class="mt-4 p-3 bg-gray-700 rounded">
                        <div class="text-sm text-gray-300">
                            <strong>–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏–∫–ª–∞:</strong> <span id="total-cycle-days">101</span> –¥–Ω–µ–π (~<span id="total-cycle-weeks">14.4</span> –Ω–µ–¥–µ–ª—å)
                        </div>
                        <div class="text-sm text-gray-400 mt-1">
                            <strong>–û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ —Ö–∞—Ä–≤–µ—Å—Ç–∞:</strong> <span id="estimated-harvest-date">-</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="button" id="plant-cancel-btn" class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="flex-1 bg-primary text-darker px-4 py-2 rounded-lg hover:bg-opacity-90">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Fertilizer Modal -->
    <div id="fertilizer-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-dark p-6 rounded-lg w-full max-w-md mx-4 max-h-[85vh] overflow-y-auto">
            <h2 id="fertilizer-modal-title" class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏–µ</h2>
            <form id="fertilizer-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input id="fertilizer-name" type="text" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">N (%)</label>
                            <input id="fertilizer-n" type="number" step="0.1" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">P (%)</label>
                            <input id="fertilizer-p" type="number" step="0.1" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">K (%)</label>
                            <input id="fertilizer-k" type="number" step="0.1" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å (–≥/–º–ª)</label>
                        <input id="fertilizer-density" type="number" step="0.01" value="1.0" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">–ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã</label>
                        <textarea id="fertilizer-micro" placeholder="Ca, Mg, S, Fe..." class="w-full bg-gray-700 text-white p-3 rounded-lg h-20"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">–§–æ—Ç–æ —É–¥–æ–±—Ä–µ–Ω–∏—è</label>
                        
                        <!-- Tab buttons for upload method -->
                        <div class="flex gap-2 mb-3">
                            <button type="button" id="fertilizer-upload-file-btn" class="px-3 py-1 bg-primary text-darker rounded text-sm font-medium">
                                –§–∞–π–ª
                            </button>
                            <button type="button" id="fertilizer-upload-url-btn" class="px-3 py-1 bg-gray-700 text-white rounded text-sm">
                                –°—Å—ã–ª–∫–∞
                            </button>
                        </div>
                        
                        <!-- File upload -->
                        <div id="fertilizer-file-upload" class="flex flex-col gap-3">
                            <input id="fertilizer-image" type="file" accept="image/*" class="w-full bg-gray-700 text-white p-3 rounded-lg file:mr-3 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-primary file:text-darker hover:file:bg-opacity-90">
                            <div class="text-xs text-gray-400">
                                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, WEBP. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB
                            </div>
                        </div>
                        
                        <!-- URL upload -->
                        <div id="fertilizer-url-upload" class="hidden flex flex-col gap-3">
                            <input id="fertilizer-image-url" type="url" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="https://example.com/image.jpg">
                            <button type="button" id="load-fertilizer-image-url" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm font-medium">
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ
                            </button>
                            <div class="text-xs text-gray-400">
                                –í–≤–µ–¥–∏—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG, PNG, WEBP)<br>
                                <span class="text-gray-500">–ü—Ä–∏–º–µ—Ä—ã: imgur.com, postimg.cc, Google Drive, Dropbox</span>
                            </div>
                        </div>
                        
                        <!-- Image preview -->
                        <div id="fertilizer-image-preview" class="hidden mt-3">
                            <img id="fertilizer-preview-img" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="w-full h-32 object-cover rounded-lg">
                            <button type="button" id="remove-fertilizer-image" class="mt-2 text-red-400 hover:text-red-300 text-sm">
                                –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" id="fertilizer-cancel-btn" class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="flex-1 bg-primary text-darker px-4 py-2 rounded-lg hover:bg-opacity-90">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recipe Modal -->
    <div id="recipe-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-dark p-6 rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h2 id="recipe-modal-title" class="text-xl font-bold mb-4">–°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç</h2>
            <form id="recipe-form">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input id="recipe-name" type="text" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–û–±—ä–µ–º –≤–æ–¥—ã (–ª)</label>
                            <input id="recipe-volume" type="number" step="0.1" value="1" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">–£–¥–æ–±—Ä–µ–Ω–∏—è</label>
                        <div id="recipe-fertilizers" class="space-y-2">
                            <!-- Fertilizer inputs will be added here -->
                        </div>
                        <button type="button" id="add-recipe-fertilizer-btn" class="mt-2 text-primary hover:underline">
                            + –î–æ–±–∞–≤–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏–µ
                        </button>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">–ò—Ç–æ–≥–æ–≤—ã–π —Å–æ—Å—Ç–∞–≤:</h3>
                        <div id="recipe-totals" class="text-sm text-gray-300">
                            <!-- Calculated totals will be shown here -->
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" id="recipe-cancel-btn" class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="flex-1 bg-primary text-darker px-4 py-2 rounded-lg hover:bg-opacity-90">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Watering Modal -->
    <div id="watering-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-dark p-6 rounded-lg w-full max-w-2xl mx-4 max-h-[85vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                üíß <span>–ü–æ–ª–∏–≤ —Ä–∞—Å—Ç–µ–Ω–∏–π</span>
            </h2>
            <form id="watering-form">
                <div class="space-y-6">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">–î–∞—Ç–∞ –ø–æ–ª–∏–≤–∞</label>
                            <input id="watering-date" type="datetime-local" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">–û–±—ä–µ–º –≤–æ–¥—ã (–ª)</label>
                            <input id="watering-volume" type="number" step="0.1" value="5" min="0.1" class="w-full bg-gray-700 text-white p-3 rounded-lg" required>
                        </div>
                    </div>

                    <!-- Plant Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2">–†–∞—Å—Ç–µ–Ω–∏—è –¥–ª—è –ø–æ–ª–∏–≤–∞</label>
                        <div id="watering-plants" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- Plant checkboxes will be rendered here -->
                        </div>
                    </div>

                    <!-- Recipe Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2">–†–µ—Ü–µ–ø—Ç –ø–∏—Ç–∞–Ω–∏—è</label>
                        <div class="flex gap-2">
                            <select id="watering-recipe" class="flex-1 bg-gray-700 text-white p-3 rounded-lg" onchange="app.updateWateringCalculation()">
                                <option value="">–¢–æ–ª—å–∫–æ –≤–æ–¥–∞</option>
                            </select>
                            <button type="button" id="auto-recipe-btn" class="px-4 py-2 bg-primary text-darker rounded-lg hover:bg-opacity-90 text-sm font-medium">
                                –ê–≤—Ç–æ-–≤—ã–±–æ—Ä
                            </button>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            –ê–≤—Ç–æ-–≤—ã–±–æ—Ä –ø–æ–¥–±–µ—Ä–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–µ—Ü–µ–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∑—ã —Ä–æ—Å—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π
                        </div>
                    </div>

                    <!-- Fertilizer Calculation -->
                    <div id="watering-calculation" class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-semibold mb-3">–†–∞—Å—á–µ—Ç —É–¥–æ–±—Ä–µ–Ω–∏–π</h3>
                        <div id="fertilizer-amounts" class="space-y-2">
                            <!-- Calculated fertilizer amounts will be shown here -->
                        </div>
                        <div id="nutrient-totals" class="mt-4 pt-3 border-t border-gray-600">
                            <div class="text-sm text-gray-300">
                                <strong>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤:</strong>
                            </div>
                            <div id="nutrient-values" class="grid grid-cols-3 gap-4 mt-2 text-sm">
                                <!-- N-P-K values will be shown here -->
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-medium mb-2">–ó–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="watering-notes" class="w-full bg-gray-700 text-white p-3 rounded-lg h-20" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ –ø–æ–ª–∏–≤–µ..."></textarea>
                    </div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="button" id="watering-cancel-btn" class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="flex-1 bg-primary text-darker px-4 py-2 rounded-lg hover:bg-opacity-90 font-medium">
                        –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–∏–≤
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-dark p-6 rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </h2>
            <form id="settings-form">
                <div class="space-y-6">
                    <!-- General Settings -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-primary border-b border-gray-600 pb-2">üé® –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</label>
                            <input id="settings-app-title" type="text" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="Plant Care Pro" required>
                            <div class="text-xs text-gray-400 mt-1">
                                –≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                            </div>
                        </div>
                    </div>

                    <!-- Home Assistant Integration -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-primary border-b border-gray-600 pb-2">üè† –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Home Assistant</h3>
                        
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input id="settings-ha-enabled" type="checkbox" class="w-5 h-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2">
                                <div>
                                    <div class="font-medium">–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Home Assistant</div>
                                    <div class="text-sm text-gray-400">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö —Å —Å–∏—Å—Ç–µ–º–æ–π —É–º–Ω–æ–≥–æ –¥–æ–º–∞</div>
                                </div>
                            </label>
                        </div>

                        <div id="ha-settings-content" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium mb-2">URL Home Assistant</label>
                                <input id="settings-ha-url" type="url" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="http://homeassistant.local:8123">
                                <div class="text-xs text-gray-400 mt-1">
                                    –ê–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ Home Assistant (–Ω–∞–ø—Ä–∏–º–µ—Ä: http://192.168.1.100:8123)
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞</label>
                                <input id="settings-ha-token" type="password" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞">
                                <div class="text-xs text-gray-400 mt-1">
                                    –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ü—Ä–æ—Ñ–∏–ª–µ ‚Üí –¢–æ–∫–µ–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ Home Assistant
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">–ü—Ä–µ—Ñ–∏–∫—Å —Å—É—â–Ω–æ—Å—Ç–µ–π</label>
                                <input id="settings-ha-prefix" type="text" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="plant_care" value="plant_care">
                                <div class="text-xs text-gray-400 mt-1">
                                    –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: sensor.plant_care_plant1_phase)
                                </div>
                            </div>

                            <div class="bg-blue-600/10 border border-blue-600/30 p-4 rounded-lg">
                                <h4 class="font-medium text-blue-400 mb-2">üìä –°–æ–∑–¥–∞–≤–∞–µ–º—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:</h4>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li>‚Ä¢ <code>sensor.{prefix}_{plant}_phase</code> - —Ç–µ–∫—É—â–∞—è —Ñ–∞–∑–∞ —Ä–æ—Å—Ç–∞</li>
                                    <li>‚Ä¢ <code>sensor.{prefix}_{plant}_day</code> - –¥–µ–Ω—å —Å –ø–æ—Å–∞–¥–∫–∏</li>
                                    <li>‚Ä¢ <code>sensor.{prefix}_{plant}_light_schedule</code> - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–≤–µ—Ç–∞</li>
                                    <li>‚Ä¢ <code>binary_sensor.{prefix}_{plant}_needs_watering</code> - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–∏–≤</li>
                                    <li>‚Ä¢ <code>sensor.{prefix}_total_plants</code> - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç–µ–Ω–∏–π</li>
                                </ul>
                            </div>

                            <div class="flex gap-3">
                                <button type="button" id="test-ha-connection" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm font-medium">
                                    üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                                </button>
                                <button type="button" id="sync-ha-entities" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors text-sm font-medium">
                                    üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏
                                </button>
                            </div>

                            <div id="ha-connection-status" class="hidden p-3 rounded-lg text-sm">
                                <!-- Connection status will be shown here -->
                            </div>
                        </div>
                    </div>

                    <!-- Telegram Integration -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-primary border-b border-gray-600 pb-2">üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram</h3>
                        
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input id="settings-telegram-enabled" type="checkbox" class="w-5 h-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2">
                                <div>
                                    <div class="font-medium">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</div>
                                    <div class="text-sm text-gray-400">–ü–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ–ª–∏–≤–µ –∏ —Å—Ç–∞—Ç—É—Å–µ —Ä–∞—Å—Ç–µ–Ω–∏–π</div>
                                </div>
                            </label>
                        </div>

                        <div id="telegram-settings-content" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium mb-2">–¢–æ–∫–µ–Ω –±–æ—Ç–∞</label>
                                <input id="settings-telegram-token" type="password" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="1234567890:AABBCCDDEEFFGGHHIIJJKKLLMMNNOOPPQQRr">
                                <div class="text-xs text-gray-400 mt-1">
                                    –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Chat ID</label>
                                <div class="flex gap-2">
                                    <input id="settings-telegram-chat-id" type="text" class="flex-1 bg-gray-700 text-white p-3 rounded-lg" placeholder="123456789">
                                    <button type="button" id="get-telegram-chat-id" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm font-medium">
                                        –ü–æ–ª—É—á–∏—Ç—å ID
                                    </button>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –±–æ—Ç—É, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å ID"
                                </div>
                            </div>

                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-medium text-white mb-3">üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>
                                <div class="space-y-3">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input id="settings-telegram-watering-reminders" type="checkbox" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2" checked>
                                        <div>
                                            <div class="text-sm font-medium">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø–æ–ª–∏–≤–µ</div>
                                            <div class="text-xs text-gray-400">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ –ø–æ–ª–∏–≤–µ</div>
                                        </div>
                                    </label>

                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input id="settings-telegram-phase-changes" type="checkbox" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2" checked>
                                        <div>
                                            <div class="text-sm font-medium">–°–º–µ–Ω–∞ —Ñ–∞–∑ —Ä–æ—Å—Ç–∞</div>
                                            <div class="text-xs text-gray-400">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–µ—Ä–µ—Ö–æ–¥–µ —Ä–∞—Å—Ç–µ–Ω–∏–π –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏</div>
                                        </div>
                                    </label>

                                    <div class="border-t border-gray-600 pt-3">
                                        <label class="flex items-center gap-3 cursor-pointer mb-3">
                                            <input id="settings-telegram-daily-summary" type="checkbox" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2">
                                            <div>
                                                <div class="text-sm font-medium">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞</div>
                                                <div class="text-xs text-gray-400">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π</div>
                                            </div>
                                        </label>

                                        <div id="daily-summary-time" class="ml-7 hidden">
                                            <label class="block text-xs text-gray-400 mb-1">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–≤–æ–¥–∫–∏</label>
                                            <input id="settings-telegram-daily-time" type="time" value="09:00" class="bg-gray-700 text-white p-2 rounded text-sm">
                                        </div>
                                    </div>

                                    <div class="border-t border-gray-600 pt-3">
                                        <label class="flex items-center gap-3 cursor-pointer mb-3">
                                            <input id="settings-telegram-auto-backup" type="checkbox" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2">
                                            <div>
                                                <div class="text-sm font-medium">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø</div>
                                                <div class="text-xs text-gray-400">–†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –≤ Telegram</div>
                                            </div>
                                        </label>

                                        <div id="auto-backup-time" class="ml-7 hidden space-y-3">
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block text-xs text-gray-400 mb-1">–ß–∞—Å—Ç–æ—Ç–∞</label>
                                                    <select id="settings-telegram-backup-frequency" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                                        <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                                                        <option value="weekly" selected>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                                                        <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-400 mb-1">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                                                    <input id="settings-telegram-backup-time" type="time" value="02:00" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: <span id="last-telegram-backup-time">–Ω–∏–∫–æ–≥–¥–∞</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-3">
                                <button type="button" id="test-telegram-connection" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-sm font-medium">
                                    üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                </button>
                                <button type="button" id="send-plant-status" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors text-sm font-medium">
                                    üìä –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞—Å—Ç–µ–Ω–∏–π
                                </button>
                                <button type="button" id="send-backup-telegram" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors text-sm font-medium">
                                    üíæ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±—ç–∫–∞–ø
                                </button>
                            </div>

                            <div id="telegram-connection-status" class="hidden p-3 rounded-lg text-sm">
                                <!-- Connection status will be shown here -->
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-primary border-b border-gray-600 pb-2">üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                        
                        <!-- Export Options -->
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-medium text-white mb-3">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏ –±—ç–∫–∞–ø</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                <button type="button" id="export-data-btn" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-left">
                                    <div class="flex items-center gap-3 mb-1">
                                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="font-medium text-sm">–≠–∫—Å–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞</span>
                                    </div>
                                    <div class="text-xs text-gray-400">–°–∫–∞—á–∞—Ç—å JSON —Ñ–∞–π–ª</div>
                                </button>

                                <button type="button" id="backup-to-folder-btn" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-left">
                                    <div class="flex items-center gap-3 mb-1">
                                        <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-5L12 5H5a2 2 0 00-2 2z"></path>
                                        </svg>
                                        <span class="font-medium text-sm">–ë—ç–∫–∞–ø –≤ –ø–∞–ø–∫—É</span>
                                    </div>
                                    <div class="text-xs text-gray-400">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É</div>
                                </button>
                            </div>

                            <!-- Auto-backup Settings -->
                            <div class="border-t border-gray-600 pt-4">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="settings-auto-backup" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2">
                                        <span class="text-sm font-medium">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø</span>
                                    </label>
                                </div>

                                <div id="auto-backup-settings" class="hidden space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">–ß–∞—Å—Ç–æ—Ç–∞</label>
                                            <select id="settings-backup-frequency" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                                <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                                                <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                                                <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-400 mb-1">–ú–∞–∫—Å. —Ñ–∞–π–ª–æ–≤</label>
                                            <input type="number" id="settings-backup-keep" min="1" max="50" value="10" class="w-full bg-gray-700 text-white p-2 rounded text-sm">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">–ü–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="settings-backup-folder" readonly class="flex-1 bg-gray-600 text-gray-300 p-2 rounded text-sm" placeholder="–ü–∞–ø–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞">
                                            <button type="button" id="select-backup-folder" class="px-3 py-2 bg-primary text-darker rounded text-sm hover:bg-opacity-90">
                                                –í—ã–±—Ä–∞—Ç—å
                                            </button>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: <span id="last-backup-time">–Ω–∏–∫–æ–≥–¥–∞</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Import Options -->
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-medium text-white mb-3">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button type="button" id="import-data-btn" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-left">
                                    <div class="flex items-center gap-3 mb-1">
                                        <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                        </svg>
                                        <span class="font-medium text-sm">–ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞</span>
                                    </div>
                                    <div class="text-xs text-gray-400">–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON —Ñ–∞–π–ª</div>
                                </button>

                                <button type="button" id="restore-from-folder-btn" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-left">
                                    <div class="flex items-center gap-3 mb-1">
                                        <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        <span class="font-medium text-sm">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –ø–∞–ø–∫–∏</span>
                                    </div>
                                    <div class="text-xs text-gray-400">–í—ã–±—Ä–∞—Ç—å –±—ç–∫–∞–ø –∏–∑ –ø–∞–ø–∫–∏</div>
                                </button>
                            </div>
                        </div>

                        <div class="bg-yellow-600/10 border border-yellow-600/30 p-4 rounded-lg">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-yellow-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <div>
                                    <div class="font-medium text-yellow-400 mb-1">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                                    <div class="text-sm text-gray-300">–†–µ–≥—É–ª—è—Ä–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- About -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-primary border-b border-gray-600 pb-2">‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-400">–í–µ—Ä—Å–∏—è</div>
                                    <div class="font-medium">1.0.0 Final</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">–î–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</div>
                                    <div class="font-medium" id="stats-plants-count">0</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">–ó–∞–ø–∏—Å–µ–π –ø–æ–ª–∏–≤–æ–≤</div>
                                    <div class="font-medium" id="stats-waterings-count">0</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö</div>
                                    <div class="font-medium" id="stats-data-size">0 –ö–ë</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="button" id="settings-cancel-btn" class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="flex-1 bg-primary text-darker px-4 py-2 rounded-lg hover:bg-opacity-90 font-medium">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden file input for data import -->
    <input type="file" id="data-import-input" accept=".json" style="display: none;">

    <script type="module">
        // Data Models
        class PlantCareApp {
            constructor() {
                this.data = {
                    plants: {},
                    fertilizers: {},
                    recipes: {},
                    wateringRules: {},
                    singleWaterings: {},
                    wateringHistory: {},
                    lightPhases: {},
                    settings: {
                        currentView: 'dashboard',
                        selectedPlant: null,
                        currentDate: new Date()
                    }
                };
                this.currentPlantId = null;
                this.currentMonth = new Date();
                this.init();
            }

            // Data Management
            loadData() {
                const savedData = localStorage.getItem('plantCareData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    this.data = { ...this.data, ...parsedData };
                    this.data.settings.currentDate = new Date(this.data.settings.currentDate || new Date());
                    this.currentMonth = new Date(this.data.settings.currentDate);
                }
                this.initializeDefaultData();
                

                
                // Force recreation of light phases for all plants
                this.initializePlantPhases();
                
                // Auto-select first plant if none selected
                const plants = Object.values(this.data.plants);
                if (plants.length > 0 && !this.data.settings.selectedPlant) {
                    this.data.settings.selectedPlant = plants[0].id;
                }
            }



            initializePlantPhases() {
                console.log('Initializing plant phases...');
                console.log('Plants found:', Object.keys(this.data.plants).length);
                console.log('Existing light phases:', Object.keys(this.data.lightPhases || {}).length);
                
                // Ensure lightPhases exists
                if (!this.data.lightPhases) {
                    this.data.lightPhases = {};
                }
                
                // Create light phases for all plants
                Object.values(this.data.plants).forEach(plant => {
                    console.log(`Processing plant: ${plant.name}, plantDate: ${plant.plantDate}`);
                    
                    // Add default growth phases if missing
                    if (!plant.growthPhases) {
                        plant.growthPhases = { 
                            useDates: false,
                            vegetation: 28, 
                            flowering: 63, 
                            drying: 10 
                        };
                        console.log(`Added default growth phases to ${plant.name}`);
                    }
                    
                    // Always recreate phases for plants with plant dates
                    if (plant.plantDate) {
                        console.log(`Creating light phases for plant: ${plant.name}`);
                        this.createPlantLightPhases(plant.id, plant);
                    } else {
                        console.log(`Skipping ${plant.name} - no plant date`);
                    }
                });
                
                // Force save after initialization
                this.saveData();
                
                console.log('Light phases after initialization:', Object.keys(this.data.lightPhases).length);
                Object.values(this.data.lightPhases).forEach(phase => {
                    console.log(`Phase: ${phase.type}, Plant: ${phase.plantId}, Start: ${phase.startDate}, End: ${phase.endDate}`);
                });
            }

            saveData() {
                localStorage.setItem('plantCareData', JSON.stringify(this.data));
            }

            initializeDefaultData() {
                // Initialize default settings
                if (!this.data.settings.appTitle) {
                    this.data.settings.appTitle = 'Plant Care Pro';
                }
                if (!this.data.settings.homeAssistant) {
                    this.data.settings.homeAssistant = {
                        enabled: false,
                        url: '',
                        accessToken: '',
                        entityPrefix: 'plant_care'
                    };
                }

                if (!this.data.settings.telegram) {
                    this.data.settings.telegram = {
                        enabled: false,
                        botToken: '',
                        chatId: '',
                        notifications: {
                            wateringReminders: true,
                            phaseChanges: true,
                            dailySummary: false,
                            dailyTime: '09:00'
                        },
                        autoBackup: {
                            enabled: false,
                            frequency: 'weekly',
                            time: '02:00',
                            lastBackup: null
                        },
                        lastDailySummary: null
                    };
                }

                if (!this.data.settings.backup) {
                    this.data.settings.backup = {
                        autoEnabled: false,
                        frequency: 'weekly',
                        keepFiles: 10,
                        folderHandle: null,
                        lastBackupTime: null
                    };
                }

                // Initialize default fertilizers
                if (Object.keys(this.data.fertilizers).length === 0) {
                    this.data.fertilizers = {
                        'sensi-grow-a': {
                            id: 'sensi-grow-a',
                            name: 'Sensi Coco Grow A',
                            npk: { n: 4, p: 0, k: 0 },
                            microElements: 'Ca, Mg, S, Fe, Mn, Zn, Cu, B, Mo',
                            density: 1.2
                        },
                        'sensi-grow-b': {
                            id: 'sensi-grow-b',
                            name: 'Sensi Coco Grow B',
                            npk: { n: 1, p: 3, k: 6 },
                            microElements: 'Ca, Mg, S, Fe, Mn, Zn, Cu, B, Mo',
                            density: 1.2
                        },
                        'sensi-bloom-a': {
                            id: 'sensi-bloom-a',
                            name: 'Sensi Coco Bloom A',
                            npk: { n: 3, p: 0, k: 0 },
                            microElements: 'Ca, Mg, S, Fe, Mn, Zn, Cu, B, Mo',
                            density: 1.2
                        },
                        'sensi-bloom-b': {
                            id: 'sensi-bloom-b',
                            name: 'Sensi Coco Bloom B',
                            npk: { n: 1, p: 4, k: 7 },
                            microElements: 'Ca, Mg, S, Fe, Mn, Zn, Cu, B, Mo',
                            density: 1.2
                        },
                        'b52': {
                            id: 'b52',
                            name: 'B-52',
                            npk: { n: 2, p: 1, k: 4 },
                            microElements: '–í–∏—Ç–∞–º–∏–Ω—ã –≥—Ä—É–ø–ø—ã B, –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã',
                            density: 1.1
                        }
                    };

                    // Initialize default recipes
                    this.data.recipes = {
                        'veg-week-1': {
                            id: 'veg-week-1',
                            name: '–í–µ–≥–∞ 1 –Ω–µ–¥–µ–ª—è',
                            volume: 1,
                            fertilizers: [
                                { fertilizerId: 'sensi-grow-a', dose: 1 },
                                { fertilizerId: 'sensi-grow-b', dose: 1 },
                                { fertilizerId: 'b52', dose: 1 }
                            ]
                        },
                        'veg-week-2': {
                            id: 'veg-week-2',
                            name: '–í–µ–≥–∞ 2 –Ω–µ–¥–µ–ª—è',
                            volume: 1,
                            fertilizers: [
                                { fertilizerId: 'sensi-grow-a', dose: 2 },
                                { fertilizerId: 'sensi-grow-b', dose: 2 },
                                { fertilizerId: 'b52', dose: 2 }
                            ]
                        },
                        'veg-week-3': {
                            id: 'veg-week-3',
                            name: '–í–µ–≥–∞ 3 –Ω–µ–¥–µ–ª—è',
                            volume: 1,
                            fertilizers: [
                                { fertilizerId: 'sensi-grow-a', dose: 3 },
                                { fertilizerId: 'sensi-grow-b', dose: 3 },
                                { fertilizerId: 'b52', dose: 2 }
                            ]
                        },
                        'veg-week-4': {
                            id: 'veg-week-4',
                            name: '–í–µ–≥–∞ 4 –Ω–µ–¥–µ–ª—è',
                            volume: 1,
                            fertilizers: [
                                { fertilizerId: 'sensi-grow-a', dose: 4 },
                                { fertilizerId: 'sensi-grow-b', dose: 4 },
                                { fertilizerId: 'b52', dose: 2 }
                            ]
                        },
                        'bloom-week-1-2': {
                            id: 'bloom-week-1-2',
                            name: '–¶–≤–µ—Ç 1-2 –Ω–µ–¥–µ–ª—è',
                            volume: 1,
                            fertilizers: [
                                { fertilizerId: 'sensi-bloom-a', dose: 4 },
                                { fertilizerId: 'sensi-bloom-b', dose: 4 }
                            ]
                        },
                        'bloom-week-3-8': {
                            id: 'bloom-week-3-8',
                            name: '–¶–≤–µ—Ç 3-8 –Ω–µ–¥–µ–ª—è',
                            volume: 1,
                            fertilizers: [
                                { fertilizerId: 'sensi-bloom-a', dose: 4 },
                                { fertilizerId: 'sensi-bloom-b', dose: 4 },
                                { fertilizerId: 'b52', dose: 2 }
                            ]
                        }
                    };
                }
            }

            // Plant Management
            createPlant(plantData) {
                if (!plantData.name || !plantData.plantDate) {
                    throw new Error('–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
                }

                const id = 'plant-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const plant = {
                    id,
                    name: plantData.name,
                    strain: plantData.strain || '',
                    species: plantData.species || '',
                    substrate: plantData.substrate || '',
                    plantDate: plantData.plantDate,
                    lightOnTime: plantData.lightOnTime || '08:00',
                    image: plantData.image || null,
                    growthPhases: plantData.growthPhases || { 
                        useDates: false,
                        vegetation: 28, 
                        flowering: 63, 
                        drying: 10 
                    },
                    createdAt: new Date()
                };

                console.log('Creating plant:', plant);
                
                // Ensure plants object exists
                if (!this.data.plants) {
                    this.data.plants = {};
                }
                
                this.data.plants[id] = plant;
                console.log('Plant added to data, total plants:', Object.keys(this.data.plants).length);

                return id;
            }

            createPlantLightPhases(plantId, plantData) {
                console.log(`Creating light phases for plant ${plantId}`);
                const plant = this.data.plants[plantId];
                if (!plant || !plant.plantDate) {
                    console.log(`Skipping plant ${plantId} - missing plant or plantDate`);
                    return;
                }

                // Ensure lightPhases object exists
                if (!this.data.lightPhases) {
                    this.data.lightPhases = {};
                }

                const phases = plant.growthPhases || { useDates: false, vegetation: 28, flowering: 63, drying: 10 };
                console.log(`Plant: ${plant.name}, Start date: ${plant.plantDate}, Phases:`, phases);

                // Clear existing phases for this plant
                Object.keys(this.data.lightPhases).forEach(phaseId => {
                    if (this.data.lightPhases[phaseId].plantId === plantId) {
                        console.log(`Removing existing phase: ${phaseId}`);
                        delete this.data.lightPhases[phaseId];
                    }
                });

                if (phases.useDates && phases.vegStartDate && phases.vegEndDate) {
                    // Create phases using specific dates
                    console.log('Creating phases using specific dates');
                    
                    // Vegetation phase
                    if (phases.vegStartDate && phases.vegEndDate) {
                        const vegPhaseId = this.createLightPhase(plantId, {
                            type: 'vegetation',
                            startDate: phases.vegStartDate,
                            endDate: phases.vegEndDate,
                            lightOnTime: plant.lightOnTime || '08:00'
                        });
                        console.log(`Created vegetation phase: ${vegPhaseId} (${phases.vegStartDate} - ${phases.vegEndDate})`);
                    }

                    // Flowering phase
                    if (phases.flowerStartDate && phases.flowerEndDate) {
                        const flowerPhaseId = this.createLightPhase(plantId, {
                            type: 'flowering',
                            startDate: phases.flowerStartDate,
                            endDate: phases.flowerEndDate,
                            lightOnTime: plant.lightOnTime || '08:00'
                        });
                        console.log(`Created flowering phase: ${flowerPhaseId} (${phases.flowerStartDate} - ${phases.flowerEndDate})`);
                    }

                    // Drying phase
                    if (phases.dryStartDate && phases.dryEndDate) {
                        const dryPhaseId = this.createLightPhase(plantId, {
                            type: 'drying',
                            startDate: phases.dryStartDate,
                            endDate: phases.dryEndDate,
                            lightOnTime: plant.lightOnTime || '08:00'
                        });
                        console.log(`Created drying phase: ${dryPhaseId} (${phases.dryStartDate} - ${phases.dryEndDate})`);
                    }
                } else {
                    // Create phases using durations (default mode)
                    console.log('Creating phases using durations');
                    const startDate = new Date(plant.plantDate);
                    const vegDuration = phases.vegetation || 28;
                    const flowerDuration = phases.flowering || 63;
                    const dryDuration = phases.drying || 10;

                    // Create vegetation phase
                    const vegEndDate = new Date(startDate);
                    vegEndDate.setDate(startDate.getDate() + vegDuration - 1);
                    
                    const vegPhaseId = this.createLightPhase(plantId, {
                        type: 'vegetation',
                        startDate: plant.plantDate,
                        endDate: vegEndDate.toISOString().split('T')[0],
                        lightOnTime: plant.lightOnTime || '08:00'
                    });
                    console.log(`Created vegetation phase: ${vegPhaseId} (${plant.plantDate} - ${vegEndDate.toISOString().split('T')[0]})`);

                    // Create flowering phase
                    const flowerStartDate = new Date(vegEndDate);
                    flowerStartDate.setDate(vegEndDate.getDate() + 1);
                    const flowerEndDate = new Date(flowerStartDate);
                    flowerEndDate.setDate(flowerStartDate.getDate() + flowerDuration - 1);
                    
                    const flowerPhaseId = this.createLightPhase(plantId, {
                        type: 'flowering',
                        startDate: flowerStartDate.toISOString().split('T')[0],
                        endDate: flowerEndDate.toISOString().split('T')[0],
                        lightOnTime: plant.lightOnTime || '08:00'
                    });
                    console.log(`Created flowering phase: ${flowerPhaseId} (${flowerStartDate.toISOString().split('T')[0]} - ${flowerEndDate.toISOString().split('T')[0]})`);

                    // Create drying phase
                    const dryStartDate = new Date(flowerEndDate);
                    dryStartDate.setDate(flowerEndDate.getDate() + 1);
                    const dryEndDate = new Date(dryStartDate);
                    dryEndDate.setDate(dryStartDate.getDate() + dryDuration - 1);
                    
                    const dryPhaseId = this.createLightPhase(plantId, {
                        type: 'drying',
                        startDate: dryStartDate.toISOString().split('T')[0],
                        endDate: dryEndDate.toISOString().split('T')[0],
                        lightOnTime: plant.lightOnTime || '08:00'
                    });
                    console.log(`Created drying phase: ${dryPhaseId} (${dryStartDate.toISOString().split('T')[0]} - ${dryEndDate.toISOString().split('T')[0]})`);
                }

                console.log(`Finished creating phases for ${plant.name}. Total phases: ${Object.keys(this.data.lightPhases).length}`);
                
                // Force save and refresh UI
                this.saveData();
            }

            updatePlantLightPhases(plantId, plantData) {
                const plant = this.data.plants[plantId];
                if (!plant) return;

                // Update growth phases in plant data
                if (plantData.growthPhases) {
                    plant.growthPhases = plantData.growthPhases;
                }

                // Recreate light phases with new durations
                this.createPlantLightPhases(plantId, plantData);
            }

            updatePlant(id, updates) {
                if (this.data.plants[id]) {
                    this.data.plants[id] = { ...this.data.plants[id], ...updates };
                    this.saveData();
                }
            }

            deletePlant(id) {
                delete this.data.plants[id];
                // Clean up related data
                Object.keys(this.data.lightPhases).forEach(phaseId => {
                    if (this.data.lightPhases[phaseId].plantId === id) {
                        delete this.data.lightPhases[phaseId];
                    }
                });
                Object.keys(this.data.wateringRules).forEach(ruleId => {
                    if (this.data.wateringRules[ruleId].plantId === id) {
                        delete this.data.wateringRules[ruleId];
                    }
                });
                this.saveData();
            }

            // Light Phase Management
            createLightPhase(plantId, phaseData) {
                const id = 'phase-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const lightSchedules = {
                    'vegetation': { on: 18, off: 6 },
                    'flowering': { on: 12, off: 12 },
                    'drying': { on: 0, off: 24 },
                    'harvest': { on: 0, off: 24 }
                };

                const schedule = lightSchedules[phaseData.type] || lightSchedules['vegetation'];
                const lightOnTime = phaseData.lightOnTime || this.data.plants[plantId]?.lightOnTime || '08:00';
                const lightOffTime = this.calculateLightOffTime(lightOnTime, schedule.on);

                const phase = {
                    id,
                    plantId,
                    type: phaseData.type,
                    startDate: phaseData.startDate,
                    endDate: phaseData.endDate || null,
                    lightOnTime,
                    lightOffTime,
                    schedule
                };

                console.log(`Creating light phase:`, phase);
                this.data.lightPhases[id] = phase;
                
                return id;
            }

            calculateLightOffTime(lightOnTime, hoursOn) {
                const [hours, minutes] = lightOnTime.split(':').map(Number);
                const offTime = new Date();
                offTime.setHours(hours + hoursOn, minutes, 0, 0);
                if (offTime.getDate() !== new Date().setHours(hours, minutes, 0, 0)) {
                    offTime.setDate(offTime.getDate() + 1);
                }
                return offTime.toTimeString().slice(0, 5);
            }

            // Watering Status Management
            needsWatering(plantId) {
                const currentDate = new Date();
                const threeDaysAgo = new Date(currentDate.getTime() - 3 * 24 * 60 * 60 * 1000);
                
                // Find the last watering for this plant
                const plantWaterings = Object.values(this.data.wateringHistory)
                    .filter(watering => watering.plantIds.includes(plantId))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (plantWaterings.length === 0) {
                    // No waterings recorded - show warning if plant is older than 3 days
                    const plant = this.data.plants[plantId];
                    if (plant) {
                        const plantDate = new Date(plant.plantDate);
                        return currentDate - plantDate > 3 * 24 * 60 * 60 * 1000;
                    }
                    return false;
                }
                
                const lastWatering = new Date(plantWaterings[0].date);
                return lastWatering < threeDaysAgo;
            }

            getDaysSinceLastWatering(plantId) {
                const currentDate = new Date();
                const plantWaterings = Object.values(this.data.wateringHistory)
                    .filter(watering => watering.plantIds.includes(plantId))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (plantWaterings.length === 0) {
                    const plant = this.data.plants[plantId];
                    if (plant) {
                        const plantDate = new Date(plant.plantDate);
                        return Math.floor((currentDate - plantDate) / (1000 * 60 * 60 * 24));
                    }
                    return 0;
                }
                
                const lastWatering = new Date(plantWaterings[0].date);
                return Math.floor((currentDate - lastWatering) / (1000 * 60 * 60 * 24));
            }

            quickWaterPlant(plantId) {
                const plant = this.data.plants[plantId];
                if (!plant) {
                    alert('–†–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                
                // Open watering modal with this plant pre-selected
                this.showWateringModal();
                
                // Wait for modal to render, then select only this plant
                setTimeout(() => {
                    // Uncheck all plants first
                    document.querySelectorAll('input[name="selected-plants"]').forEach(checkbox => {
                        checkbox.checked = checkbox.value === plantId;
                    });
                    this.updateWateringCalculation();
                }, 100);
            }

            // Calendar and Day Calculations
            getDaysSincePlanting(plantId, date) {
                const plant = this.data.plants[plantId];
                if (!plant) return 0;
                const plantDate = new Date(plant.plantDate);
                const targetDate = new Date(date);
                const diffTime = targetDate - plantDate;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            }

            getCurrentLightPhase(plantId, date) {
                if (!this.data.lightPhases) {
                    console.log('No light phases data');
                    return null;
                }
                
                const phases = Object.values(this.data.lightPhases)
                    .filter(phase => phase.plantId === plantId)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                console.log(`Found ${phases.length} phases for plant ${plantId}`);
                phases.forEach(p => console.log(`  Phase: ${p.type}, ${p.startDate} - ${p.endDate}`));

                if (phases.length === 0) {
                    return null;
                }

                const targetDate = new Date(date);
                targetDate.setHours(0, 0, 0, 0);
                console.log(`Looking for phase on date: ${targetDate.toISOString().split('T')[0]}`);

                for (let phase of phases) {
                    const phaseStart = new Date(phase.startDate);
                    phaseStart.setHours(0, 0, 0, 0);
                    
                    const phaseEnd = phase.endDate ? new Date(phase.endDate) : new Date('2099-12-31');
                    phaseEnd.setHours(23, 59, 59, 999);
                    
                    console.log(`  Checking phase ${phase.type}: ${phaseStart.toISOString().split('T')[0]} - ${phaseEnd.toISOString().split('T')[0]}`);
                    
                    if (targetDate >= phaseStart && targetDate <= phaseEnd) {
                        console.log(`  Found matching phase: ${phase.type}`);
                        return phase;
                    }
                }
                console.log('  No matching phase found');
                return null;
            }

            // UI Management
            init() {
                this.loadData();
                this.initEventListeners();
                this.renderUI();
                
                // Setup auto backup if enabled
                setTimeout(() => {
                    if (this.data.settings.backup?.autoEnabled) {
                        this.setupAutoBackup();
                    }
                }, 2000); // Wait 2 seconds for app to fully load
            }

            initEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tabId = e.currentTarget.id.replace('tab-', '');
                        this.switchTab(tabId);
                    });
                });

                // Plant management
                document.getElementById('add-plant-btn').addEventListener('click', () => this.showPlantModal());
                document.getElementById('plant-form').addEventListener('submit', (e) => this.handlePlantForm(e));
                document.getElementById('plant-cancel-btn').addEventListener('click', () => this.hidePlantModal());

                // Fertilizer management
                document.getElementById('add-fertilizer-btn').addEventListener('click', () => this.showFertilizerModal());
                document.getElementById('fertilizer-form').addEventListener('submit', (e) => this.handleFertilizerForm(e));
                document.getElementById('fertilizer-cancel-btn').addEventListener('click', () => this.hideFertilizerModal());

                // Recipe management
                document.getElementById('add-recipe-btn').addEventListener('click', () => this.showRecipeModal());
                document.getElementById('recipe-form').addEventListener('submit', (e) => this.handleRecipeForm(e));
                document.getElementById('recipe-cancel-btn').addEventListener('click', () => this.hideRecipeModal());

                // Watering management
                document.getElementById('watering-form').addEventListener('submit', (e) => this.handleWateringForm(e));
                document.getElementById('watering-cancel-btn').addEventListener('click', () => this.hideWateringModal());
                document.getElementById('auto-recipe-btn').addEventListener('click', () => this.autoSelectRecipe());

                // Calendar navigation
                document.getElementById('prev-month-btn').addEventListener('click', () => this.previousMonth());
                document.getElementById('next-month-btn').addEventListener('click', () => this.nextMonth());
                document.getElementById('today-btn').addEventListener('click', () => this.goToToday());

                // Quick actions
                document.getElementById('quick-water-btn').addEventListener('click', () => this.quickWater());
                
                // Settings management
                document.getElementById('settings-btn').addEventListener('click', () => this.showSettingsModal());
                document.getElementById('settings-form').addEventListener('submit', (e) => this.handleSettingsForm(e));
                document.getElementById('settings-cancel-btn').addEventListener('click', () => this.hideSettingsModal());
                document.getElementById('settings-ha-enabled').addEventListener('change', (e) => this.toggleHomeAssistantSettings(e.target.checked));
                document.getElementById('test-ha-connection').addEventListener('click', () => this.testHomeAssistantConnection());
                document.getElementById('sync-ha-entities').addEventListener('click', () => this.syncHomeAssistantEntities());

                // Telegram integration
                document.getElementById('settings-telegram-enabled').addEventListener('change', (e) => this.toggleTelegramSettings(e.target.checked));
                document.getElementById('settings-telegram-daily-summary').addEventListener('change', (e) => this.toggleDailySummaryTime(e.target.checked));
                document.getElementById('settings-telegram-auto-backup').addEventListener('change', (e) => this.toggleAutoBackupTime(e.target.checked));
                document.getElementById('test-telegram-connection').addEventListener('click', () => this.testTelegramConnection());
                document.getElementById('get-telegram-chat-id').addEventListener('click', () => this.getTelegramChatId());
                document.getElementById('send-plant-status').addEventListener('click', () => this.sendPlantStatusToTelegram());
                document.getElementById('send-backup-telegram').addEventListener('click', () => this.sendBackupToTelegram());

                document.getElementById('export-data-btn').addEventListener('click', () => this.exportData());
                document.getElementById('backup-to-folder-btn').addEventListener('click', () => this.backupToFolder());
                document.getElementById('import-data-btn').addEventListener('click', () => this.importData());
                document.getElementById('restore-from-folder-btn').addEventListener('click', () => this.restoreFromFolder());
                document.getElementById('data-import-input').addEventListener('change', (e) => this.handleDataImport(e));
                document.getElementById('settings-auto-backup').addEventListener('change', (e) => this.toggleAutoBackupSettings(e.target.checked));
                document.getElementById('select-backup-folder').addEventListener('click', () => this.selectBackupFolder());

                // Mobile menu management
                document.getElementById('mobile-menu-btn').addEventListener('click', () => this.toggleMobileMenu());
                document.getElementById('mobile-overlay').addEventListener('click', () => this.hideMobileMenu());
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-darker');
                    btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                });
                
                const tabButton = document.getElementById(`tab-${tabName}`);
                if (tabButton) {
                    tabButton.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    tabButton.classList.add('bg-primary', 'text-darker');
                }

                // Update content areas
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                const contentArea = document.getElementById(`content-${tabName}`);
                if (contentArea) {
                    contentArea.classList.remove('hidden');
                }

                this.data.settings.currentView = tabName;
                this.saveData();

                // Render specific content
                switch (tabName) {
                    case 'dashboard':
                        this.renderDashboard();
                        this.renderPlantCalendars();
                        break;
                    case 'fertilizers':
                        this.renderFertilizers();
                        break;
                    case 'recipes':
                        this.renderRecipes();
                        break;
                    case 'history':
                        this.renderWateringHistory();
                        break;
                }
            }

            renderUI() {
                this.updateAppTitle();
                this.renderPlantsList();
                this.switchTab(this.data.settings.currentView);
            }

            updateAppTitle() {
                const titleElement = document.querySelector('header h1');
                if (titleElement && this.data.settings.appTitle) {
                    titleElement.textContent = this.data.settings.appTitle;
                }
                
                // Update page title
                document.title = this.data.settings.appTitle || 'Plant Care Pro';
            }

            // Mobile menu management
            toggleMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                
                if (sidebar.classList.contains('-translate-x-full')) {
                    this.showMobileMenu();
                } else {
                    this.hideMobileMenu();
                }
            }

            showMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            }

            hideMobileMenu() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }

            // Image URL loading methods
            switchPlantUploadMode(mode) {
                const fileBtn = document.getElementById('plant-upload-file-btn');
                const urlBtn = document.getElementById('plant-upload-url-btn');
                const fileUpload = document.getElementById('plant-file-upload');
                const urlUpload = document.getElementById('plant-url-upload');

                if (mode === 'file') {
                    fileBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    urlBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    fileUpload.classList.remove('hidden');
                    urlUpload.classList.add('hidden');
                } else {
                    fileBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    urlBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    fileUpload.classList.add('hidden');
                    urlUpload.classList.remove('hidden');
                }
            }

            switchFertilizerUploadMode(mode) {
                const fileBtn = document.getElementById('fertilizer-upload-file-btn');
                const urlBtn = document.getElementById('fertilizer-upload-url-btn');
                const fileUpload = document.getElementById('fertilizer-file-upload');
                const urlUpload = document.getElementById('fertilizer-url-upload');

                if (mode === 'file') {
                    fileBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    urlBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    fileUpload.classList.remove('hidden');
                    urlUpload.classList.add('hidden');
                } else {
                    fileBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    urlBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    fileUpload.classList.add('hidden');
                    urlUpload.classList.remove('hidden');
                }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            isImageUrl(url) {
                try {
                    const urlObj = new URL(url);
                    const pathname = urlObj.pathname.toLowerCase();
                    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
                    const hasImageExtension = imageExtensions.some(ext => pathname.endsWith(ext));
                    
                    // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤ URL, –Ω–æ —ç—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const imageHosts = ['i.imgur.com', 'cdn.discordapp.com', 'images.unsplash.com', 
                                      'i.postimg.cc', 'ibb.co', 'pasteboard.co'];
                    const isImageHost = imageHosts.some(host => urlObj.hostname.includes(host));
                    
                    return hasImageExtension || isImageHost;
                } catch {
                    return false;
                }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ URL
            normalizeImageUrl(url) {
                try {
                    let normalizedUrl = url.trim();
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
                    if (normalizedUrl.includes('drive.google.com')) {
                        // Google Drive: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
                        const fileIdMatch = normalizedUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
                        if (fileIdMatch) {
                            normalizedUrl = `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;
                        }
                    } else if (normalizedUrl.includes('dropbox.com')) {
                        // Dropbox: –∑–∞–º–µ–Ω—è–µ–º dl=0 –Ω–∞ dl=1
                        normalizedUrl = normalizedUrl.replace(/[?&]dl=0/, '?dl=1');
                        if (!normalizedUrl.includes('dl=1')) {
                            normalizedUrl += normalizedUrl.includes('?') ? '&dl=1' : '?dl=1';
                        }
                    }
                    
                    return normalizedUrl;
                } catch {
                    return url;
                }
            }

            async loadPlantImageFromUrl() {
                const imageUrlInput = document.getElementById('plant-image-url');
                const previewContainer = document.getElementById('plant-image-preview');
                const previewImg = document.getElementById('plant-preview-img');
                const loadBtn = document.getElementById('load-plant-image-url');
                
                const originalUrl = imageUrlInput.value.trim();
                if (!originalUrl) {
                    alert('–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    return;
                }

                // Normalize and validate URL
                const url = this.normalizeImageUrl(originalUrl);
                
                try {
                    new URL(url);
                } catch {
                    alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏.');
                    return;
                }

                // Check if URL looks like an image
                if (!this.isImageUrl(url)) {
                    const confirmMessage = 'URL –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n' +
                        '–î–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞:\n' +
                        '.jpg, .png, .webp, .gif\n\n' +
                        '–í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å?';
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                }

                // Show loading state
                loadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                loadBtn.disabled = true;

                try {
                    // Try to load image without CORS first (most permissive)
                    const testImg = new Image();
                    
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Timeout: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∑–∞ 10 —Å–µ–∫—É–Ω–¥'));
                        }, 10000);
                        
                        testImg.onload = () => {
                            clearTimeout(timeout);
                            resolve();
                        };
                        
                        testImg.onerror = () => {
                            clearTimeout(timeout);
                            reject(new Error('–ù–µ —É–¥–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                        };
                        
                        testImg.src = url;
                    });

                    // If successful, show preview
                    previewImg.src = url;
                    previewContainer.classList.remove('hidden');
                    
                    // Clear file input when URL is loaded
                    document.getElementById('plant-image').value = '';
                    
                    this.showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
                    
                } catch (error) {
                    console.log('Image load error:', error);
                    
                    let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ.\n\n';
                    
                    if (error.message.includes('Timeout')) {
                        errorMessage += '‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏.\n';
                    } else {
                        errorMessage += '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n';
                    }
                    
                    errorMessage += '\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n';
                    errorMessage += '‚Ä¢ URL –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n';
                    errorMessage += '‚Ä¢ –°–µ—Ä–≤–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É (CORS)\n';
                    errorMessage += '‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–æ\n';
                    errorMessage += '‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n\n';
                    errorMessage += 'üîß –†–µ—à–µ–Ω–∏—è:\n';
                    errorMessage += '‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ (.jpg, .png, .webp)\n';
                    errorMessage += '‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ö–æ—Å—Ç–∏–Ω–≥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n';
                    errorMessage += '‚Ä¢ –°–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–§–∞–π–ª"';
                    
                    alert(errorMessage);
                } finally {
                    // Restore button state
                    loadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ';
                    loadBtn.disabled = false;
                }
            }

            async loadFertilizerImageFromUrl() {
                const imageUrlInput = document.getElementById('fertilizer-image-url');
                const previewContainer = document.getElementById('fertilizer-image-preview');
                const previewImg = document.getElementById('fertilizer-preview-img');
                const loadBtn = document.getElementById('load-fertilizer-image-url');
                
                const originalUrl = imageUrlInput.value.trim();
                if (!originalUrl) {
                    alert('–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    return;
                }

                // Normalize and validate URL
                const url = this.normalizeImageUrl(originalUrl);
                
                try {
                    new URL(url);
                } catch {
                    alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏.');
                    return;
                }

                // Check if URL looks like an image
                if (!this.isImageUrl(url)) {
                    const confirmMessage = 'URL –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n' +
                        '–î–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞:\n' +
                        '.jpg, .png, .webp, .gif\n\n' +
                        '–í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å?';
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                }

                // Show loading state
                loadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                loadBtn.disabled = true;

                try {
                    // Try to load image without CORS first (most permissive)
                    const testImg = new Image();
                    
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Timeout: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∑–∞ 10 —Å–µ–∫—É–Ω–¥'));
                        }, 10000);
                        
                        testImg.onload = () => {
                            clearTimeout(timeout);
                            resolve();
                        };
                        
                        testImg.onerror = () => {
                            clearTimeout(timeout);
                            reject(new Error('–ù–µ —É–¥–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                        };
                        
                        testImg.src = url;
                    });

                    // If successful, show preview
                    previewImg.src = url;
                    previewContainer.classList.remove('hidden');
                    
                    // Clear file input when URL is loaded
                    document.getElementById('fertilizer-image').value = '';
                    
                    this.showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
                    
                } catch (error) {
                    console.log('Image load error:', error);
                    
                    let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ.\n\n';
                    
                    if (error.message.includes('Timeout')) {
                        errorMessage += '‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏.\n';
                    } else {
                        errorMessage += '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n';
                    }
                    
                    errorMessage += '\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n';
                    errorMessage += '‚Ä¢ URL –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n';
                    errorMessage += '‚Ä¢ –°–µ—Ä–≤–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É (CORS)\n';
                    errorMessage += '‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–æ\n';
                    errorMessage += '‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n\n';
                    errorMessage += 'üîß –†–µ—à–µ–Ω–∏—è:\n';
                    errorMessage += '‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ (.jpg, .png, .webp)\n';
                    errorMessage += '‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ö–æ—Å—Ç–∏–Ω–≥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n';
                    errorMessage += '‚Ä¢ –°–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–§–∞–π–ª"';
                    
                    alert(errorMessage);
                } finally {
                    // Restore button state
                    loadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ';
                    loadBtn.disabled = false;
                }
            }

            renderPhaseProgress(plantId, currentPhase) {
                if (!currentPhase) {
                    return `
                        <div class="mt-4 pt-3 border-t border-gray-600">
                            <div class="text-center text-gray-400 text-sm">
                                <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>–§–∞–∑–∞ —Ä–æ—Å—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞</div>
                            </div>
                        </div>
                    `;
                }

                const currentDate = new Date();
                const phaseStartDate = new Date(currentPhase.startDate);
                const phaseEndDate = currentPhase.endDate ? new Date(currentPhase.endDate) : null;
                
                if (!phaseEndDate) {
                    return `
                        <div class="mt-4 pt-3 border-t border-gray-600">
                            <div class="text-center text-gray-400 text-sm">
                                <div>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ñ–∞–∑—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</div>
                            </div>
                        </div>
                    `;
                }

                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const totalPhaseDays = Math.ceil((phaseEndDate - phaseStartDate) / (1000 * 60 * 60 * 24)) + 1;
                const daysSincePhaseStart = Math.ceil((currentDate - phaseStartDate) / (1000 * 60 * 60 * 24));
                const daysUntilPhaseEnd = Math.ceil((phaseEndDate - currentDate) / (1000 * 60 * 60 * 24));
                const progressPercent = Math.min(100, Math.max(0, (daysSincePhaseStart / totalPhaseDays) * 100));

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –∏ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–∑
                const phaseInfo = {
                    'vegetation': {
                        color: 'green',
                        bgColor: 'bg-green-600/20',
                        borderColor: 'border-green-400',
                        textColor: 'text-green-400',
                        icon: 'üå±',
                        name: '–í–µ–≥–µ—Ç–∞—Ü–∏—è'
                    },
                    'flowering': {
                        color: 'purple', 
                        bgColor: 'bg-purple-600/20',
                        borderColor: 'border-purple-400',
                        textColor: 'text-purple-400',
                        icon: 'üå∏',
                        name: '–¶–≤–µ—Ç–µ–Ω–∏–µ'
                    },
                    'drying': {
                        color: 'orange',
                        bgColor: 'bg-orange-600/20', 
                        borderColor: 'border-orange-400',
                        textColor: 'text-orange-400',
                        icon: 'üçÇ',
                        name: '–°—É—à–∫–∞'
                    }
                };

                const info = phaseInfo[currentPhase.type] || phaseInfo['vegetation'];
                const isPhaseEnding = daysUntilPhaseEnd <= 3;
                const hasPhaseEnded = daysUntilPhaseEnd < 0;

                // Check watering status
                const needsWatering = this.needsWatering(plantId);
                const daysSinceWatering = this.getDaysSinceLastWatering(plantId);

                return `
                    <div class="mt-4 pt-3 border-t border-gray-600">
                        <h4 class="text-xs font-medium text-gray-400 mb-3 flex items-center justify-between">
                            <span>–¢–ï–ö–£–©–ê–Ø –§–ê–ó–ê</span>
                            <span class="text-xs ${info.textColor}">${info.icon} ${info.name}</span>
                        </h4>
                        
                        <!-- Watering Alert -->
                        ${needsWatering ? `
                        <div class="mb-4 p-3 bg-red-600/20 border border-red-400/50 rounded-lg">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-5 h-5 text-red-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <span class="text-red-400 font-medium text-sm">–¢–†–ï–ë–£–ï–¢–°–Ø –ü–û–õ–ò–í!</span>
                            </div>
                            <div class="text-red-300 text-xs">
                                üíß –ü—Ä–æ—à–ª–æ ${daysSinceWatering} –¥–Ω. —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª–∏–≤–∞
                            </div>
                            <button onclick="app.quickWaterPlant('${plantId}')" class="mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg transition-colors">
                                –ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å
                            </button>
                        </div>
                        ` : daysSinceWatering <= 1 ? `
                        <div class="mb-4 p-3 bg-green-600/20 border border-green-400/50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-green-400 text-xs font-medium">–ù–µ–¥–∞–≤–Ω–æ –ø–æ–ª–∏—Ç–æ (${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥)</span>
                            </div>
                        </div>
                        ` : `
                        <div class="mb-4 p-3 bg-gray-700/50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                <span class="text-gray-300 text-xs">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥</span>
                            </div>
                        </div>
                        `}
                        
                        <div class="${info.bgColor} p-3 rounded-lg border-l-4 ${info.borderColor}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-sm font-medium ${info.textColor}">
                                    –î–µ–Ω—å ${daysSincePhaseStart} –∏–∑ ${totalPhaseDays}
                                </div>
                                <div class="text-xs text-gray-300">
                                    ${progressPercent.toFixed(0)}%
                                </div>
                            </div>
                            
                            <!-- Progress bar -->
                            <div class="w-full bg-gray-700 rounded-full h-2 mb-3">
                                <div class="bg-${info.color}-400 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                            
                            <div class="flex justify-between items-center text-xs">
                                <div class="text-gray-300">
                                    –ù–∞—á–∞–ª–æ: ${phaseStartDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' })}
                                </div>
                                <div class="text-gray-300">
                                    –ö–æ–Ω–µ—Ü: ${phaseEndDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' })}
                                </div>
                            </div>
                            
                            <!-- Days remaining -->
                            <div class="mt-3 text-center">
                                ${hasPhaseEnded ? `
                                    <div class="text-red-400 text-sm font-medium">
                                        ‚ö†Ô∏è –§–∞–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ${Math.abs(daysUntilPhaseEnd)} –¥–Ω–µ–π –Ω–∞–∑–∞–¥
                                    </div>
                                ` : daysUntilPhaseEnd === 0 ? `
                                    <div class="text-yellow-400 text-sm font-medium animate-pulse">
                                        üéØ –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —Ñ–∞–∑—ã!
                                    </div>
                                ` : isPhaseEnding ? `
                                    <div class="text-yellow-400 text-sm font-medium">
                                        ‚è∞ –û—Å—Ç–∞–ª–æ—Å—å ${daysUntilPhaseEnd} –¥–Ω. –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                                    </div>
                                ` : `
                                    <div class="text-gray-300 text-sm">
                                        üìÖ –û—Å—Ç–∞–ª–æ—Å—å <span class="${info.textColor} font-medium">${daysUntilPhaseEnd} –¥–Ω–µ–π</span>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            isPlantActive(plant) {
                const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                if (!currentPhase) return false;
                
                // –†–∞—Å—Ç–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –≤ —Ñ–∞–∑–µ —Å—É—à–∫–∏ –∏–ª–∏ —Ö–∞—Ä–≤–µ—Å—Ç–∞
                return currentPhase.type === 'vegetation' || currentPhase.type === 'flowering';
            }

            renderPlantsList() {
                const container = document.getElementById('plants-list');
                const plants = Object.values(this.data.plants);
                
                container.innerHTML = '';
                
                plants.forEach(plant => {
                    const daysSince = this.getDaysSincePlanting(plant.id, new Date());
                    const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                    const phaseText = currentPhase ? this.getPhaseDisplayName(currentPhase.type) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    const plantCard = document.createElement('div');
                    const isSelected = plant.id === this.data.settings.selectedPlant;
                    const isActive = this.isPlantActive(plant);
                    // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞ –µ—Å–ª–∏: 1) –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –ò —ç—Ç–æ –Ω–µ –æ–Ω–æ, –ò–õ–ò 2) —Ä–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ –ò –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è
                    const isCollapsed = (this.data.settings.selectedPlant && !isSelected) || (!isActive && !this.data.settings.selectedPlant);
                    
                    plantCard.className = `bg-gray-800 rounded-lg relative overflow-hidden cursor-pointer hover:bg-gray-750 transition-all duration-300 ${isSelected ? 'ring-2 ring-primary bg-primary/10 p-4' : isCollapsed ? 'p-2 opacity-75 hover:opacity-100' : 'p-4'}`;
                    plantCard.onclick = () => this.selectPlantFromCard(plant.id);
                    plantCard.setAttribute('data-plant-id', plant.id);
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const backgroundImage = plant.image || '1nsfSKxFu5LKDqP7zoRtP';
                    const backgroundOpacity = plant.image ? 'opacity-40' : 'opacity-30';
                    
                    if (isCollapsed) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª–∏–≤–∞ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                        const needsWatering = this.needsWatering(plant.id);
                        const daysSinceWatering = this.getDaysSinceLastWatering(plant.id);
                        
                        // –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                        plantCard.innerHTML = `
                            <div class="absolute inset-0 bg-cover bg-center ${backgroundOpacity}" style="background-image: url('${backgroundImage}');"></div>
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="flex items-center gap-3 min-w-0 flex-1">
                                    <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-medium flex-shrink-0 relative">
                                        ${this.getPhaseIcon(currentPhase?.type || 'unknown')}
                                        ${needsWatering ? `
                                        <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-600 rounded-full flex items-center justify-center animate-pulse" title="–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–∏–≤ (${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥)">
                                            <svg class="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                        </div>
                                        ` : ''}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <h3 class="font-medium text-sm truncate ${needsWatering ? 'text-red-300' : ''}">${plant.name}</h3>
                                        <div class="text-xs text-gray-400 truncate">
                                            –î–µ–Ω—å ${daysSince} ‚Ä¢ ${this.getPhaseShortName(currentPhase?.type || 'unknown')}
                                            ${needsWatering ? ` ‚Ä¢ ‚ö†Ô∏è ${daysSinceWatering}–¥ –±–µ–∑ –ø–æ–ª–∏–≤–∞` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 ml-2">
                                    ${needsWatering ? `
                                    <button onclick="app.quickWaterPlant('${plant.id}'); event.stopPropagation();" 
                                            class="p-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors" 
                                            title="–ü–æ–ª–∏—Ç—å —Å–µ–π—á–∞—Å">
                                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                        </svg>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        // –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                        plantCard.innerHTML = `
                            <div class="absolute inset-0 bg-cover bg-center ${backgroundOpacity}" style="background-image: url('${backgroundImage}');"></div>
                            <div class="relative z-10">
                                <h3 class="font-semibold text-lg mb-2">${plant.name}</h3>
                                <div class="flex flex-col gap-1 text-sm">
                                    <div class="flex items-center gap-2 text-gray-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span>–î–µ–Ω—å ${daysSince}</span>
                                    </div>
                                    ${plant.strain ? `
                                    <div class="flex items-center gap-2 text-gray-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                        <span>${plant.strain}</span>
                                    </div>
                                    ` : ''}
                                    ${plant.species ? `
                                    <div class="flex items-center gap-2 text-gray-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                        </svg>
                                        <span>${this.getSpeciesDisplayName(plant.species)}</span>
                                    </div>
                                    ` : ''}
                                    ${plant.substrate ? `
                                    <div class="flex items-center gap-2 text-gray-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"></path>
                                        </svg>
                                        <span>${this.getSubstrateDisplayName(plant.substrate)}</span>
                                    </div>
                                    ` : ''}
                                    <div class="flex items-center gap-2 text-gray-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                        <span>${phaseText}</span>
                                    </div>
                                </div>
                                

                                <!-- Current Phase Progress -->
                                ${this.renderPhaseProgress(plant.id, currentPhase)}

                                <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-600">
                                    <span class="text-xs font-medium px-2 py-1 rounded ${
                                        isSelected ? 'text-primary bg-primary/20' : 
                                        isActive ? 'text-green-400 bg-green-400/20' : 
                                        'text-gray-400 bg-gray-600/20'
                                    }">
                                        ${isSelected ? '‚úì –í–´–ë–†–ê–ù–û' : isActive ? 'üü¢ –ê–ö–¢–ò–í–ù–û' : 'üî¥ –ù–ï–ê–ö–¢–ò–í–ù–û'}
                                    </span>
                                    <div class="flex gap-2">
                                        <button onclick="app.editPlant('${plant.id}')" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="app.deletePlantConfirm('${plant.id}')" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    container.appendChild(plantCard);
                });
            }



            selectPlantFromCard(plantId) {
                // –í—ã–±–∏—Ä–∞–µ–º —Ä–∞—Å—Ç–µ–Ω–∏–µ
                this.data.settings.selectedPlant = plantId;
                this.saveData();
                
                // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ç–µ–Ω–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
                this.renderPlantsList();
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥–∞—à–±–æ—Ä–¥ –µ—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ –Ω–µ–º
                if (this.data.settings.currentView !== 'dashboard') {
                    this.switchTab('dashboard');
                } else {
                    // –ï—Å–ª–∏ —É–∂–µ –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    this.renderPlantCalendars();
                }
            }

            highlightSelectedPlantCard(selectedPlantId) {
                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
                document.querySelectorAll('#plants-list > div').forEach(card => {
                    card.classList.remove('ring-2', 'ring-primary', 'bg-primary/10');
                    card.classList.add('bg-gray-800');
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
                const selectedCard = document.querySelector(`[data-plant-id="${selectedPlantId}"]`);
                if (selectedCard) {
                    selectedCard.classList.remove('bg-gray-800');
                    selectedCard.classList.add('ring-2', 'ring-primary', 'bg-primary/10');
                }
            }

            renderPlantFilter() {
                // Plant filter removed from dashboard as each plant now has its own calendar
                // This method is kept for compatibility
            }

            getPhaseDisplayName(type) {
                const names = {
                    'vegetation': '–í–µ–≥–µ—Ç–∞—Ü–∏—è (18/6)',
                    'flowering': '–¶–≤–µ—Ç–µ–Ω–∏–µ (12/12)',
                    'drying': '–°—É—à–∫–∞ (0/24)',
                    'harvest': '–•–∞—Ä–≤–µ—Å—Ç'
                };
                return names[type] || type;
            }

            // Plant calendars rendering
            renderPlantCalendars() {
                const container = document.getElementById('plant-calendars-container');
                const noPlants = document.getElementById('no-plants-message');
                const plants = Object.values(this.data.plants);
                
                // Update month display
                const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                    '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                document.getElementById('current-month').textContent = `${monthNames[this.currentMonth.getMonth()]} ${this.currentMonth.getFullYear()}`;
                
                if (plants.length === 0) {
                    container.classList.add('hidden');
                    noPlants.classList.remove('hidden');
                    return;
                }
                
                // Get selected plant
                const selectedPlantId = this.data.settings.selectedPlant;
                const selectedPlant = selectedPlantId ? this.data.plants[selectedPlantId] : null;
                
                if (!selectedPlant) {
                    // Show message to select a plant
                    container.classList.remove('hidden');
                    noPlants.classList.add('hidden');
                    container.innerHTML = `
                        <div class="text-center py-16 text-gray-400">
                            <svg class="w-20 h-20 mx-auto mb-6 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</h3>
                            <p class="text-gray-500 mb-6">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</p>
                        </div>
                    `;
                    return;
                }
                
                container.classList.remove('hidden');
                noPlants.classList.add('hidden');
                container.innerHTML = '';
                
                // Render calendar for selected plant only
                const currentPhase = this.getCurrentLightPhase(selectedPlant.id, new Date());
                const daysSince = this.getDaysSincePlanting(selectedPlant.id, new Date());
                
                const plantCalendarCard = document.createElement('div');
                plantCalendarCard.className = 'bg-dark rounded-lg overflow-hidden max-w-4xl mx-auto';
                    
                // Plant header with background image
                const backgroundImage = selectedPlant.image || '1nsfSKxFu5LKDqP7zoRtP';
                const backgroundOpacity = selectedPlant.image ? 'opacity-40' : 'opacity-30';
                
                plantCalendarCard.innerHTML = `
                    <!-- Plant Header -->
                    <div class="relative p-6 bg-cover bg-center" style="background-image: url('${backgroundImage}');">
                        <div class="absolute inset-0 bg-black ${backgroundOpacity}"></div>
                        <div class="relative z-10">
                            <!-- –ü—É—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–æ–ª—å–∫–æ —Å —Ñ–æ–Ω–æ–º -->
                        </div>
                    </div>

                    <!-- Calendar for this plant -->
                    <div class="p-4">
                        <!-- Calendar Legend for this plant -->
                        <div class="flex flex-wrap items-center gap-3 mb-4 p-3 bg-gray-800 rounded-lg text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-600 rounded"></div>
                                <span>üå± –í–µ–≥–µ—Ç–∞—Ü–∏—è</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-purple-600 rounded"></div>
                                <span>üå∏ –¶–≤–µ—Ç–µ–Ω–∏–µ</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-orange-600 rounded"></div>
                                <span>üçÇ –°—É—à–∫–∞</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-blue-400">üíß</span>
                                <span>–ü–æ–ª–∏–≤</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-orange-400">üîÑ</span>
                                <span>–ü–µ—Ä–µ—Ö–æ–¥ —Ñ–∞–∑—ã</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-400">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>–ù–∞–≤–µ–¥–∏—Ç–µ –¥–ª—è NPK –∏ –¥–µ—Ç–∞–ª–µ–π</span>
                            </div>
                        </div>

                        <!-- Calendar Grid -->
                        <div class="bg-gray-800 rounded-lg overflow-hidden">
                            <!-- Calendar Header -->
                            <div class="grid grid-cols-7 bg-gray-700">
                                <div class="p-2 text-center font-medium text-gray-300 text-xs">–ü–Ω</div>
                                <div class="p-2 text-center font-medium text-gray-300 text-xs">–í—Ç</div>
                                <div class="p-2 text-center font-medium text-gray-300 text-xs">–°—Ä</div>
                                <div class="p-2 text-center font-medium text-gray-300 text-xs">–ß—Ç</div>
                                <div class="p-2 text-center font-medium text-gray-300 text-xs">–ü—Ç</div>
                                <div class="p-2 text-center font-medium text-gray-300 text-xs">–°–±</div>
                                <div class="p-2 text-center font-medium text-gray-300 text-xs">–í—Å</div>
                            </div>

                            <!-- Calendar Body -->
                            <div class="grid grid-cols-7" id="calendar-grid-${selectedPlant.id}">
                                <!-- Days will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(plantCalendarCard);
                
                // Render calendar for the selected plant
                this.renderPlantCalendar(selectedPlant);
            }

            renderPlantCalendar(plant) {
                const calendarGrid = document.getElementById(`calendar-grid-${plant.id}`);
                if (!calendarGrid) return;
                
                // Clear calendar
                calendarGrid.innerHTML = '';
                
                // Calculate calendar dates
                const firstDay = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), 1);
                const startDate = new Date(firstDay);
                const dayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Make Monday = 0
                startDate.setDate(startDate.getDate() - dayOfWeek);
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Generate 42 days (6 weeks)
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    
                    const dateStr = this.getLocalDateString(currentDate);
                    const isCurrentMonth = currentDate.getMonth() === this.currentMonth.getMonth();
                    const isToday = currentDate.getTime() === today.getTime();
                    const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = `min-h-16 p-1 border-b border-r border-gray-600 ${
                        isCurrentMonth ? 'bg-gray-800' : 'bg-gray-900 opacity-50'
                    } ${isToday ? 'ring-2 ring-primary' : ''} ${isWeekend ? 'bg-gray-850' : ''} hover:bg-gray-750 transition-colors relative cursor-pointer`;
                    
                    // Day number
                    const dayNumber = document.createElement('div');
                    dayNumber.className = `text-xs font-medium mb-1 ${isToday ? 'text-primary' : isWeekend ? 'text-blue-300' : 'text-white'}`;
                    dayNumber.textContent = currentDate.getDate();
                    dayElement.appendChild(dayNumber);
                    
                    // Collect day information for this specific plant
                    const dayInfo = this.collectPlantDayInfo(dateStr, currentDate, plant);
                    
                    // Add icons based on day information
                    this.renderPlantDayIcons(dayElement, dayInfo, plant);
                    
                    // Add tooltip for this plant
                    if (dayInfo.hasInfo) {
                        this.addPlantDayTooltip(dayElement, dayInfo, currentDate, plant);
                    }
                    
                    calendarGrid.appendChild(dayElement);
                }
            }

            // Legacy method for compatibility
            renderCalendar() {
                this.renderPlantCalendars();
            }

            // Helper function to get date string in local timezone
            getLocalDateString(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            collectPlantDayInfo(dateStr, date, plant) {
                const info = {
                    hasInfo: false,
                    phase: null,
                    daysSincePlanting: 0,
                    daysSincePhaseStart: 0,
                    weekInPhase: 0,
                    waterings: [],
                    milestones: [],
                    phaseTransitions: []
                };
                
                if (!plant) return info;
                
                const phase = this.getCurrentLightPhase(plant.id, date);
                const daysSincePlanting = this.getDaysSincePlanting(plant.id, date);
                
                if (phase && daysSincePlanting > 0) {
                    const phaseStartDate = new Date(phase.startDate);
                    const currentDate = new Date(date);
                    const daysSincePhaseStart = Math.floor((currentDate - phaseStartDate) / (1000 * 60 * 60 * 24)) + 1;
                    const weekInPhase = Math.ceil(daysSincePhaseStart / 7);
                    
                    info.phase = phase;
                    info.daysSincePlanting = daysSincePlanting;
                    info.daysSincePhaseStart = daysSincePhaseStart;
                    info.weekInPhase = weekInPhase;
                    info.hasInfo = true;
                }
                
                // Check for milestones
                if (daysSincePlanting === 1) {
                    info.milestones.push({ type: 'planted', plant: plant });
                    info.hasInfo = true;
                } else if (daysSincePlanting === 14) {
                    info.milestones.push({ type: '2weeks', plant: plant });
                    info.hasInfo = true;
                } else if (daysSincePlanting === 28) {
                    info.milestones.push({ type: '1month', plant: plant });
                    info.hasInfo = true;
                }
                
                // Check for phase transitions
                if (this.isPhaseTransition(date, plant)) {
                    const nextPhase = this.getPhaseTransitionInfo(date, plant);
                    if (nextPhase) {
                        info.phaseTransitions.push({ plant: plant, phase: nextPhase });
                        info.hasInfo = true;
                    }
                }
                
                // Collect watering information for this specific plant
                const dayWaterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = this.getLocalDateString(new Date(watering.date));
                    return wateringDate === dateStr && watering.plantIds.includes(plant.id);
                });
                
                if (dayWaterings.length > 0) {
                    info.waterings = dayWaterings;
                    info.hasInfo = true;
                }
                
                return info;
            }

            collectDayInfo(dateStr, date) {
                const selectedPlantId = this.data.settings.selectedPlant;
                const plantsToShow = selectedPlantId && this.data.plants[selectedPlantId] 
                    ? [this.data.plants[selectedPlantId]] 
                    : Object.values(this.data.plants);
                
                const info = {
                    hasInfo: false,
                    plants: [],
                    waterings: [],
                    milestones: [],
                    phaseTransitions: []
                };
                
                // Collect plant phase information
                plantsToShow.forEach(plant => {
                    if (!plant) return;
                    
                    const phase = this.getCurrentLightPhase(plant.id, date);
                    const daysSincePlanting = this.getDaysSincePlanting(plant.id, date);
                    
                    if (phase && daysSincePlanting > 0) {
                        const phaseStartDate = new Date(phase.startDate);
                        const currentDate = new Date(date);
                        const daysSincePhaseStart = Math.floor((currentDate - phaseStartDate) / (1000 * 60 * 60 * 1000)) + 1;
                        const weekInPhase = Math.ceil(daysSincePhaseStart / 7);
                        
                        info.plants.push({
                            plant: plant,
                            phase: phase,
                            daysSincePlanting: daysSincePlanting,
                            daysSincePhaseStart: daysSincePhaseStart,
                            weekInPhase: weekInPhase
                        });
                        info.hasInfo = true;
                    }
                    
                    // Check for milestones
                    if (daysSincePlanting === 1) {
                        info.milestones.push({ type: 'planted', plant: plant });
                        info.hasInfo = true;
                    } else if (daysSincePlanting === 14) {
                        info.milestones.push({ type: '2weeks', plant: plant });
                        info.hasInfo = true;
                    } else if (daysSincePlanting === 28) {
                        info.milestones.push({ type: '1month', plant: plant });
                        info.hasInfo = true;
                    }
                    
                    // Check for phase transitions
                    if (this.isPhaseTransition(date, plant)) {
                        const nextPhase = this.getPhaseTransitionInfo(date, plant);
                        if (nextPhase) {
                            info.phaseTransitions.push({ plant: plant, phase: nextPhase });
                            info.hasInfo = true;
                        }
                    }
                });
                
                // Collect watering information
                const dayWaterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = this.getLocalDateString(new Date(watering.date));
                    return wateringDate === dateStr;
                });
                
                if (dayWaterings.length > 0) {
                    info.waterings = dayWaterings;
                    info.hasInfo = true;
                }
                
                return info;
            }

            renderPlantDayIcons(dayElement, dayInfo, plant) {
                const iconsContainer = document.createElement('div');
                iconsContainer.className = 'flex flex-wrap gap-1 text-xs';
                
                // Phase icon for this plant
                if (dayInfo.phase) {
                    const icon = document.createElement('span');
                    icon.className = 'inline-flex items-center';
                    icon.innerHTML = this.getPhaseIcon(dayInfo.phase.type);
                    iconsContainer.appendChild(icon);
                }
                
                // Watering icons for this plant (–±–µ–∑ NPK –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
                if (dayInfo.waterings.length > 0) {
                    const waterIcon = document.createElement('span');
                    waterIcon.className = 'text-blue-400';
                    waterIcon.textContent = `üíß${dayInfo.waterings.length > 1 ? dayInfo.waterings.length : ''}`;
                    iconsContainer.appendChild(waterIcon);
                }
                
                // Milestone icons
                dayInfo.milestones.forEach(milestone => {
                    const milestoneIcon = document.createElement('span');
                    if (milestone.type === 'planted') {
                        milestoneIcon.textContent = 'üå±';
                        milestoneIcon.className = 'text-green-400';
                    } else if (milestone.type === '2weeks') {
                        milestoneIcon.textContent = 'üìà';
                        milestoneIcon.className = 'text-blue-400';
                    } else if (milestone.type === '1month') {
                        milestoneIcon.textContent = 'üéÇ';
                        milestoneIcon.className = 'text-purple-400';
                    }
                    iconsContainer.appendChild(milestoneIcon);
                });
                
                // Phase transition icons
                if (dayInfo.phaseTransitions.length > 0) {
                    const transitionIcon = document.createElement('span');
                    transitionIcon.textContent = 'üîÑ';
                    transitionIcon.className = 'text-orange-400';
                    iconsContainer.appendChild(transitionIcon);
                }
                
                dayElement.appendChild(iconsContainer);
            }

            renderDayIcons(dayElement, dayInfo) {
                const iconsContainer = document.createElement('div');
                iconsContainer.className = 'flex flex-wrap gap-1 text-xs';
                
                // Phase icons
                const phaseTypes = {};
                dayInfo.plants.forEach(plantInfo => {
                    phaseTypes[plantInfo.phase.type] = (phaseTypes[plantInfo.phase.type] || 0) + 1;
                });
                
                Object.entries(phaseTypes).forEach(([type, count]) => {
                    const icon = document.createElement('span');
                    icon.className = 'inline-flex items-center';
                    icon.innerHTML = `${this.getPhaseIcon(type)}${count > 1 ? `<sub class="text-xs">${count}</sub>` : ''}`;
                    iconsContainer.appendChild(icon);
                });
                
                // Watering icons
                if (dayInfo.waterings.length > 0) {
                    const waterIcon = document.createElement('span');
                    waterIcon.className = 'text-blue-400';
                    waterIcon.textContent = `üíß${dayInfo.waterings.length > 1 ? dayInfo.waterings.length : ''}`;
                    iconsContainer.appendChild(waterIcon);
                }
                
                // Milestone icons
                dayInfo.milestones.forEach(milestone => {
                    const milestoneIcon = document.createElement('span');
                    if (milestone.type === 'planted') {
                        milestoneIcon.textContent = 'üå±';
                        milestoneIcon.className = 'text-green-400';
                    } else if (milestone.type === '2weeks') {
                        milestoneIcon.textContent = 'üìà';
                        milestoneIcon.className = 'text-blue-400';
                    } else if (milestone.type === '1month') {
                        milestoneIcon.textContent = 'üéÇ';
                        milestoneIcon.className = 'text-purple-400';
                    }
                    iconsContainer.appendChild(milestoneIcon);
                });
                
                // Phase transition icons
                if (dayInfo.phaseTransitions.length > 0) {
                    const transitionIcon = document.createElement('span');
                    transitionIcon.textContent = 'üîÑ';
                    transitionIcon.className = 'text-orange-400';
                    iconsContainer.appendChild(transitionIcon);
                }
                
                dayElement.appendChild(iconsContainer);
            }

            addPlantDayTooltip(dayElement, dayInfo, date, plant) {
                let tooltipContent = '';
                
                // Date header
                tooltipContent += `üìÖ ${date.toLocaleDateString('ru-RU', { 
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long' 
                })}\n`;
                tooltipContent += `üåø ${plant.name}\n\n`;
                
                // Plant information
                if (dayInfo.phase) {
                    tooltipContent += `üìä –î–µ–Ω—å ${dayInfo.daysSincePlanting} —Å –ø–æ—Å–∞–¥–∫–∏\n`;
                    tooltipContent += `${this.getPhaseIcon(dayInfo.phase.type)} ${this.getPhaseDisplayName(dayInfo.phase.type)}\n`;
                    tooltipContent += `üìç –î–µ–Ω—å ${dayInfo.daysSincePhaseStart} –≤ —Ñ–∞–∑–µ (–Ω–µ–¥–µ–ª—è ${dayInfo.weekInPhase})\n`;
                    tooltipContent += `üí° –°–≤–µ—Ç: ${dayInfo.phase.lightOnTime} - ${dayInfo.phase.lightOffTime}\n\n`;
                }
                
                // Watering information for this plant with NPK
                if (dayInfo.waterings.length > 0) {
                    tooltipContent += 'üíß –ü–æ–ª–∏–≤—ã:\n';
                    dayInfo.waterings.forEach(watering => {
                        const time = new Date(watering.date).toLocaleTimeString('ru-RU', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                        
                        tooltipContent += `‚Ä¢ ${time}: ${watering.volume}–ª ${recipe ? `+ ${recipe.name}` : '(—Ç–æ–ª—å–∫–æ –≤–æ–¥–∞)'}\n`;
                        
                        // Add NPK information if recipe is used
                        if (recipe) {
                            const npkValues = this.calculateRecipeNPK(recipe);
                            tooltipContent += `  üß™ NPK: ${npkValues.n.toFixed(0)}-${npkValues.p.toFixed(0)}-${npkValues.k.toFixed(0)} –º–≥/–ª\n`;
                        }
                        
                        if (watering.notes) {
                            tooltipContent += `  üìù ${watering.notes}\n`;
                        }
                    });
                    tooltipContent += '\n';
                }
                
                // Milestones
                if (dayInfo.milestones.length > 0) {
                    tooltipContent += 'üéØ –°–æ–±—ã—Ç–∏—è:\n';
                    dayInfo.milestones.forEach(milestone => {
                        if (milestone.type === 'planted') {
                            tooltipContent += `‚Ä¢ –î–µ–Ω—å –ø–æ—Å–∞–¥–∫–∏\n`;
                        } else if (milestone.type === '2weeks') {
                            tooltipContent += `‚Ä¢ 2 –Ω–µ–¥–µ–ª–∏ —Ä–æ—Å—Ç–∞\n`;
                        } else if (milestone.type === '1month') {
                            tooltipContent += `‚Ä¢ 1 –º–µ—Å—è—Ü —Ä–æ—Å—Ç–∞\n`;
                        }
                    });
                    tooltipContent += '\n';
                }
                
                // Phase transitions
                if (dayInfo.phaseTransitions.length > 0) {
                    tooltipContent += 'üîÑ –ü–µ—Ä–µ—Ö–æ–¥—ã —Ñ–∞–∑:\n';
                    dayInfo.phaseTransitions.forEach(transition => {
                        tooltipContent += `‚Ä¢ ‚Üí ${transition.phase}\n`;
                    });
                }
                
                // Add custom tooltip using CSS (no standard title attribute to avoid double tooltips)
                dayElement.addEventListener('mouseenter', (e) => {
                    this.showTooltip(e.target, tooltipContent.trim());
                });
                
                dayElement.addEventListener('mouseleave', () => {
                    this.hideTooltip();
                });
            }

            addDayTooltip(dayElement, dayInfo, date) {
                let tooltipContent = '';
                
                // Date header
                tooltipContent += `üìÖ ${date.toLocaleDateString('ru-RU', { 
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long' 
                })}\n\n`;
                
                // Plants information
                if (dayInfo.plants.length > 0) {
                    tooltipContent += 'üåø –†–∞—Å—Ç–µ–Ω–∏—è:\n';
                    dayInfo.plants.forEach(plantInfo => {
                        tooltipContent += `‚Ä¢ ${plantInfo.plant.name}: `;
                        tooltipContent += `–î–µ–Ω—å ${plantInfo.daysSincePlanting} `;
                        tooltipContent += `(${this.getPhaseDisplayName(plantInfo.phase.type)}, `;
                        tooltipContent += `–Ω–µ–¥–µ–ª—è ${plantInfo.weekInPhase})\n`;
                        tooltipContent += `  üí° ${plantInfo.phase.lightOnTime} - ${plantInfo.phase.lightOffTime}\n`;
                    });
                    tooltipContent += '\n';
                }
                
                // Watering information
                if (dayInfo.waterings.length > 0) {
                    tooltipContent += 'üíß –ü–æ–ª–∏–≤—ã:\n';
                    dayInfo.waterings.forEach(watering => {
                        const time = new Date(watering.date).toLocaleTimeString('ru-RU', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                        const plantsNames = watering.plantIds.map(id => 
                            this.data.plants[id]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ'
                        ).join(', ');
                        
                        tooltipContent += `‚Ä¢ ${time}: ${plantsNames}\n`;
                        tooltipContent += `  ${watering.volume}–ª ${recipe ? `+ ${recipe.name}` : '(—Ç–æ–ª—å–∫–æ –≤–æ–¥–∞)'}\n`;
                        if (watering.notes) {
                            tooltipContent += `  üìù ${watering.notes}\n`;
                        }
                    });
                    tooltipContent += '\n';
                }
                
                // Milestones
                if (dayInfo.milestones.length > 0) {
                    tooltipContent += 'üéØ –°–æ–±—ã—Ç–∏—è:\n';
                    dayInfo.milestones.forEach(milestone => {
                        if (milestone.type === 'planted') {
                            tooltipContent += `‚Ä¢ ${milestone.plant.name}: –î–µ–Ω—å –ø–æ—Å–∞–¥–∫–∏\n`;
                        } else if (milestone.type === '2weeks') {
                            tooltipContent += `‚Ä¢ ${milestone.plant.name}: 2 –Ω–µ–¥–µ–ª–∏ —Ä–æ—Å—Ç–∞\n`;
                        } else if (milestone.type === '1month') {
                            tooltipContent += `‚Ä¢ ${milestone.plant.name}: 1 –º–µ—Å—è—Ü —Ä–æ—Å—Ç–∞\n`;
                        }
                    });
                    tooltipContent += '\n';
                }
                
                // Phase transitions
                if (dayInfo.phaseTransitions.length > 0) {
                    tooltipContent += 'üîÑ –ü–µ—Ä–µ—Ö–æ–¥—ã —Ñ–∞–∑:\n';
                    dayInfo.phaseTransitions.forEach(transition => {
                        tooltipContent += `‚Ä¢ ${transition.plant.name}: ‚Üí ${transition.phase}\n`;
                    });
                }
                
                // Add custom tooltip using CSS (no standard title attribute to avoid double tooltips)
                dayElement.addEventListener('mouseenter', (e) => {
                    this.showTooltip(e.target, tooltipContent.trim());
                });
                
                dayElement.addEventListener('mouseleave', () => {
                    this.hideTooltip();
                });
            }

            showTooltip(element, content) {
                // Remove existing tooltip
                this.hideTooltip();
                
                const tooltip = document.createElement('div');
                tooltip.id = 'calendar-tooltip';
                tooltip.className = 'fixed z-50 bg-gray-900 text-white text-xs p-3 rounded-lg shadow-lg max-w-xs border border-gray-600 whitespace-pre-line';
                tooltip.textContent = content;
                
                document.body.appendChild(tooltip);
                
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                // Position tooltip
                let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                let top = rect.top - tooltipRect.height - 8;
                
                // Adjust if tooltip goes off screen
                if (left < 8) left = 8;
                if (left + tooltipRect.width > window.innerWidth - 8) {
                    left = window.innerWidth - tooltipRect.width - 8;
                }
                if (top < 8) {
                    top = rect.bottom + 8;
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }

            hideTooltip() {
                const tooltip = document.getElementById('calendar-tooltip');
                if (tooltip) {
                    tooltip.remove();
                }
            }

            renderDayEvents(dayElement, dateStr, date) {
                // This method is now replaced by the new compact icon system
                // The day information is collected in collectDayInfo and displayed as icons
                return;
            }

            getPhaseShortName(type) {
                const names = {
                    'vegetation': '–í–µ–≥–µ—Ç–∞—Ü–∏—è',
                    'flowering': '–¶–≤–µ—Ç–µ–Ω–∏–µ',
                    'drying': '–°—É—à–∫–∞',
                    'harvest': '–•–∞—Ä–≤–µ—Å—Ç',
                    'unknown': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                };
                return names[type] || type;
            }

            getSpeciesDisplayName(species) {
                const names = {
                    'cannabis-indica': 'üåø Cannabis Indica',
                    'cannabis-sativa': 'üå≤ Cannabis Sativa',
                    'cannabis-hybrid': 'üå≥ Cannabis Hybrid',
                    'cannabis-ruderalis': 'üåæ Cannabis Ruderalis',
                    'tomato': 'üçÖ –¢–æ–º–∞—Ç',
                    'pepper': 'üå∂Ô∏è –ü–µ—Ä–µ—Ü',
                    'cucumber': 'ü•í –û–≥—É—Ä–µ—Ü',
                    'lettuce': 'ü•¨ –°–∞–ª–∞—Ç',
                    'basil': 'üåø –ë–∞–∑–∏–ª–∏–∫',
                    'mint': 'üåø –ú—è—Ç–∞',
                    'parsley': 'üåø –ü–µ—Ç—Ä—É—à–∫–∞',
                    'cilantro': 'üåø –ö–∏–Ω–∑–∞',
                    'spinach': 'ü•¨ –®–ø–∏–Ω–∞—Ç',
                    'other': '‚ùì –î—Ä—É–≥–æ–µ'
                };
                return names[species] || species;
            }

            getSubstrateDisplayName(substrate) {
                const names = {
                    'soil-organic': 'üåç –û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∞—è –ø–æ—á–≤–∞',
                    'soil-commercial': 'üè™ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –ø–æ—á–≤–∞',
                    'coco-coir': 'ü•• –ö–æ–∫–æ—Å–æ–≤–æ–µ –≤–æ–ª–æ–∫–Ω–æ',
                    'perlite-vermiculite': '‚ö™ –ü–µ—Ä–ª–∏—Ç + –í–µ—Ä–º–∏–∫—É–ª–∏—Ç',
                    'hydroponic-clay': 'üîµ –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (–∫–µ—Ä–∞–º–∑–∏—Ç)',
                    'hydroponic-rockwool': 'üßΩ –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (–º–∏–Ω–≤–∞—Ç–∞)',
                    'hydroponic-dwc': 'üíß –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (DWC)',
                    'hydroponic-nft': 'üåä –ì–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∞ (NFT)',
                    'aeroponic': 'üí® –ê—ç—Ä–æ–ø–æ–Ω–∏–∫–∞',
                    'soilless-mix': 'üåø –ë–µ—Å–ø–æ—á–≤–µ–Ω–Ω–∞—è —Å–º–µ—Å—å',
                    'peat-moss': 'üçÑ –¢–æ—Ä—Ñ—è–Ω–æ–π –º–æ—Ö',
                    'other': '‚ùì –î—Ä—É–≥–æ–µ'
                };
                return names[substrate] || substrate;
            }

            shouldShowWateringReminder(date, plant) {
                // Show watering reminder every 2-3 days (simplified logic)
                const daysSincePlanting = this.getDaysSincePlanting(plant.id, date);
                return daysSincePlanting > 0 && daysSincePlanting % 3 === 0;
            }

            getWateringInfoForDate(date, plant) {
                const dateStr = this.getLocalDateString(date);
                
                // –ü–æ–∏—Å–∫ –ø–æ–ª–∏–≤–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
                const waterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = this.getLocalDateString(new Date(watering.date));
                    return wateringDate === dateStr && watering.plantIds.includes(plant.id);
                });
                
                if (waterings.length === 0) {
                    return null;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø–æ–ª–∏–≤–µ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
                const watering = waterings[waterings.length - 1];
                const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                
                if (recipe) {
                    return `${watering.volume}–ª + ${recipe.name}`;
                } else {
                    return `${watering.volume}–ª –≤–æ–¥—ã`;
                }
            }

            shouldShowFeedingReminder(date, plant, phase) {
                // Show feeding reminder based on phase (weekly for veg, bi-weekly for flower)
                const daysSincePlanting = this.getDaysSincePlanting(plant.id, date);
                if (phase.type === 'vegetation') {
                    return daysSincePlanting > 0 && daysSincePlanting % 7 === 0;
                } else if (phase.type === 'flowering') {
                    return daysSincePlanting > 0 && daysSincePlanting % 14 === 0;
                }
                return false;
            }

            addCalendarMilestones(dayElement, dateStr, plants) {
                const date = new Date(dateStr);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–∏–≤–∞—Ö –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
                const dayWaterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = new Date(watering.date).toISOString().split('T')[0];
                    return wateringDate === dateStr;
                });
                
                if (dayWaterings.length > 0) {
                    dayWaterings.forEach(watering => {
                        const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                        const plantsCount = watering.plantIds.length;
                        const wateringText = plantsCount > 1 
                            ? `${plantsCount} —Ä–∞—Å—Ç–µ–Ω–∏–π ‚Ä¢ ${watering.volume}–ª` 
                            : `${watering.volume}–ª`;
                        
                        this.addMilestone(dayElement, 'üíß', wateringText, 'bg-blue-500');
                        
                        if (recipe) {
                            this.addMilestone(dayElement, 'üß™', recipe.name.substring(0, 12), 'bg-cyan-600');
                        }
                    });
                }
                
                plants.forEach(plant => {
                    const plantDate = new Date(plant.plantDate);
                    const daysSince = this.getDaysSincePlanting(plant.id, date);
                    
                    // Check for important milestones
                    if (daysSince === 1) {
                        this.addMilestone(dayElement, 'üå±', '–î–µ–Ω—å –ø–æ—Å–∞–¥–∫–∏', 'bg-green-500');
                    } else if (daysSince === 14) {
                        this.addMilestone(dayElement, 'üìà', '2 –Ω–µ–¥–µ–ª–∏ —Ä–æ—Å—Ç–∞', 'bg-blue-500');
                    } else if (daysSince === 28) {
                        this.addMilestone(dayElement, 'üîÑ', '–ú–µ—Å—è—Ü —Ä–æ—Å—Ç–∞', 'bg-purple-500');
                    } else if (this.isPhaseTransition(date, plant)) {
                        const nextPhase = this.getPhaseTransitionInfo(date, plant);
                        if (nextPhase) {
                            this.addMilestone(dayElement, 'üîÑ', `‚Üí ${nextPhase}`, 'bg-orange-500');
                        }
                    }
                });
            }

            addMilestone(dayElement, icon, text, bgColor) {
                const milestone = document.createElement('div');
                milestone.className = `text-xs p-1 mt-1 rounded ${bgColor} text-white font-medium flex items-center gap-1`;
                milestone.innerHTML = `
                    <span>${icon}</span>
                    <span class="truncate">${text}</span>
                `;
                dayElement.appendChild(milestone);
            }

            isPhaseTransition(date, plant) {
                const phases = Object.values(this.data.lightPhases)
                    .filter(phase => phase.plantId === plant.id)
                    .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                const dateStr = date.toISOString().split('T')[0];
                return phases.some(phase => phase.startDate === dateStr);
            }

            getPhaseTransitionInfo(date, plant) {
                const phase = this.getCurrentLightPhase(plant.id, date);
                if (phase) {
                    const dateStr = date.toISOString().split('T')[0];
                    if (phase.startDate === dateStr) {
                        return this.getPhaseShortName(phase.type);
                    }
                }
                return null;
            }

            showDayDetails(date, plant, phase) {
                const daysSincePlanting = this.getDaysSincePlanting(plant.id, date);
                const phaseStartDate = new Date(phase.startDate);
                const daysSincePhaseStart = Math.floor((date - phaseStartDate) / (1000 * 60 * 60 * 24)) + 1;
                
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–∏–≤—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
                const dateStr = date.toISOString().split('T')[0];
                const dayWaterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = new Date(watering.date).toISOString().split('T')[0];
                    return wateringDate === dateStr && watering.plantIds.includes(plant.id);
                });
                
                let wateringInfo = '';
                if (dayWaterings.length > 0) {
                    wateringInfo = '\nüíß –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª–∏–≤–æ–≤:\n';
                    dayWaterings.forEach(watering => {
                        const time = new Date(watering.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                        wateringInfo += `‚Ä¢ ${time}: ${watering.volume}–ª ${recipe ? `+ ${recipe.name}` : '(—Ç–æ–ª—å–∫–æ –≤–æ–¥–∞)'}\n`;
                        if (watering.notes) {
                            wateringInfo += `  –ó–∞–º–µ—Ç–∫–∏: ${watering.notes}\n`;
                        }
                    });
                    wateringInfo += '\nüí° –°–æ–≤–µ—Ç: –í —Ä–∞–∑–¥–µ–ª–µ "–°–æ–±—ã—Ç–∏—è —Å–µ–≥–æ–¥–Ω—è" –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –æ—à–∏–±–æ—á–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ –ø–æ–ª–∏–≤–µ';
                }
                
                alert(`
üìÖ –î–µ—Ç–∞–ª–∏ –¥–Ω—è: ${date.toLocaleDateString('ru-RU')}

üåø –†–∞—Å—Ç–µ–Ω–∏–µ: ${plant.name}
${plant.strain ? `üß¨ –°–æ—Ä—Ç: ${plant.strain}` : ''}

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –î–µ–Ω—å —Å –ø–æ—Å–∞–¥–∫–∏: ${daysSincePlanting}
‚Ä¢ –§–∞–∑–∞: ${this.getPhaseDisplayName(phase.type)}
‚Ä¢ –î–µ–Ω—å –≤ —Ñ–∞–∑–µ: ${daysSincePhaseStart}

üí° –°–≤–µ—Ç–æ–≤–æ–π —Ä–µ–∂–∏–º:
‚Ä¢ –í–∫–ª—é—á–µ–Ω–∏–µ: ${phase.lightOnTime}
‚Ä¢ –í—ã–∫–ª—é—á–µ–Ω–∏–µ: ${phase.lightOffTime || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}
‚Ä¢ –†–µ–∂–∏–º: ${phase.schedule ? `${phase.schedule.on}/${phase.schedule.off}` : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
${wateringInfo}
${dayWaterings.length === 0 && this.shouldShowWateringReminder(date, plant) ? 'üíß –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª–∏–≤\n' : ''}
${this.shouldShowFeedingReminder(date, plant, phase) ? 'üåø –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–¥–∫–æ—Ä–º–∫–∞\n' : ''}
                `);
            }

            getPhaseColor(type) {
                const colors = {
                    'vegetation': 'bg-green-600 text-white',
                    'flowering': 'bg-purple-600 text-white',
                    'drying': 'bg-orange-600 text-white',
                    'harvest': 'bg-red-600 text-white'
                };
                return colors[type] || 'bg-gray-600 text-white';
            }

            getPhaseIcon(type) {
                const icons = {
                    'vegetation': 'üå±',
                    'flowering': 'üå∏',
                    'drying': 'üçÇ',
                    'harvest': 'üåæ'
                };
                return icons[type] || '‚ö´';
            }

            // Calendar navigation
            previousMonth() {
                this.currentMonth.setMonth(this.currentMonth.getMonth() - 1);
                this.renderPlantCalendars();
            }

            nextMonth() {
                this.currentMonth.setMonth(this.currentMonth.getMonth() + 1);
                this.renderPlantCalendars();
            }

            goToToday() {
                this.currentMonth = new Date();
                this.renderPlantCalendars();
            }

            // Dashboard rendering
            renderDashboard() {
                // Render today's events
                this.renderTodayEvents();
            }

            renderTodayEvents() {
                const sidebarContainer = document.getElementById('sidebar-today-events');
                
                if (sidebarContainer) sidebarContainer.innerHTML = '';

                const today = this.getLocalDateString(new Date());
                const plants = Object.values(this.data.plants);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø–æ–ª–∏–≤—ã
                const todayWaterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = this.getLocalDateString(new Date(watering.date));
                    return wateringDate === today;
                });

                if (plants.length === 0) {
                    const noDataMsg = '<div class="text-gray-400 text-sm">–î–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</div>';
                    if (sidebarContainer) sidebarContainer.innerHTML = noDataMsg;
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø–æ–ª–∏–≤—ã —Ç–æ–ª—å–∫–æ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
                if (todayWaterings.length > 0 && sidebarContainer) {
                    todayWaterings.forEach(watering => {
                        const time = new Date(watering.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        const plantsNames = watering.plantIds.map(id => this.data.plants[id]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ').join(', ');
                        
                        // Sidebar version (compact)
                        const sidebarWateringEl = document.createElement('div');
                        sidebarWateringEl.className = 'flex items-center gap-2 p-2 bg-blue-600/20 rounded-lg text-sm';
                        sidebarWateringEl.innerHTML = `
                            <span class="text-blue-400">üíß</span>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium truncate">${plantsNames.length > 20 ? plantsNames.substring(0, 20) + '...' : plantsNames}</div>
                                <div class="text-xs text-gray-400">${time} ‚Ä¢ ${watering.volume}–ª</div>
                            </div>
                        `;
                        sidebarContainer.appendChild(sidebarWateringEl);
                    });
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
                if (sidebarContainer) {
                    plants.forEach(plant => {
                        const phase = this.getCurrentLightPhase(plant.id, new Date());
                        if (phase) {
                            const sidebarEventEl = document.createElement('div');
                            sidebarEventEl.className = 'flex items-center gap-2 p-2 bg-gray-800 rounded-lg text-sm';
                            sidebarEventEl.innerHTML = `
                                <span>${this.getPhaseIcon(phase.type)}</span>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium truncate">${plant.name}</div>
                                    <div class="text-xs text-gray-400">${this.getPhaseShortName(phase.type)} ‚Ä¢ ${phase.lightOnTime}</div>
                                </div>
                            `;
                            sidebarContainer.appendChild(sidebarEventEl);
                        }
                    });
                }
            }

            // Fertilizer rendering
            renderFertilizers() {
                const container = document.getElementById('fertilizers-grid');
                const fertilizers = Object.values(this.data.fertilizers);
                
                container.innerHTML = '';
                
                fertilizers.forEach(fertilizer => {
                    const fertilizerCard = document.createElement('div');
                    fertilizerCard.className = 'bg-dark rounded-lg overflow-hidden max-w-sm';
                    
                    // Use fertilizer image if available, otherwise use default
                    const backgroundImage = fertilizer.image || '1nsfSKxFu5LKDqP7zoRtP';
                    
                    fertilizerCard.innerHTML = `
                        <!-- Fertilizer Header -->
                        <div class="bg-gray-700 p-2 flex items-center justify-between">
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                <!-- Small fertilizer image -->
                                <div class="w-8 h-8 bg-gray-600 rounded overflow-hidden flex-shrink-0 cursor-pointer hover:ring-2 hover:ring-primary/50 transition-all" onclick="app.showFertilizerImageModal('${fertilizer.id}')">
                                    <img src="${backgroundImage}" alt="${fertilizer.name}" class="w-full h-full object-cover">
                                </div>
                                <!-- Fertilizer info -->
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-semibold text-white truncate">${fertilizer.name}</h3>
                                    <div class="text-xs text-gray-400">
                                        ${fertilizer.density}–≥/–º–ª
                                    </div>
                                </div>
                            </div>
                            <!-- Action buttons -->
                            <div class="flex gap-1 ml-1">
                                <button onclick="app.editFertilizer('${fertilizer.id}')" class="p-1 bg-gray-600 hover:bg-gray-500 rounded transition-colors">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="app.deleteFertilizerConfirm('${fertilizer.id}')" class="p-1 bg-gray-600 hover:bg-gray-500 rounded transition-colors">
                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Fertilizer Details -->
                        <div class="p-2">
                            <div class="grid grid-cols-3 gap-1">
                                <div class="text-center p-1.5 bg-gray-800 rounded">
                                    <div class="text-sm font-bold text-blue-400">${fertilizer.npk.n}%</div>
                                    <div class="text-xs text-gray-400">N</div>
                                </div>
                                <div class="text-center p-1.5 bg-gray-800 rounded">
                                    <div class="text-sm font-bold text-yellow-400">${fertilizer.npk.p}%</div>
                                    <div class="text-xs text-gray-400">P</div>
                                </div>
                                <div class="text-center p-1.5 bg-gray-800 rounded">
                                    <div class="text-sm font-bold text-purple-400">${fertilizer.npk.k}%</div>
                                    <div class="text-xs text-gray-400">K</div>
                                </div>
                            </div>
                            ${fertilizer.microElements ? `
                                <div class="mt-2 text-xs text-gray-400 text-center truncate" title="${fertilizer.microElements}">
                                    ${fertilizer.microElements.length > 20 ? fertilizer.microElements.substring(0, 20) + '...' : fertilizer.microElements}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    container.appendChild(fertilizerCard);
                });
            }

            // Recipe rendering
            renderRecipes() {
                const container = document.getElementById('recipes-list');
                const recipes = Object.values(this.data.recipes);
                
                container.innerHTML = '';
                
                recipes.forEach(recipe => {
                    const totals = this.calculateRecipeTotals(recipe);
                    
                    const recipeCard = document.createElement('div');
                    recipeCard.className = 'bg-dark p-3 rounded-lg max-w-sm';
                    recipeCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1 min-w-0">
                                <h3 class="text-sm font-semibold truncate">${recipe.name}</h3>
                                <div class="text-xs text-gray-400">${recipe.volume}–ª</div>
                            </div>
                            <div class="flex gap-1 ml-2">
                                <button onclick="app.editRecipe('${recipe.id}')" class="p-1 bg-gray-700 hover:bg-gray-600 rounded transition-colors">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="app.deleteRecipeConfirm('${recipe.id}')" class="p-1 bg-gray-700 hover:bg-gray-600 rounded transition-colors">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="space-y-0.5">
                                ${recipe.fertilizers.map(fert => {
                                    const fertilizer = this.data.fertilizers[fert.fertilizerId];
                                    return fertilizer ? `
                                        <div class="text-xs text-gray-300 flex justify-between">
                                            <span class="truncate mr-2">${fertilizer.name}</span>
                                            <span class="text-primary whitespace-nowrap">${fert.dose}–º–ª</span>
                                        </div>
                                    ` : '';
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-2 rounded">
                            <div class="grid grid-cols-3 gap-1 text-xs">
                                <div class="text-center">
                                    <div class="text-blue-400 font-medium text-sm">${totals.n.toFixed(0)}</div>
                                    <div class="text-gray-500 text-xs">N</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-yellow-400 font-medium text-sm">${totals.p.toFixed(0)}</div>
                                    <div class="text-gray-500 text-xs">P</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-purple-400 font-medium text-sm">${totals.k.toFixed(0)}</div>
                                    <div class="text-gray-500 text-xs">K</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(recipeCard);
                });
            }

            calculateRecipeTotals(recipe) {
                let totals = { n: 0, p: 0, k: 0 };
                
                recipe.fertilizers.forEach(fert => {
                    const fertilizer = this.data.fertilizers[fert.fertilizerId];
                    if (fertilizer) {
                        // Calculate nutrient contribution in mg/L
                        // dose (ml/L) * density (g/ml) * npk (%) * 10 = mg/L
                        totals.n += fert.dose * fertilizer.density * fertilizer.npk.n * 10;
                        totals.p += fert.dose * fertilizer.density * fertilizer.npk.p * 10;
                        totals.k += fert.dose * fertilizer.density * fertilizer.npk.k * 10;
                    }
                });
                
                return totals;
            }

            // Helper method for NPK calculation (alias for compatibility)
            calculateRecipeNPK(recipe) {
                return this.calculateRecipeTotals(recipe);
            }

            // Modal management
            showPlantModal(plantId = null) {
                this.currentPlantId = plantId;
                const modal = document.getElementById('plant-modal');
                const title = document.getElementById('plant-modal-title');
                const form = document.getElementById('plant-form');
                
                if (plantId) {
                    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ';
                    const plant = this.data.plants[plantId];
                    document.getElementById('plant-name').value = plant.name;
                    document.getElementById('plant-date').value = plant.plantDate;
                    document.getElementById('plant-strain').value = plant.strain || '';
                    document.getElementById('plant-species').value = plant.species || '';
                    document.getElementById('plant-substrate').value = plant.substrate || '';
                    document.getElementById('plant-light-on').value = plant.lightOnTime || '08:00';
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (plant.image) {
                        const previewContainer = document.getElementById('plant-image-preview');
                        const previewImg = document.getElementById('plant-preview-img');
                        const imageUrlInput = document.getElementById('plant-image-url');
                        
                        previewImg.src = plant.image;
                        previewContainer.classList.remove('hidden');
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ URL (–Ω–µ data URL), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –ø–æ–ª–µ URL
                        if (plant.image.startsWith('http')) {
                            imageUrlInput.value = plant.image;
                            this.switchPlantUploadMode('url');
                        } else {
                            // –≠—Ç–æ base64 –∏–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
                            this.switchPlantUploadMode('file');
                        }
                    } else {
                        document.getElementById('plant-image-preview').classList.add('hidden');
                        this.switchPlantUploadMode('file');
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input —Ñ–∞–π–ª–∞
                    document.getElementById('plant-image').value = '';
                    
                    // Load growth phase settings
                    if (plant.growthPhases && plant.growthPhases.useDates) {
                        // Date mode
                        this.setPhaseMode('dates');
                        document.getElementById('veg-start-date').value = plant.growthPhases.vegStartDate || plant.plantDate;
                        document.getElementById('veg-end-date').value = plant.growthPhases.vegEndDate || '';
                        document.getElementById('flower-start-date').value = plant.growthPhases.flowerStartDate || '';
                        document.getElementById('flower-end-date').value = plant.growthPhases.flowerEndDate || '';
                        document.getElementById('dry-start-date').value = plant.growthPhases.dryStartDate || '';
                        document.getElementById('dry-end-date').value = plant.growthPhases.dryEndDate || '';
                    } else {
                        // Duration mode
                        this.setPhaseMode('duration');
                        const phases = plant.growthPhases || { vegetation: 28, flowering: 63, drying: 10 };
                        document.getElementById('veg-duration').value = phases.vegetation;
                        document.getElementById('flower-duration').value = phases.flowering;
                        document.getElementById('dry-duration').value = phases.drying;
                    }
                } else {
                    title.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ';
                    form.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('plant-date').value = today;
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    document.getElementById('plant-image-preview').classList.add('hidden');
                    
                    // Default to date mode for new plants
                    this.setPhaseMode('dates');
                    this.calculateDefaultDates(today);
                }
                
                // Add event listeners for mode switching
                document.getElementById('date-mode-btn').onclick = () => this.setPhaseMode('dates');
                document.getElementById('duration-mode-btn').onclick = () => this.setPhaseMode('duration');
                
                // Add event listeners for image handling
                this.setupImageHandlers();
                
                // Add event listeners for real-time updates
                this.addPhaseInputListeners();
                
                modal.classList.remove('hidden');
                this.updateGrowthForecast();
            }

            setupImageHandlers() {
                const imageInput = document.getElementById('plant-image');
                const imageUrlInput = document.getElementById('plant-image-url');
                const previewContainer = document.getElementById('plant-image-preview');
                const previewImg = document.getElementById('plant-preview-img');
                const removeBtn = document.getElementById('remove-plant-image');
                
                // Tab switching
                const fileBtn = document.getElementById('plant-upload-file-btn');
                const urlBtn = document.getElementById('plant-upload-url-btn');
                const loadUrlBtn = document.getElementById('load-plant-image-url');

                fileBtn.addEventListener('click', () => this.switchPlantUploadMode('file'));
                urlBtn.addEventListener('click', () => this.switchPlantUploadMode('url'));

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
                        imageInput.value = '';
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                    if (!file.type.startsWith('image/')) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                        imageInput.value = '';
                        return;
                    }

                    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                        // Clear URL input when file is loaded
                        imageUrlInput.value = '';
                    };
                    reader.readAsDataURL(file);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ URL
                loadUrlBtn.addEventListener('click', () => this.loadPlantImageFromUrl());

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                removeBtn.addEventListener('click', () => {
                    imageInput.value = '';
                    imageUrlInput.value = '';
                    previewContainer.classList.add('hidden');
                    previewImg.src = '';
                });
            }

            setPhaseMode(mode) {
                this.currentPhaseMode = mode;
                
                const dateModeBtn = document.getElementById('date-mode-btn');
                const durationModeBtn = document.getElementById('duration-mode-btn');
                const dateModeConfig = document.getElementById('date-mode-config');
                const durationModeConfig = document.getElementById('duration-mode-config');
                
                if (mode === 'dates') {
                    dateModeBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    durationModeBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    dateModeConfig.classList.remove('hidden');
                    durationModeConfig.classList.add('hidden');
                } else {
                    dateModeBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    durationModeBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    dateModeConfig.classList.add('hidden');
                    durationModeConfig.classList.remove('hidden');
                }
                
                this.updateGrowthForecast();
            }

            calculateDefaultDates(plantDate) {
                const startDate = new Date(plantDate);
                
                // Vegetation: start from plant date
                const vegStart = new Date(startDate);
                const vegEnd = new Date(startDate);
                vegEnd.setDate(vegStart.getDate() + 27); // 28 days
                
                // Flowering: start after vegetation
                const flowerStart = new Date(vegEnd);
                flowerStart.setDate(vegEnd.getDate() + 1);
                const flowerEnd = new Date(flowerStart);
                flowerEnd.setDate(flowerStart.getDate() + 62); // 63 days
                
                // Drying: start after flowering
                const dryStart = new Date(flowerEnd);
                dryStart.setDate(flowerEnd.getDate() + 1);
                const dryEnd = new Date(dryStart);
                dryEnd.setDate(dryStart.getDate() + 9); // 10 days
                
                document.getElementById('veg-start-date').value = vegStart.toISOString().split('T')[0];
                document.getElementById('veg-end-date').value = vegEnd.toISOString().split('T')[0];
                document.getElementById('flower-start-date').value = flowerStart.toISOString().split('T')[0];
                document.getElementById('flower-end-date').value = flowerEnd.toISOString().split('T')[0];
                document.getElementById('dry-start-date').value = dryStart.toISOString().split('T')[0];
                document.getElementById('dry-end-date').value = dryEnd.toISOString().split('T')[0];
                
                this.updatePhaseDurations();
            }

            addPhaseInputListeners() {
                // Duration mode listeners
                ['veg-duration', 'flower-duration', 'dry-duration', 'plant-date'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.updateGrowthForecast());
                    }
                });
                
                // Date mode listeners
                ['veg-start-date', 'veg-end-date', 'flower-start-date', 'flower-end-date', 'dry-start-date', 'dry-end-date'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => {
                            this.updatePhaseDurations();
                            this.updateGrowthForecast();
                        });
                    }
                });
                
                // Plant date change should update default dates in date mode
                const plantDateInput = document.getElementById('plant-date');
                if (plantDateInput) {
                    plantDateInput.addEventListener('input', (e) => {
                        if (this.currentPhaseMode === 'dates' && !this.currentPlantId) {
                            this.calculateDefaultDates(e.target.value);
                        }
                        this.updateGrowthForecast();
                    });
                }
            }

            updatePhaseDurations() {
                // Update duration displays for date mode
                const vegStart = document.getElementById('veg-start-date').value;
                const vegEnd = document.getElementById('veg-end-date').value;
                const flowerStart = document.getElementById('flower-start-date').value;
                const flowerEnd = document.getElementById('flower-end-date').value;
                const dryStart = document.getElementById('dry-start-date').value;
                const dryEnd = document.getElementById('dry-end-date').value;
                
                if (vegStart && vegEnd) {
                    const days = this.calculateDaysBetween(vegStart, vegEnd) + 1;
                    document.getElementById('veg-duration-display').textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${days} –¥–Ω–µ–π`;
                }
                
                if (flowerStart && flowerEnd) {
                    const days = this.calculateDaysBetween(flowerStart, flowerEnd) + 1;
                    document.getElementById('flower-duration-display').textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${days} –¥–Ω–µ–π`;
                }
                
                if (dryStart && dryEnd) {
                    const days = this.calculateDaysBetween(dryStart, dryEnd) + 1;
                    document.getElementById('dry-duration-display').textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${days} –¥–Ω–µ–π`;
                }
            }

            calculateDaysBetween(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = end - start;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            hidePlantModal() {
                document.getElementById('plant-modal').classList.add('hidden');
                this.currentPlantId = null;
            }

            updateGrowthForecast() {
                let vegStartDate, vegEndDate, flowerStartDate, flowerEndDate, dryStartDate, dryEndDate;
                let vegDuration, flowerDuration, dryDuration;

                if (this.currentPhaseMode === 'dates') {
                    // Date mode
                    vegStartDate = document.getElementById('veg-start-date').value;
                    vegEndDate = document.getElementById('veg-end-date').value;
                    flowerStartDate = document.getElementById('flower-start-date').value;
                    flowerEndDate = document.getElementById('flower-end-date').value;
                    dryStartDate = document.getElementById('dry-start-date').value;
                    dryEndDate = document.getElementById('dry-end-date').value;

                    if (!vegStartDate || !vegEndDate || !flowerStartDate || !flowerEndDate || !dryStartDate || !dryEndDate) {
                        return;
                    }

                    vegDuration = this.calculateDaysBetween(vegStartDate, vegEndDate) + 1;
                    flowerDuration = this.calculateDaysBetween(flowerStartDate, flowerEndDate) + 1;
                    dryDuration = this.calculateDaysBetween(dryStartDate, dryEndDate) + 1;
                } else {
                    // Duration mode
                    const plantDate = document.getElementById('plant-date').value;
                    if (!plantDate) return;

                    vegDuration = parseInt(document.getElementById('veg-duration').value) || 28;
                    flowerDuration = parseInt(document.getElementById('flower-duration').value) || 63;
                    dryDuration = parseInt(document.getElementById('dry-duration').value) || 10;

                    const startDate = new Date(plantDate);
                    vegStartDate = plantDate;
                    
                    const vegEnd = new Date(startDate.getTime() + (vegDuration - 1) * 24 * 60 * 60 * 1000);
                    vegEndDate = vegEnd.toISOString().split('T')[0];

                    const flowerStart = new Date(vegEnd.getTime() + 24 * 60 * 60 * 1000);
                    flowerStartDate = flowerStart.toISOString().split('T')[0];
                    
                    const flowerEnd = new Date(flowerStart.getTime() + (flowerDuration - 1) * 24 * 60 * 60 * 1000);
                    flowerEndDate = flowerEnd.toISOString().split('T')[0];

                    const dryStart = new Date(flowerEnd.getTime() + 24 * 60 * 60 * 1000);
                    dryStartDate = dryStart.toISOString().split('T')[0];
                    
                    const dryEnd = new Date(dryStart.getTime() + (dryDuration - 1) * 24 * 60 * 60 * 1000);
                    dryEndDate = dryEnd.toISOString().split('T')[0];
                }
                
                const totalDays = vegDuration + flowerDuration + dryDuration;
                const totalWeeks = (totalDays / 7).toFixed(1);
                
                const forecastContainer = document.getElementById('growth-forecast');
                forecastContainer.innerHTML = `
                    <!-- Vegetation Phase -->
                    <div class="flex items-center justify-between p-3 bg-green-600/20 rounded-lg border-l-4 border-green-400">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üå±</span>
                            <div>
                                <div class="font-medium text-green-400">–í–µ–≥–µ—Ç–∞—Ü–∏—è</div>
                                <div class="text-sm text-gray-300">–î–Ω–∏ 1-${vegDuration} (18/6)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-300">${this.formatDateString(vegStartDate)} - ${this.formatDateString(vegEndDate)}</div>
                            <div class="text-xs text-green-400">${vegDuration} –¥–Ω–µ–π</div>
                        </div>
                    </div>
                    
                    <!-- Flowering Phase -->
                    <div class="flex items-center justify-between p-3 bg-purple-600/20 rounded-lg border-l-4 border-purple-400">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üå∏</span>
                            <div>
                                <div class="font-medium text-purple-400">–¶–≤–µ—Ç–µ–Ω–∏–µ</div>
                                <div class="text-sm text-gray-300">–î–Ω–∏ ${vegDuration + 1}-${vegDuration + flowerDuration} (12/12)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-300">${this.formatDateString(flowerStartDate)} - ${this.formatDateString(flowerEndDate)}</div>
                            <div class="text-xs text-purple-400">${flowerDuration} –¥–Ω–µ–π</div>
                        </div>
                    </div>
                    
                    <!-- Drying Phase -->
                    <div class="flex items-center justify-between p-3 bg-orange-600/20 rounded-lg border-l-4 border-orange-400">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üçÇ</span>
                            <div>
                                <div class="font-medium text-orange-400">–°—É—à–∫–∞</div>
                                <div class="text-sm text-gray-300">–î–Ω–∏ ${vegDuration + flowerDuration + 1}-${totalDays} (0/24)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-300">${this.formatDateString(dryStartDate)} - ${this.formatDateString(dryEndDate)}</div>
                            <div class="text-xs text-orange-400">${dryDuration} –¥–Ω–µ–π</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('total-cycle-days').textContent = totalDays;
                document.getElementById('total-cycle-weeks').textContent = totalWeeks;
                document.getElementById('estimated-harvest-date').textContent = this.formatDateString(dryEndDate);
            }

            formatDateString(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            formatDate(date) {
                return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            handlePlantForm(e) {
                e.preventDefault();
                
                const plantData = {
                    name: document.getElementById('plant-name').value.trim(),
                    plantDate: document.getElementById('plant-date').value,
                    strain: document.getElementById('plant-strain').value.trim(),
                    species: document.getElementById('plant-species').value.trim(),
                    substrate: document.getElementById('plant-substrate').value.trim(),
                    lightOnTime: document.getElementById('plant-light-on').value || '08:00',
                    image: this.getPlantImageData()
                };

                // Collect growth phases data based on current mode
                if (this.currentPhaseMode === 'dates') {
                    plantData.growthPhases = {
                        useDates: true,
                        vegStartDate: document.getElementById('veg-start-date').value,
                        vegEndDate: document.getElementById('veg-end-date').value,
                        flowerStartDate: document.getElementById('flower-start-date').value,
                        flowerEndDate: document.getElementById('flower-end-date').value,
                        dryStartDate: document.getElementById('dry-start-date').value,
                        dryEndDate: document.getElementById('dry-end-date').value
                    };
                } else {
                    plantData.growthPhases = {
                        useDates: false,
                        vegetation: parseInt(document.getElementById('veg-duration').value) || 28,
                        flowering: parseInt(document.getElementById('flower-duration').value) || 63,
                        drying: parseInt(document.getElementById('dry-duration').value) || 10
                    };
                }

                // Debug: Log form elements
                console.log('Form elements values:', {
                    name: document.getElementById('plant-name').value,
                    date: document.getElementById('plant-date').value,
                    strain: document.getElementById('plant-strain').value,
                    species: document.getElementById('plant-species').value,
                    substrate: document.getElementById('plant-substrate').value,
                    lightOn: document.getElementById('plant-light-on').value
                });

                // Validation
                if (!plantData.name || !plantData.plantDate) {
                    alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–∞—Ç–∞ –ø–æ—Å–∞–¥–∫–∏');
                    return;
                }

                try {
                    console.log('Plant form data:', plantData);
                    console.log('Current plant ID:', this.currentPlantId);
                    console.log('Existing plants count:', Object.keys(this.data.plants).length);

                    if (this.currentPlantId) {
                        console.log('Updating existing plant:', this.currentPlantId);
                        this.updatePlant(this.currentPlantId, plantData);
                        // Update light phases based on new growth phases
                        this.updatePlantLightPhases(this.currentPlantId, plantData);
                    } else {
                        console.log('Creating new plant');
                        const plantId = this.createPlant(plantData);
                        console.log('Plant created with ID:', plantId);
                        
                        // Auto-select the new plant
                        this.data.settings.selectedPlant = plantId;
                        
                        // Create light phases for new plant
                        this.createPlantLightPhases(plantId, plantData);
                        console.log('Light phases created for new plant');
                    }

                    // Force save and re-render
                    this.saveData();
                    console.log('Data saved. Plants count:', Object.keys(this.data.plants).length);
                    console.log('All plant IDs:', Object.keys(this.data.plants));
                    
                    this.hidePlantModal();
                    this.renderUI();
                    
                    this.showNotification('‚úÖ –†–∞—Å—Ç–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                    console.log('Total light phases after plant creation/update:', Object.keys(this.data.lightPhases || {}).length);
                    
                } catch (error) {
                    console.error('Error saving plant:', error);
                    console.error('Error stack:', error.stack);
                    console.log('Data state during error:', {
                        plants: Object.keys(this.data.plants || {}),
                        lightPhases: Object.keys(this.data.lightPhases || {}),
                        currentPlantId: this.currentPlantId
                    });
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è: ' + error.message);
                }
            }

            getPlantImageData() {
                const imageInput = document.getElementById('plant-image');
                const imageUrlInput = document.getElementById('plant-image-url');
                const previewImg = document.getElementById('plant-preview-img');
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –∫–∞–∫ base64
                if (imageInput.files && imageInput.files[0]) {
                    return previewImg.src; // –£–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ data URL
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –µ–≥–æ
                if (imageUrlInput && imageUrlInput.value.trim() && previewImg.src === imageUrlInput.value.trim()) {
                    return imageUrlInput.value.trim();
                }
                
                // –ï—Å–ª–∏ –ø—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
                if (previewImg.src && previewImg.src !== '') {
                    return previewImg.src;
                }
                
                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
                return null;
            }

            showPlantImageModal(plantId) {
                const plant = this.data.plants[plantId];
                if (!plant || !plant.image) return;

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const modal = document.createElement('div');
                modal.id = 'plant-image-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-[90vh] bg-dark rounded-lg overflow-hidden">
                        <div class="flex items-center justify-between p-4 border-b border-gray-600">
                            <h3 class="text-lg font-semibold">üì∏ ${plant.name}</h3>
                            <button id="close-image-modal" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="p-4">
                            <img src="${plant.image}" alt="${plant.name}" class="w-full h-auto max-h-[70vh] object-contain rounded-lg">
                            <div class="mt-4 text-center text-gray-400 text-sm">
                                ${plant.strain ? `${plant.strain} ‚Ä¢ ` : ''}–î–µ–Ω—å ${this.getDaysSincePlanting(plant.id, new Date())} —Å –ø–æ—Å–∞–¥–∫–∏
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
                const closeBtn = modal.querySelector('#close-image-modal');
                const closeModal = () => {
                    modal.remove();
                };

                closeBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }

            showFertilizerImageModal(fertilizerId) {
                const fertilizer = this.data.fertilizers[fertilizerId];
                if (!fertilizer) return;

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
                const imageUrl = fertilizer.image || '1nsfSKxFu5LKDqP7zoRtP';

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–¥–æ–±—Ä–µ–Ω–∏—è
                const modal = document.createElement('div');
                modal.id = 'fertilizer-image-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-[90vh] bg-dark rounded-lg overflow-hidden">
                        <div class="flex items-center justify-between p-4 border-b border-gray-600">
                            <h3 class="text-lg font-semibold">üß™ ${fertilizer.name}</h3>
                            <button id="close-fertilizer-image-modal" class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="p-4">
                            <img src="${imageUrl}" alt="${fertilizer.name}" class="w-full h-auto max-h-[70vh] object-contain rounded-lg">
                            <div class="mt-4 space-y-2">
                                <!-- NPK –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                <div class="flex items-center justify-center gap-6 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-blue-400 rounded"></span>
                                        <span class="text-blue-400 font-medium">N: ${fertilizer.npk.n}%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-yellow-400 rounded"></span>
                                        <span class="text-yellow-400 font-medium">P: ${fertilizer.npk.p}%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 bg-purple-400 rounded"></span>
                                        <span class="text-purple-400 font-medium">K: ${fertilizer.npk.k}%</span>
                                    </div>
                                </div>
                                <div class="text-center text-gray-400 text-sm">
                                    –ü–ª–æ—Ç–Ω–æ—Å—Ç—å: ${fertilizer.density} –≥/–º–ª
                                    ${fertilizer.microElements ? ` ‚Ä¢ –ú–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç—ã: ${fertilizer.microElements}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
                const closeBtn = modal.querySelector('#close-fertilizer-image-modal');
                const closeModal = () => {
                    modal.remove();
                };

                closeBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }

            editPlant(plantId) {
                this.showPlantModal(plantId);
            }

            deletePlantConfirm(plantId) {
                const plant = this.data.plants[plantId];
                if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ "${plant.name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                    this.deletePlant(plantId);
                    this.renderUI();
                }
            }

            // Quick actions
            quickWater() {
                const plants = Object.values(this.data.plants);
                if (plants.length === 0) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏—è');
                    return;
                }
                this.showWateringModal();
            }

            quickFeed() {
                const plants = Object.values(this.data.plants);
                if (plants.length === 0) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏—è');
                    return;
                }
                alert('–ü–æ–¥–∫–æ—Ä–º–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π!');
            }

            // Fertilizer modal management
            showFertilizerModal(fertilizerId = null) {
                this.currentFertilizerId = fertilizerId;
                const modal = document.getElementById('fertilizer-modal');
                const title = document.getElementById('fertilizer-modal-title');
                const form = document.getElementById('fertilizer-form');
                
                if (fertilizerId) {
                    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏–µ';
                    const fertilizer = this.data.fertilizers[fertilizerId];
                    document.getElementById('fertilizer-name').value = fertilizer.name;
                    document.getElementById('fertilizer-n').value = fertilizer.npk.n;
                    document.getElementById('fertilizer-p').value = fertilizer.npk.p;
                    document.getElementById('fertilizer-k').value = fertilizer.npk.k;
                    document.getElementById('fertilizer-density').value = fertilizer.density;
                    document.getElementById('fertilizer-micro').value = fertilizer.microElements || '';
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (fertilizer.image) {
                        const previewContainer = document.getElementById('fertilizer-image-preview');
                        const previewImg = document.getElementById('fertilizer-preview-img');
                        const imageUrlInput = document.getElementById('fertilizer-image-url');
                        
                        previewImg.src = fertilizer.image;
                        previewContainer.classList.remove('hidden');
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ URL (–Ω–µ data URL), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –ø–æ–ª–µ URL
                        if (fertilizer.image.startsWith('http')) {
                            imageUrlInput.value = fertilizer.image;
                            this.switchFertilizerUploadMode('url');
                        } else {
                            // –≠—Ç–æ base64 –∏–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
                            this.switchFertilizerUploadMode('file');
                        }
                    } else {
                        document.getElementById('fertilizer-image-preview').classList.add('hidden');
                        this.switchFertilizerUploadMode('file');
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input —Ñ–∞–π–ª–∞
                    document.getElementById('fertilizer-image').value = '';
                } else {
                    title.textContent = '–î–æ–±–∞–≤–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏–µ';
                    form.reset();
                    document.getElementById('fertilizer-density').value = '1.0';
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    document.getElementById('fertilizer-image-preview').classList.add('hidden');
                }
                
                // Setup image handlers
                this.setupFertilizerImageHandlers();
                
                modal.classList.remove('hidden');
            }

            hideFertilizerModal() {
                document.getElementById('fertilizer-modal').classList.add('hidden');
                this.currentFertilizerId = null;
            }

            setupFertilizerImageHandlers() {
                const imageInput = document.getElementById('fertilizer-image');
                const imageUrlInput = document.getElementById('fertilizer-image-url');
                const previewContainer = document.getElementById('fertilizer-image-preview');
                const previewImg = document.getElementById('fertilizer-preview-img');
                const removeBtn = document.getElementById('remove-fertilizer-image');
                
                // Tab switching
                const fileBtn = document.getElementById('fertilizer-upload-file-btn');
                const urlBtn = document.getElementById('fertilizer-upload-url-btn');
                const loadUrlBtn = document.getElementById('load-fertilizer-image-url');

                fileBtn.addEventListener('click', () => this.switchFertilizerUploadMode('file'));
                urlBtn.addEventListener('click', () => this.switchFertilizerUploadMode('url'));

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
                        imageInput.value = '';
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                    if (!file.type.startsWith('image/')) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                        imageInput.value = '';
                        return;
                    }

                    // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                        // Clear URL input when file is loaded
                        if (imageUrlInput) imageUrlInput.value = '';
                    };
                    reader.readAsDataURL(file);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ URL
                if (loadUrlBtn) {
                    loadUrlBtn.addEventListener('click', () => this.loadFertilizerImageFromUrl());
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                removeBtn.addEventListener('click', () => {
                    imageInput.value = '';
                    if (imageUrlInput) imageUrlInput.value = '';
                    previewContainer.classList.add('hidden');
                    previewImg.src = '';
                });
            }

            switchFertilizerUploadMode(mode) {
                const fileBtn = document.getElementById('fertilizer-upload-file-btn');
                const urlBtn = document.getElementById('fertilizer-upload-url-btn');
                const fileUpload = document.getElementById('fertilizer-file-upload');
                const urlUpload = document.getElementById('fertilizer-url-upload');

                if (mode === 'file') {
                    fileBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    urlBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    fileUpload.classList.remove('hidden');
                    urlUpload.classList.add('hidden');
                } else {
                    fileBtn.className = 'px-3 py-1 bg-gray-700 text-white rounded text-sm';
                    urlBtn.className = 'px-3 py-1 bg-primary text-darker rounded text-sm font-medium';
                    fileUpload.classList.add('hidden');
                    urlUpload.classList.remove('hidden');
                }
            }

            async loadFertilizerImageFromUrl() {
                const imageUrlInput = document.getElementById('fertilizer-image-url');
                const previewContainer = document.getElementById('fertilizer-image-preview');
                const previewImg = document.getElementById('fertilizer-preview-img');
                const loadBtn = document.getElementById('load-fertilizer-image-url');
                
                const originalUrl = imageUrlInput.value.trim();
                if (!originalUrl) {
                    alert('–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    return;
                }

                // Normalize and validate URL
                const url = this.normalizeImageUrl(originalUrl);
                
                try {
                    new URL(url);
                } catch {
                    alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏.');
                    return;
                }

                // Check if URL looks like an image
                if (!this.isImageUrl(url)) {
                    const confirmMessage = 'URL –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n' +
                        '–î–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞:\n' +
                        '.jpg, .png, .webp, .gif\n\n' +
                        '–í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å?';
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                }

                // Show loading state
                loadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                loadBtn.disabled = true;

                try {
                    // Try to load image without CORS first (most permissive)
                    const testImg = new Image();
                    
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Timeout: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∑–∞ 10 —Å–µ–∫—É–Ω–¥'));
                        }, 10000);
                        
                        testImg.onload = () => {
                            clearTimeout(timeout);
                            resolve();
                        };
                        
                        testImg.onerror = () => {
                            clearTimeout(timeout);
                            reject(new Error('–ù–µ —É–¥–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                        };
                        
                        // Try without CORS first, then with
                        testImg.src = url;
                    });

                    // If successful, show preview
                    previewImg.src = url;
                    previewContainer.classList.remove('hidden');
                    
                    // Clear file input when URL is loaded
                    document.getElementById('fertilizer-image').value = '';
                    
                    // Show success message
                    this.showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
                    
                } catch (error) {
                    console.log('Image load error:', error);
                    
                    // More detailed error message
                    let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ.\n\n';
                    
                    if (error.message.includes('Timeout')) {
                        errorMessage += '‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏.\n';
                    } else {
                        errorMessage += '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n';
                    }
                    
                    errorMessage += '\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n';
                    errorMessage += '‚Ä¢ URL –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n';
                    errorMessage += '‚Ä¢ –°–µ—Ä–≤–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É (CORS)\n';
                    errorMessage += '‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–æ\n';
                    errorMessage += '‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n\n';
                    errorMessage += 'üîß –†–µ—à–µ–Ω–∏—è:\n';
                    errorMessage += '‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ (.jpg, .png, .webp)\n';
                    errorMessage += '‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ö–æ—Å—Ç–∏–Ω–≥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n';
                    errorMessage += '‚Ä¢ –°–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–§–∞–π–ª"';
                    
                    alert(errorMessage);
                } finally {
                    // Restore button state
                    loadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ';
                    loadBtn.disabled = false;
                }
            }

            getFertilizerImageData() {
                const imageInput = document.getElementById('fertilizer-image');
                const imageUrlInput = document.getElementById('fertilizer-image-url');
                const previewImg = document.getElementById('fertilizer-preview-img');
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –∫–∞–∫ base64
                if (imageInput.files && imageInput.files[0]) {
                    return previewImg.src; // –£–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ data URL
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –µ–≥–æ
                if (imageUrlInput.value.trim() && previewImg.src === imageUrlInput.value.trim()) {
                    return imageUrlInput.value.trim();
                }
                
                // –ï—Å–ª–∏ –ø—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
                if (previewImg.src && previewImg.src !== '') {
                    return previewImg.src;
                }
                
                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
                return null;
            }

            handleFertilizerForm(e) {
                e.preventDefault();
                const fertilizerData = {
                    name: document.getElementById('fertilizer-name').value,
                    npk: {
                        n: parseFloat(document.getElementById('fertilizer-n').value),
                        p: parseFloat(document.getElementById('fertilizer-p').value),
                        k: parseFloat(document.getElementById('fertilizer-k').value)
                    },
                    density: parseFloat(document.getElementById('fertilizer-density').value),
                    microElements: document.getElementById('fertilizer-micro').value,
                    image: this.getFertilizerImageData()
                };

                if (this.currentFertilizerId) {
                    this.data.fertilizers[this.currentFertilizerId] = {
                        ...this.data.fertilizers[this.currentFertilizerId],
                        ...fertilizerData
                    };
                } else {
                    const id = 'fertilizer-' + Date.now();
                    this.data.fertilizers[id] = { id, ...fertilizerData };
                }

                this.saveData();
                this.hideFertilizerModal();
                this.renderFertilizers();
            }

            editFertilizer(fertilizerId) {
                this.showFertilizerModal(fertilizerId);
            }

            deleteFertilizerConfirm(fertilizerId) {
                const fertilizer = this.data.fertilizers[fertilizerId];
                if (confirm(`–£–¥–∞–ª–∏—Ç—å —É–¥–æ–±—Ä–µ–Ω–∏–µ "${fertilizer.name}"?`)) {
                    delete this.data.fertilizers[fertilizerId];
                    this.saveData();
                    this.renderFertilizers();
                }
            }

            // Recipe modal management
            showRecipeModal(recipeId = null) {
                this.currentRecipeId = recipeId;
                const modal = document.getElementById('recipe-modal');
                const title = document.getElementById('recipe-modal-title');
                const form = document.getElementById('recipe-form');
                
                if (recipeId) {
                    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç';
                    const recipe = this.data.recipes[recipeId];
                    document.getElementById('recipe-name').value = recipe.name;
                    document.getElementById('recipe-volume').value = recipe.volume;
                    this.renderRecipeFertilizers(recipe.fertilizers);
                } else {
                    title.textContent = '–°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç';
                    form.reset();
                    document.getElementById('recipe-volume').value = '1';
                    this.renderRecipeFertilizers([]);
                }
                
                modal.classList.remove('hidden');
                this.updateRecipeTotals();
            }

            hideRecipeModal() {
                document.getElementById('recipe-modal').classList.add('hidden');
                this.currentRecipeId = null;
            }

            renderRecipeFertilizers(fertilizers = []) {
                const container = document.getElementById('recipe-fertilizers');
                container.innerHTML = '';
                
                fertilizers.forEach((fert, index) => {
                    this.addRecipeFertilizerRow(fert.fertilizerId, fert.dose, index);
                });
                
                // Add event listener for adding more fertilizers
                document.getElementById('add-recipe-fertilizer-btn').onclick = () => this.addRecipeFertilizerRow();
            }

            addRecipeFertilizerRow(fertilizerId = '', dose = 0, index = null) {
                const container = document.getElementById('recipe-fertilizers');
                const rowIndex = index !== null ? index : container.children.length;
                
                const row = document.createElement('div');
                row.className = 'flex gap-2 items-center';
                row.innerHTML = `
                    <select class="flex-1 bg-gray-700 text-white p-2 rounded" name="fertilizers[${rowIndex}][id]" onchange="app.updateRecipeTotals()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±—Ä–µ–Ω–∏–µ</option>
                        ${Object.values(this.data.fertilizers).map(f => 
                            `<option value="${f.id}" ${f.id === fertilizerId ? 'selected' : ''}>${f.name}</option>`
                        ).join('')}
                    </select>
                    <input type="number" step="0.1" min="0" value="${dose}" 
                           class="w-20 bg-gray-700 text-white p-2 rounded" 
                           name="fertilizers[${rowIndex}][dose]" placeholder="–º–ª/–ª"
                           onchange="app.updateRecipeTotals()">
                    <button type="button" onclick="this.parentElement.remove(); app.updateRecipeTotals();" 
                            class="p-2 bg-red-600 hover:bg-red-700 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                container.appendChild(row);
            }

            updateRecipeTotals() {
                const volume = parseFloat(document.getElementById('recipe-volume').value) || 1;
                const fertilizerRows = document.querySelectorAll('#recipe-fertilizers > div');
                let totals = { n: 0, p: 0, k: 0 };
                
                fertilizerRows.forEach(row => {
                    const fertilizerId = row.querySelector('select').value;
                    const dose = parseFloat(row.querySelector('input').value) || 0;
                    
                    if (fertilizerId && dose > 0) {
                        const fertilizer = this.data.fertilizers[fertilizerId];
                        if (fertilizer) {
                            totals.n += dose * fertilizer.density * fertilizer.npk.n * 10;
                            totals.p += dose * fertilizer.density * fertilizer.npk.p * 10;
                            totals.k += dose * fertilizer.density * fertilizer.npk.k * 10;
                        }
                    }
                });
                
                document.getElementById('recipe-totals').innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        <div><span class="text-blue-400 font-medium">N:</span> ${totals.n.toFixed(1)} –º–≥/–ª</div>
                        <div><span class="text-yellow-400 font-medium">P:</span> ${totals.p.toFixed(1)} –º–≥/–ª</div>
                        <div><span class="text-purple-400 font-medium">K:</span> ${totals.k.toFixed(1)} –º–≥/–ª</div>
                    </div>
                `;
            }

            handleRecipeForm(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                const recipeData = {
                    name: document.getElementById('recipe-name').value,
                    volume: parseFloat(document.getElementById('recipe-volume').value),
                    fertilizers: []
                };
                
                const fertilizerRows = document.querySelectorAll('#recipe-fertilizers > div');
                fertilizerRows.forEach(row => {
                    const fertilizerId = row.querySelector('select').value;
                    const dose = parseFloat(row.querySelector('input').value) || 0;
                    
                    if (fertilizerId && dose > 0) {
                        recipeData.fertilizers.push({ fertilizerId, dose });
                    }
                });

                if (this.currentRecipeId) {
                    this.data.recipes[this.currentRecipeId] = {
                        ...this.data.recipes[this.currentRecipeId],
                        ...recipeData
                    };
                } else {
                    const id = 'recipe-' + Date.now();
                    this.data.recipes[id] = { id, ...recipeData };
                }

                this.saveData();
                this.hideRecipeModal();
                this.renderRecipes();
            }

            editRecipe(recipeId) {
                this.showRecipeModal(recipeId);
            }

            deleteRecipeConfirm(recipeId) {
                const recipe = this.data.recipes[recipeId];
                if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç "${recipe.name}"?`)) {
                    delete this.data.recipes[recipeId];
                    this.saveData();
                    this.renderRecipes();
                }
            }

            // Watering modal management
            showWateringModal() {
                const modal = document.getElementById('watering-modal');
                
                // Set current date and time
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('watering-date').value = now.toISOString().slice(0, 16);
                
                // Render plants list
                this.renderWateringPlants();
                
                // Render recipes
                this.renderWateringRecipes();
                
                // Reset form
                document.getElementById('watering-volume').value = '5';
                document.getElementById('watering-notes').value = '';
                
                modal.classList.remove('hidden');
                this.updateWateringCalculation();
            }

            hideWateringModal() {
                document.getElementById('watering-modal').classList.add('hidden');
            }

            renderWateringPlants() {
                const container = document.getElementById('watering-plants');
                const plants = Object.values(this.data.plants);
                
                container.innerHTML = '';
                
                if (plants.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-sm">–ù–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π –¥–ª—è –ø–æ–ª–∏–≤–∞</div>';
                    return;
                }
                
                plants.forEach(plant => {
                    const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                    const daysSince = this.getDaysSincePlanting(plant.id, new Date());
                    
                    const plantCheckbox = document.createElement('label');
                    plantCheckbox.className = 'flex items-center gap-3 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-750 transition-colors';
                    plantCheckbox.innerHTML = `
                        <input type="checkbox" name="selected-plants" value="${plant.id}" 
                               class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2" 
                               onchange="app.updateWateringCalculation()" checked>
                        <div class="flex-1">
                            <div class="font-medium">${plant.name}</div>
                            <div class="text-sm text-gray-400">
                                –î–µ–Ω—å ${daysSince} ‚Ä¢ ${currentPhase ? this.getPhaseShortName(currentPhase.type) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ–∞–∑–∞'}
                                ${plant.strain ? ` ‚Ä¢ ${plant.strain}` : ''}
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${currentPhase ? this.getPhaseIcon(currentPhase.type) : '‚ùì'}
                        </div>
                    `;
                    container.appendChild(plantCheckbox);
                });
            }

            renderWateringRecipes() {
                const select = document.getElementById('watering-recipe');
                const recipes = Object.values(this.data.recipes);
                
                select.innerHTML = '<option value="">–¢–æ–ª—å–∫–æ –≤–æ–¥–∞</option>';
                
                recipes.forEach(recipe => {
                    const option = document.createElement('option');
                    option.value = recipe.id;
                    option.textContent = recipe.name;
                    select.appendChild(option);
                });
            }

            autoSelectRecipe() {
                const selectedPlants = this.getSelectedWateringPlants();
                if (selectedPlants.length === 0) {
                    return;
                }
                
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–∑—ã –∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π
                const plantAnalysis = selectedPlants.map(plant => {
                    const phase = this.getCurrentLightPhase(plant.id, new Date());
                    if (!phase) return null;
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–µ–¥–µ–ª—é –≤ —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑–µ
                    const phaseStartDate = new Date(phase.startDate);
                    const currentDate = new Date();
                    const daysSincePhaseStart = Math.floor((currentDate - phaseStartDate) / (1000 * 60 * 60 * 24)) + 1;
                    const weekInPhase = Math.ceil(daysSincePhaseStart / 7);
                    
                    return {
                        plant: plant,
                        phase: phase.type,
                        week: weekInPhase,
                        daysInPhase: daysSincePhaseStart
                    };
                }).filter(analysis => analysis !== null);
                
                if (plantAnalysis.length === 0) {
                    return;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º–∏–Ω–∏—Ä—É—é—â—É—é —Ñ–∞–∑—É –∏ —Å—Ä–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
                const phaseWeeks = {};
                plantAnalysis.forEach(analysis => {
                    if (!phaseWeeks[analysis.phase]) {
                        phaseWeeks[analysis.phase] = [];
                    }
                    phaseWeeks[analysis.phase].push(analysis.week);
                });
                
                // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—É—é —á–∞—Å—Ç—É—é —Ñ–∞–∑—É
                let dominantPhase = null;
                let maxPlants = 0;
                Object.keys(phaseWeeks).forEach(phase => {
                    if (phaseWeeks[phase].length > maxPlants) {
                        maxPlants = phaseWeeks[phase].length;
                        dominantPhase = phase;
                    }
                });
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é –¥–ª—è –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–π —Ñ–∞–∑—ã
                const averageWeek = Math.round(
                    phaseWeeks[dominantPhase].reduce((sum, week) => sum + week, 0) / 
                    phaseWeeks[dominantPhase].length
                );
                
                // –ü–æ–¥–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–µ—Ü–µ–ø—Ç
                let recommendedRecipe = null;
                const recipes = Object.values(this.data.recipes);
                
                if (dominantPhase === 'vegetation') {
                    // –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤–µ–≥–µ—Ç–∞—Ü–∏–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º
                    if (averageWeek === 1) {
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('–≤–µ–≥') && 
                            (r.name.includes('1') || r.name.toLowerCase().includes('–ø–µ—Ä–≤–∞—è'))
                        );
                    } else if (averageWeek === 2) {
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('–≤–µ–≥') && 
                            (r.name.includes('2') || r.name.toLowerCase().includes('–≤—Ç–æ—Ä–∞—è'))
                        );
                    } else if (averageWeek === 3) {
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('–≤–µ–≥') && 
                            (r.name.includes('3') || r.name.toLowerCase().includes('—Ç—Ä–µ—Ç—å—è'))
                        );
                    } else if (averageWeek >= 4) {
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('–≤–µ–≥') && 
                            (r.name.includes('4') || r.name.toLowerCase().includes('—á–µ—Ç–≤–µ—Ä—Ç–∞—è'))
                        );
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è, –±–µ—Ä–µ–º –ª—é–±–æ–π –≤–µ–≥–µ—Ç–∞—Ç–∏–≤–Ω—ã–π
                    if (!recommendedRecipe) {
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('–≤–µ–≥') || 
                            r.name.toLowerCase().includes('grow')
                        );
                    }
                    
                } else if (dominantPhase === 'flowering') {
                    // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ü–≤–µ—Ç–µ–Ω–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º
                    if (averageWeek <= 2) {
                        // 1-2 –Ω–µ–¥–µ–ª–∏ —Ü–≤–µ—Ç–µ–Ω–∏—è
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('—Ü–≤–µ—Ç') && 
                            (r.name.includes('1-2') || r.name.includes('1') || 
                             r.name.toLowerCase().includes('–Ω–∞—á–∞–ª') ||
                             r.name.toLowerCase().includes('–ø–µ—Ä–µ—Ö–æ–¥'))
                        );
                    } else if (averageWeek >= 3) {
                        // 3+ –Ω–µ–¥–µ–ª–∏ —Ü–≤–µ—Ç–µ–Ω–∏—è
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('—Ü–≤–µ—Ç') && 
                            (r.name.includes('3-8') || r.name.includes('3') || 
                             r.name.toLowerCase().includes('–æ—Å–Ω–æ–≤–Ω') ||
                             r.name.toLowerCase().includes('–∞–∫—Ç–∏–≤'))
                        );
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è, –±–µ—Ä–µ–º –ª—é–±–æ–π –¥–ª—è —Ü–≤–µ—Ç–µ–Ω–∏—è
                    if (!recommendedRecipe) {
                        recommendedRecipe = recipes.find(r => 
                            r.name.toLowerCase().includes('—Ü–≤–µ—Ç') || 
                            r.name.toLowerCase().includes('bloom')
                        );
                    }
                } else if (dominantPhase === 'drying') {
                    // –î–ª—è —Å—É—à–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ç–æ–ª—å–∫–æ –≤–æ–¥—É
                    document.getElementById('watering-recipe').value = '';
                    this.updateWateringCalculation();
                    return;
                }
                
                if (recommendedRecipe) {
                    document.getElementById('watering-recipe').value = recommendedRecipe.id;
                } else {
                    document.getElementById('watering-recipe').value = '';
                }
                
                this.updateWateringCalculation();
            }

            getSelectedWateringPlants() {
                const checkboxes = document.querySelectorAll('input[name="selected-plants"]:checked');
                return Array.from(checkboxes).map(checkbox => {
                    return this.data.plants[checkbox.value];
                }).filter(plant => plant);
            }

            updateWateringCalculation() {
                const recipeId = document.getElementById('watering-recipe').value;
                const volume = parseFloat(document.getElementById('watering-volume').value) || 1;
                
                const fertilizerAmountsContainer = document.getElementById('fertilizer-amounts');
                const nutrientValuesContainer = document.getElementById('nutrient-values');
                
                if (!recipeId) {
                    // –¢–æ–ª—å–∫–æ –≤–æ–¥–∞
                    fertilizerAmountsContainer.innerHTML = '<div class="text-gray-400 text-sm">–¢–æ–ª—å–∫–æ —á–∏—Å—Ç–∞—è –≤–æ–¥–∞, –±–µ–∑ —É–¥–æ–±—Ä–µ–Ω–∏–π</div>';
                    nutrientValuesContainer.innerHTML = `
                        <div><span class="text-blue-400 font-medium">N:</span> 0 –º–≥/–ª</div>
                        <div><span class="text-yellow-400 font-medium">P:</span> 0 –º–≥/–ª</div>
                        <div><span class="text-purple-400 font-medium">K:</span> 0 –º–≥/–ª</div>
                    `;
                    return;
                }
                
                const recipe = this.data.recipes[recipeId];
                if (!recipe) return;
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–¥–æ–±—Ä–µ–Ω–∏–π
                const fertilizers = [];
                let totalN = 0, totalP = 0, totalK = 0;
                
                recipe.fertilizers.forEach(fert => {
                    const fertilizer = this.data.fertilizers[fert.fertilizerId];
                    if (fertilizer) {
                        const totalAmount = (fert.dose * volume).toFixed(1);
                        fertilizers.push({
                            name: fertilizer.name,
                            amount: totalAmount,
                            unit: '–º–ª'
                        });
                        
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞
                        totalN += fert.dose * fertilizer.density * fertilizer.npk.n * 10;
                        totalP += fert.dose * fertilizer.density * fertilizer.npk.p * 10;
                        totalK += fert.dose * fertilizer.density * fertilizer.npk.k * 10;
                    }
                });
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–¥–æ–±—Ä–µ–Ω–∏–π
                fertilizerAmountsContainer.innerHTML = fertilizers.map(fert => `
                    <div class="flex justify-between items-center p-2 bg-gray-700 rounded">
                        <span class="font-medium">${fert.name}</span>
                        <span class="text-primary font-mono">${fert.amount} ${fert.unit}</span>
                    </div>
                `).join('');
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤
                nutrientValuesContainer.innerHTML = `
                    <div><span class="text-blue-400 font-medium">N:</span> ${totalN.toFixed(1)} –º–≥/–ª</div>
                    <div><span class="text-yellow-400 font-medium">P:</span> ${totalP.toFixed(1)} –º–≥/–ª</div>
                    <div><span class="text-purple-400 font-medium">K:</span> ${totalK.toFixed(1)} –º–≥/–ª</div>
                `;
            }

            handleWateringForm(e) {
                e.preventDefault();
                
                const selectedPlants = this.getSelectedWateringPlants();
                if (selectedPlants.length === 0) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ä–∞—Å—Ç–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–∏–≤–∞');
                    return;
                }
                
                const wateringData = {
                    date: document.getElementById('watering-date').value,
                    volume: parseFloat(document.getElementById('watering-volume').value),
                    recipeId: document.getElementById('watering-recipe').value || null,
                    plantIds: selectedPlants.map(plant => plant.id),
                    notes: document.getElementById('watering-notes').value,
                    createdAt: new Date().toISOString()
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–∏–≤ –≤ –∏—Å—Ç–æ—Ä–∏—é
                const wateringId = 'watering-' + Date.now();
                this.data.wateringHistory[wateringId] = {
                    id: wateringId,
                    ...wateringData
                };
                
                this.saveData();
                this.hideWateringModal();
                this.renderUI();
            }

            // Watering History Management
            deleteWateringConfirm(wateringId) {
                const watering = this.data.wateringHistory[wateringId];
                if (!watering) return;

                const time = new Date(watering.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const date = new Date(watering.date).toLocaleDateString('ru-RU');
                const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                const plantsNames = watering.plantIds.map(id => this.data.plants[id]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ').join(', ');
                
                const confirmMessage = `–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –ø–æ–ª–∏–≤–µ?\n\n` +
                    `üìÖ –î–∞—Ç–∞: ${date} –≤ ${time}\n` +
                    `üåø –†–∞—Å—Ç–µ–Ω–∏—è: ${plantsNames}\n` +
                    `üíß –û–±—ä–µ–º: ${watering.volume}–ª\n` +
                    `${recipe ? `üß™ –†–µ—Ü–µ–ø—Ç: ${recipe.name}\n` : 'üíß –¢–æ–ª—å–∫–æ –≤–æ–¥–∞\n'}` +
                    `${watering.notes ? `üìù –ó–∞–º–µ—Ç–∫–∏: ${watering.notes}\n` : ''}\n` +
                    `‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`;

                if (confirm(confirmMessage)) {
                    this.deleteWatering(wateringId);
                }
            }

            deleteWatering(wateringId) {
                delete this.data.wateringHistory[wateringId];
                this.saveData();
                this.renderUI();
                this.renderCalendar(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                
                alert('‚úÖ –ó–∞–ø–∏—Å—å –æ –ø–æ–ª–∏–≤–µ —É–¥–∞–ª–µ–Ω–∞');
            }

            // Settings Management
            showSettingsModal() {
                const modal = document.getElementById('settings-modal');
                
                // Load current settings
                document.getElementById('settings-app-title').value = this.data.settings.appTitle || 'Plant Care Pro';
                
                // Home Assistant settings
                const haSettings = this.data.settings.homeAssistant || {};
                document.getElementById('settings-ha-enabled').checked = haSettings.enabled || false;
                document.getElementById('settings-ha-url').value = haSettings.url || '';
                document.getElementById('settings-ha-token').value = haSettings.accessToken || '';
                document.getElementById('settings-ha-prefix').value = haSettings.entityPrefix || 'plant_care';
                
                // Show/hide Home Assistant settings
                this.toggleHomeAssistantSettings(haSettings.enabled || false);

                // Telegram settings
                const telegramSettings = this.data.settings.telegram || {};
                document.getElementById('settings-telegram-enabled').checked = telegramSettings.enabled || false;
                document.getElementById('settings-telegram-token').value = telegramSettings.botToken || '';
                document.getElementById('settings-telegram-chat-id').value = telegramSettings.chatId || '';
                
                // Telegram notification settings
                const notifications = telegramSettings.notifications || {};
                document.getElementById('settings-telegram-watering-reminders').checked = notifications.wateringReminders !== false;
                document.getElementById('settings-telegram-phase-changes').checked = notifications.phaseChanges !== false;
                document.getElementById('settings-telegram-daily-summary').checked = notifications.dailySummary || false;
                document.getElementById('settings-telegram-daily-time').value = notifications.dailyTime || '09:00';
                
                // Telegram auto backup settings
                const autoBackup = telegramSettings.autoBackup || {};
                document.getElementById('settings-telegram-auto-backup').checked = autoBackup.enabled || false;
                document.getElementById('settings-telegram-backup-frequency').value = autoBackup.frequency || 'weekly';
                document.getElementById('settings-telegram-backup-time').value = autoBackup.time || '02:00';
                
                // Show last backup time if available
                if (autoBackup.lastBackup) {
                    const lastBackup = new Date(autoBackup.lastBackup);
                    document.getElementById('last-telegram-backup-time').textContent = lastBackup.toLocaleString('ru-RU');
                }
                
                // Show/hide Telegram settings
                this.toggleTelegramSettings(telegramSettings.enabled || false);
                this.toggleDailySummaryTime(notifications.dailySummary || false);
                this.toggleAutoBackupTime(autoBackup.enabled || false);

                // Backup settings
                const backupSettings = this.data.settings.backup || {};
                document.getElementById('settings-auto-backup').checked = backupSettings.autoEnabled || false;
                document.getElementById('settings-backup-frequency').value = backupSettings.frequency || 'weekly';
                document.getElementById('settings-backup-keep').value = backupSettings.keepFiles || 10;
                
                // Show backup folder if set
                if (backupSettings.folderName) {
                    document.getElementById('settings-backup-folder').value = backupSettings.folderName;
                }
                
                // Show last backup time
                if (backupSettings.lastBackupTime) {
                    const lastBackup = new Date(backupSettings.lastBackupTime);
                    document.getElementById('last-backup-time').textContent = lastBackup.toLocaleString('ru-RU');
                }
                
                // Show/hide auto backup settings
                this.toggleAutoBackupSettings(backupSettings.autoEnabled || false);
                
                // Update stats
                this.updateSettingsStats();
                
                modal.classList.remove('hidden');
            }

            hideSettingsModal() {
                document.getElementById('settings-modal').classList.add('hidden');
            }

            toggleHomeAssistantSettings(enabled) {
                const content = document.getElementById('ha-settings-content');
                if (enabled) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            }

            toggleTelegramSettings(enabled) {
                const content = document.getElementById('telegram-settings-content');
                if (content) {
                    if (enabled) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                }
            }

            getPhaseDisplayName(type) {
                switch (type) {
                    case 'vegetation': return '–í–µ–≥–µ—Ç–∞—Ü–∏—è';
                    case 'flowering': return '–¶–≤–µ—Ç–µ–Ω–∏–µ';
                    case 'drying': return '–°—É—à–∫–∞';
                    default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                }
            }

            getPhaseShortName(type) {
                switch (type) {
                    case 'vegetation': return '–í–µ–≥–µ—Ç–∞—Ü–∏—è';
                    case 'flowering': return '–¶–≤–µ—Ç–µ–Ω–∏–µ';
                    case 'drying': return '–°—É—à–∫–∞';
                    default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                }
            }

            getPhaseIcon(type) {
                switch (type) {
                    case 'vegetation': return 'üå±';
                    case 'flowering': return 'üå∏';
                    case 'drying': return 'üçÇ';
                    default: return '‚ùì';
                }
            }

            isPlantActive(plant) {
                if (!plant) return false;
                
                const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                
                if (currentPhase) {
                    if (currentPhase.type === 'drying') {
                        const daysSince = this.getDaysSincePlanting(plant.id, new Date());
                        const totalVegFlower = (plant.growthPhases?.vegetation || 28) + (plant.growthPhases?.flowering || 63);
                        const dryingDays = plant.growthPhases?.drying || 10;
                        
                        return daysSince < (totalVegFlower + dryingDays);
                    }
                    return true;
                }
                
                return true;
            }

            getLastWateringDate(plantId) {
                const waterings = Object.values(this.data.wateringHistory || {})
                    .filter(w => w.plantIds && w.plantIds.includes(plantId))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                return waterings.length > 0 ? waterings[0].date : null;
            }

            getDaysSinceLastWatering(plantId) {
                const lastWatering = this.getLastWateringDate(plantId);
                if (!lastWatering) return 999;
                
                return Math.floor((new Date() - new Date(lastWatering)) / (1000 * 60 * 60 * 24));
            }

            needsWatering(plantId) {
                const lastWatering = this.getLastWateringDate(plantId);
                if (!lastWatering) return true;

                const daysSince = Math.floor((new Date() - new Date(lastWatering)) / (1000 * 60 * 60 * 24));
                const currentPhase = this.getCurrentLightPhase(plantId, new Date());
                
                if (currentPhase && currentPhase.type === 'drying') {
                    return false; // No watering during drying phase
                }
                
                return daysSince >= 3; // Default 3 days
            }

            handleSettingsForm(e) {
                e.preventDefault();
                
                // Save general settings
                const newTitle = document.getElementById('settings-app-title').value;
                this.data.settings.appTitle = newTitle;
                
                // Save Home Assistant settings
                this.data.settings.homeAssistant = {
                    enabled: document.getElementById('settings-ha-enabled').checked,
                    url: document.getElementById('settings-ha-url').value.trim(),
                    accessToken: document.getElementById('settings-ha-token').value.trim(),
                    entityPrefix: document.getElementById('settings-ha-prefix').value.trim() || 'plant_care'
                };

                // Save Telegram settings
                this.data.settings.telegram = {
                    enabled: document.getElementById('settings-telegram-enabled').checked,
                    botToken: document.getElementById('settings-telegram-token').value.trim(),
                    chatId: document.getElementById('settings-telegram-chat-id').value.trim(),
                    notifications: {
                        wateringReminders: document.getElementById('settings-telegram-watering-reminders').checked,
                        phaseChanges: document.getElementById('settings-telegram-phase-changes').checked,
                        dailySummary: document.getElementById('settings-telegram-daily-summary').checked,
                        dailyTime: document.getElementById('settings-telegram-daily-time').value || '09:00'
                    },
                    autoBackup: {
                        enabled: document.getElementById('settings-telegram-auto-backup').checked,
                        frequency: document.getElementById('settings-telegram-backup-frequency').value || 'weekly',
                        time: document.getElementById('settings-telegram-backup-time').value || '02:00',
                        lastBackup: this.data.settings.telegram?.autoBackup?.lastBackup || null
                    },
                    lastDailySummary: this.data.settings.telegram?.lastDailySummary || null
                };

                // Save backup settings
                this.data.settings.backup = {
                    ...this.data.settings.backup,
                    autoEnabled: document.getElementById('settings-auto-backup').checked,
                    frequency: document.getElementById('settings-backup-frequency').value,
                    keepFiles: parseInt(document.getElementById('settings-backup-keep').value) || 10
                };
                
                this.saveData();
                this.hideSettingsModal();
                this.updateAppTitle();
                
                // Setup auto backup if enabled
                if (this.data.settings.backup.autoEnabled) {
                    this.setupAutoBackup();
                }
                

                
                // Setup Telegram notifications if enabled
                if (this.data.settings.telegram.enabled) {
                    this.setupTelegramNotifications();
                }
                
                // Show success message
                this.showNotification('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }

            toggleAutoBackupSettings(enabled) {
                const content = document.getElementById('auto-backup-settings');
                if (enabled) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            }

            // File System Access API methods
            async selectBackupFolder() {
                if (!('showDirectoryPicker' in window)) {
                    alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–∞–ø–æ–∫.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge 86+ –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä.');
                    return;
                }

                try {
                    const directoryHandle = await window.showDirectoryPicker({
                        mode: 'readwrite'
                    });

                    // Store folder handle and name
                    this.backupFolderHandle = directoryHandle;
                    this.data.settings.backup.folderName = directoryHandle.name;
                    
                    // Update UI
                    document.getElementById('settings-backup-folder').value = directoryHandle.name;
                    
                    this.showNotification('‚úÖ –ü–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –≤—ã–±—Ä–∞–Ω–∞', 'success');
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Error selecting folder:', error);
                        this.showNotification('‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏', 'error');
                    }
                }
            }





            async backupToFolder() {
                if (!('showDirectoryPicker' in window)) {
                    alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–ø–∫–∏.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge 86+ –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä.\n\n–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞.');
                    return;
                }

                try {
                    let directoryHandle = this.backupFolderHandle;
                    
                    // If no folder selected, ask user to select one
                    if (!directoryHandle) {
                        directoryHandle = await window.showDirectoryPicker({
                            mode: 'readwrite'
                        });
                        this.backupFolderHandle = directoryHandle;
                        this.data.settings.backup.folderName = directoryHandle.name;
                    }

                    // Generate filename with timestamp
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    const filename = `plant-care-backup-${timestamp}.json`;

                    // Create file in the selected folder
                    const fileHandle = await directoryHandle.getFileHandle(filename, {
                        create: true
                    });

                    // Write data to file
                    const writable = await fileHandle.createWritable();
                    const dataStr = JSON.stringify(this.data, null, 2);
                    await writable.write(dataStr);
                    await writable.close();

                    // Update last backup time
                    this.data.settings.backup.lastBackupTime = now.toISOString();
                    this.saveData();

                    // Clean up old backups if enabled
                    await this.cleanupOldBackups(directoryHandle);

                    this.showNotification(`‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${filename}`, 'success');

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Error creating backup:', error);
                        this.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞', 'error');
                    }
                }
            }

            async cleanupOldBackups(directoryHandle) {
                try {
                    const keepFiles = this.data.settings.backup.keepFiles || 10;
                    const backupFiles = [];

                    // Collect all backup files
                    for await (const [name, handle] of directoryHandle.entries()) {
                        if (handle.kind === 'file' && name.startsWith('plant-care-backup-') && name.endsWith('.json')) {
                            const file = await handle.getFile();
                            backupFiles.push({
                                name: name,
                                handle: handle,
                                lastModified: file.lastModified
                            });
                        }
                    }

                    // Sort by date (newest first) and remove excess files
                    backupFiles.sort((a, b) => b.lastModified - a.lastModified);
                    
                    if (backupFiles.length > keepFiles) {
                        const filesToDelete = backupFiles.slice(keepFiles);
                        
                        for (const fileToDelete of filesToDelete) {
                            await directoryHandle.removeEntry(fileToDelete.name);
                        }
                        
                        console.log(`Cleaned up ${filesToDelete.length} old backup files`);
                    }
                } catch (error) {
                    console.error('Error cleaning up backups:', error);
                    // Don't show error to user as this is not critical
                }
            }





            async restoreFromFolder() {
                if (!('showDirectoryPicker' in window)) {
                    alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–∞–ø–æ–∫.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge 86+ –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä.\n\n–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–π –∏–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞.');
                    return;
                }

                try {
                    let directoryHandle = this.backupFolderHandle;
                    
                    // If no folder selected, ask user to select one
                    if (!directoryHandle) {
                        directoryHandle = await window.showDirectoryPicker({
                            mode: 'read'
                        });
                    }

                    // Collect all backup files
                    const backupFiles = [];
                    for await (const [name, handle] of directoryHandle.entries()) {
                        if (handle.kind === 'file' && name.startsWith('plant-care-backup-') && name.endsWith('.json')) {
                            const file = await handle.getFile();
                            backupFiles.push({
                                name: name,
                                handle: handle,
                                lastModified: file.lastModified,
                                size: file.size
                            });
                        }
                    }

                    if (backupFiles.length === 0) {
                        this.showNotification('‚ùå –í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –±—ç–∫–∞–ø–∞', 'error');
                        return;
                    }

                    // Sort by date (newest first)
                    backupFiles.sort((a, b) => b.lastModified - a.lastModified);

                    // Create selection dialog
                    const fileOptions = backupFiles.map((file, index) => {
                        const date = new Date(file.lastModified).toLocaleString('ru-RU');
                        const size = Math.round(file.size / 1024);
                        return `${index}: ${file.name} (${date}, ${size}–ö–ë)`;
                    }).join('\n');

                    const selection = prompt(
                        `–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:\n\n${fileOptions}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ñ–∞–π–ª–∞ (0-${backupFiles.length-1}):`
                    );

                    if (selection === null) return; // User cancelled

                    const selectedIndex = parseInt(selection);
                    if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= backupFiles.length) {
                        this.showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ñ–∞–π–ª–∞', 'error');
                        return;
                    }

                    // Read selected backup file
                    const selectedFile = backupFiles[selectedIndex];
                    const file = await selectedFile.handle.getFile();
                    const content = await file.text();
                    const importedData = JSON.parse(content);

                    // Validate and confirm import (reuse existing validation)
                    if (!importedData.plants || !importedData.settings) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }

                    const plantsCount = Object.keys(importedData.plants).length;
                    const wateringsCount = Object.keys(importedData.wateringHistory || {}).length;
                    
                    const confirmMessage = `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—ç–∫–∞–ø–∞?\n\n` +
                        `üìÅ –§–∞–π–ª: ${selectedFile.name}\n` +
                        `üìÖ –î–∞—Ç–∞: ${new Date(selectedFile.lastModified).toLocaleString('ru-RU')}\n\n` +
                        `üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:\n` +
                        `‚Ä¢ –†–∞—Å—Ç–µ–Ω–∏–π: ${plantsCount}\n` +
                        `‚Ä¢ –ó–∞–ø–∏—Å–µ–π –ø–æ–ª–∏–≤–æ–≤: ${wateringsCount}\n` +
                        `‚Ä¢ –£–¥–æ–±—Ä–µ–Ω–∏–π: ${Object.keys(importedData.fertilizers || {}).length}\n` +
                        `‚Ä¢ –†–µ—Ü–µ–ø—Ç–æ–≤: ${Object.keys(importedData.recipes || {}).length}\n\n` +
                        `‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!`;

                    if (confirm(confirmMessage)) {
                        // Preserve current settings if not in import
                        if (this.data.settings.appTitle && !importedData.settings.appTitle) {
                            importedData.settings.appTitle = this.data.settings.appTitle;
                        }
                        if (this.data.settings.homeAssistant && !importedData.settings.homeAssistant) {
                            importedData.settings.homeAssistant = this.data.settings.homeAssistant;
                        }
                        if (this.data.settings.backup && !importedData.settings.backup) {
                            importedData.settings.backup = this.data.settings.backup;
                        }

                        this.data = importedData;
                        this.data.settings.currentDate = new Date(this.data.settings.currentDate || new Date());
                        this.saveData();

                        // Reinitialize
                        this.initializePlantPhases();
                        this.renderUI();

                        this.showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –±—ç–∫–∞–ø–∞', 'success');
                    }

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Error restoring backup:', error);
                        this.showNotification(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`, 'error');
                    }
                }
            }

            setupAutoBackup() {
                // Clear existing timer
                if (this.autoBackupTimer) {
                    clearInterval(this.autoBackupTimer);
                }

                const backupSettings = this.data.settings.backup;
                if (!backupSettings.autoEnabled || !this.backupFolderHandle) {
                    return;
                }

                // Calculate interval in milliseconds
                let interval;
                switch (backupSettings.frequency) {
                    case 'daily':
                        interval = 24 * 60 * 60 * 1000; // 24 hours
                        break;
                    case 'weekly':
                        interval = 7 * 24 * 60 * 60 * 1000; // 7 days
                        break;
                    case 'monthly':
                        interval = 30 * 24 * 60 * 60 * 1000; // 30 days
                        break;
                    default:
                        interval = 7 * 24 * 60 * 60 * 1000; // Default to weekly
                }

                // Check if backup is needed now
                const lastBackup = backupSettings.lastBackupTime ? new Date(backupSettings.lastBackupTime) : new Date(0);
                const now = new Date();
                
                if (now - lastBackup >= interval) {
                    // Perform immediate backup
                    setTimeout(() => this.performAutoBackup(), 5000); // Wait 5 seconds after app start
                }

                // Set up recurring backup
                this.autoBackupTimer = setInterval(() => {
                    this.performAutoBackup();
                }, interval);
            }

            async performAutoBackup() {
                try {
                    if (!this.backupFolderHandle) {
                        console.log('No backup folder configured for auto backup');
                        return;
                    }

                    // Generate filename with timestamp
                    const now = new Date();
                    const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    const filename = `plant-care-auto-backup-${timestamp}.json`;

                    // Create file in the selected folder
                    const fileHandle = await this.backupFolderHandle.getFileHandle(filename, {
                        create: true
                    });

                    // Write data to file
                    const writable = await fileHandle.createWritable();
                    const dataStr = JSON.stringify(this.data, null, 2);
                    await writable.write(dataStr);
                    await writable.close();

                    // Update last backup time
                    this.data.settings.backup.lastBackupTime = now.toISOString();
                    this.saveData();

                    // Clean up old backups
                    await this.cleanupOldBackups(this.backupFolderHandle);

                    console.log(`Auto backup created: ${filename}`);

                } catch (error) {
                    console.error('Error performing auto backup:', error);
                }
            }

            updateSettingsStats() {
                const plantsCount = Object.keys(this.data.plants).length;
                const wateringsCount = Object.keys(this.data.wateringHistory).length;
                const dataSize = Math.round(JSON.stringify(this.data).length / 1024);
                
                document.getElementById('stats-plants-count').textContent = plantsCount;
                document.getElementById('stats-waterings-count').textContent = wateringsCount;
                document.getElementById('stats-data-size').textContent = `${dataSize} –ö–ë`;
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
                    type === 'success' ? 'bg-green-600' : 
                    type === 'error' ? 'bg-red-600' : 
                    type === 'warning' ? 'bg-yellow-600' : 
                    'bg-blue-600'
                } text-white font-medium`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Animate out and remove
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            async testHomeAssistantConnection() {
                const statusDiv = document.getElementById('ha-connection-status');
                const url = document.getElementById('settings-ha-url').value.trim();
                const token = document.getElementById('settings-ha-token').value.trim();
                
                if (!url || !token) {
                    this.showConnectionStatus('error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ URL –∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞');
                    return;
                }
                
                this.showConnectionStatus('loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
                
                try {
                    const response = await fetch(`${url}/api/`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.showConnectionStatus('success', `‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å Home Assistant ${data.version || 'Unknown'}`);
                    } else {
                        this.showConnectionStatus('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    this.showConnectionStatus('error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
                }
            }

            showConnectionStatus(type, message) {
                const statusDiv = document.getElementById('ha-connection-status');
                statusDiv.className = `p-3 rounded-lg text-sm ${
                    type === 'success' ? 'bg-green-600/20 border border-green-600/30 text-green-400' :
                    type === 'error' ? 'bg-red-600/20 border border-red-600/30 text-red-400' :
                    'bg-blue-600/20 border border-blue-600/30 text-blue-400'
                }`;
                statusDiv.textContent = message;
                statusDiv.classList.remove('hidden');
                
                if (type !== 'loading') {
                    setTimeout(() => statusDiv.classList.add('hidden'), 5000);
                }
            }

            async syncHomeAssistantEntities() {
                const haSettings = this.data.settings.homeAssistant;
                
                if (!haSettings.enabled || !haSettings.url || !haSettings.accessToken) {
                    this.showNotification('‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Home Assistant –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π', 'warning');
                    return;
                }
                
                this.showConnectionStatus('loading', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π...');
                
                try {
                    const plants = Object.values(this.data.plants);
                    const prefix = haSettings.entityPrefix;
                    let createdCount = 0;
                    
                    // Create sensor for each plant
                    for (const plant of plants) {
                        const plantSlug = plant.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                        const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                        const daysSince = this.getDaysSincePlanting(plant.id, new Date());
                        
                        // Create phase sensor
                        await this.createHomeAssistantSensor(
                            `${prefix}_${plantSlug}_phase`,
                            currentPhase ? this.getPhaseDisplayName(currentPhase.type) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                            {
                                'friendly_name': `${plant.name} - –§–∞–∑–∞ —Ä–æ—Å—Ç–∞`,
                                'device_class': 'enum',
                                'icon': 'mdi:sprout'
                            }
                        );
                        
                        // Create day sensor
                        await this.createHomeAssistantSensor(
                            `${prefix}_${plantSlug}_day`,
                            daysSince,
                            {
                                'friendly_name': `${plant.name} - –î–µ–Ω—å —Å –ø–æ—Å–∞–¥–∫–∏`,
                                'unit_of_measurement': '–¥–Ω–µ–π',
                                'icon': 'mdi:calendar'
                            }
                        );
                        
                        createdCount += 2;
                    }
                    
                    // Create total plants sensor
                    await this.createHomeAssistantSensor(
                        `${prefix}_total_plants`,
                        plants.length,
                        {
                            'friendly_name': '–í—Å–µ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏–π',
                            'unit_of_measurement': '—à—Ç',
                            'icon': 'mdi:sprout-outline'
                        }
                    );
                    
                    createdCount++;
                    
                    this.showConnectionStatus('success', `‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${createdCount} —Å—É—â–Ω–æ—Å—Ç–µ–π —Å Home Assistant`);
                } catch (error) {
                    this.showConnectionStatus('error', `‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                }
            }

            async createHomeAssistantSensor(entityId, state, attributes = {}) {
                const haSettings = this.data.settings.homeAssistant;
                
                try {
                    const response = await fetch(`${haSettings.url}/api/states/sensor.${entityId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${haSettings.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            state: state,
                            attributes: attributes
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Failed to create sensor ${entityId}:`, error);
                    throw error;
                }
            }

            // Telegram Integration Methods
            async sendTelegramMessage(message) {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.botToken || !telegramSettings.chatId) {
                    console.log('Telegram not configured, skipping message');
                    return false;
                }

                try {
                    const response = await fetch(`https://api.telegram.org/bot${telegramSettings.botToken}/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: telegramSettings.chatId,
                            text: message,
                            parse_mode: 'HTML',
                            disable_web_page_preview: true
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.description || `HTTP ${response.status}`);
                    }

                    return true;
                } catch (error) {
                    console.error('Failed to send Telegram message:', error);
                    return false;
                }
            }

            async testTelegramConnection() {
                const statusDiv = document.getElementById('telegram-connection-status');
                const token = document.getElementById('settings-telegram-token').value.trim();
                const chatId = document.getElementById('settings-telegram-chat-id').value.trim();
                
                if (!token || !chatId) {
                    this.showTelegramStatus('error', '‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ Chat ID');
                    return;
                }
                
                this.showTelegramStatus('loading', '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...');
                
                try {
                    const testMessage = `üß™ <b>–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b>\n\n` +
                        `‚úÖ Telegram –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Plant Care Pro!\n` +
                        `üìÖ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}\n` +
                        `üåø –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –≤–∞—à–∏—Ö —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö.`;

                    const response = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: testMessage,
                            parse_mode: 'HTML',
                            disable_web_page_preview: true
                        })
                    });

                    if (response.ok) {
                        this.showTelegramStatus('success', '‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    } else {
                        const error = await response.json();
                        this.showTelegramStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${error.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    }
                } catch (error) {
                    this.showTelegramStatus('error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
                }
            }

            async getTelegramChatId() {
                const token = document.getElementById('settings-telegram-token').value.trim();
                
                if (!token) {
                    this.showTelegramStatus('error', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
                    return;
                }
                
                this.showTelegramStatus('loading', '‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞...');
                
                try {
                    const response = await fetch(`https://api.telegram.org/bot${token}/getUpdates?limit=1&offset=-1`);
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.description || '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω');
                    }
                    
                    const data = await response.json();
                    
                    if (data.result && data.result.length > 0) {
                        const chatId = data.result[0].message?.chat?.id || data.result[0].message?.from?.id;
                        
                        if (chatId) {
                            document.getElementById('settings-telegram-chat-id').value = chatId;
                            this.showTelegramStatus('success', `‚úÖ Chat ID –ø–æ–ª—É—á–µ–Ω: ${chatId}\n\n–¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏`);
                        } else {
                            this.showTelegramStatus('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ Chat ID.\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –±–æ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        }
                    } else {
                        this.showTelegramStatus('error', '‚ùå –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞.\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start —Å–≤–æ–µ–º—É –±–æ—Ç—É –≤ Telegram –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                } catch (error) {
                    this.showTelegramStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                }
            }

            async sendPlantStatusToTelegram() {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.botToken || !telegramSettings.chatId) {
                    this.showTelegramStatus('error', '‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é');
                    return;
                }

                this.showTelegramStatus('loading', 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π...');

                const plants = Object.values(this.data.plants);
                
                if (plants.length === 0) {
                    this.showTelegramStatus('error', '‚ùå –ù–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                    return;
                }

                let message = `üåø <b>–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Ç–µ–Ω–∏–π</b>\n`;
                message += `üìÖ ${new Date().toLocaleDateString('ru-RU', { 
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric' 
                })}\n\n`;

                let activePlantsCount = 0;
                let plantsNeedingWater = 0;

                plants.forEach((plant, index) => {
                    const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                    const daysSince = this.getDaysSincePlanting(plant.id, new Date());
                    const needsWatering = this.needsWatering(plant.id);
                    const daysSinceWatering = this.getDaysSinceLastWatering(plant.id);
                    const isActive = this.isPlantActive(plant);

                    if (isActive) activePlantsCount++;
                    if (needsWatering) plantsNeedingWater++;

                    const phaseIcon = this.getPhaseIcon(currentPhase?.type || 'unknown');
                    const statusIcon = needsWatering ? 'üíß' : isActive ? 'üü¢' : 'üî¥';

                    message += `${statusIcon} <b>${plant.name}</b>\n`;
                    if (plant.strain) message += `   üß¨ ${plant.strain}\n`;
                    message += `   üìÖ –î–µ–Ω—å ${daysSince} —Å –ø–æ—Å–∞–¥–∫–∏\n`;
                    message += `   ${phaseIcon} ${this.getPhaseDisplayName(currentPhase?.type || 'unknown')}\n`;
                    
                    if (needsWatering) {
                        message += `   ‚ö†Ô∏è <b>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–∏–≤!</b> (${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥)\n`;
                    } else if (daysSinceWatering <= 1) {
                        message += `   ‚úÖ –ù–µ–¥–∞–≤–Ω–æ –ø–æ–ª–∏—Ç–æ (${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥)\n`;
                    } else {
                        message += `   üíß –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥\n`;
                    }
                    
                    message += '\n';
                });

                // Summary
                message += `üìä <b>–°–≤–æ–¥–∫–∞:</b>\n`;
                message += `‚Ä¢ –í—Å–µ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏–π: ${plants.length}\n`;
                message += `‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activePlantsCount}\n`;
                message += `‚Ä¢ –¢—Ä–µ–±—É—é—Ç –ø–æ–ª–∏–≤–∞: ${plantsNeedingWater}\n`;

                if (plantsNeedingWater > 0) {
                    message += `\n‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> ${plantsNeedingWater} —Ä–∞—Å—Ç–µ–Ω–∏${plantsNeedingWater === 1 ? '–µ —Ç—Ä–µ–±—É–µ—Ç' : plantsNeedingWater < 5 ? '—è —Ç—Ä–µ–±—É—é—Ç' : '–π —Ç—Ä–µ–±—É—é—Ç'} –ø–æ–ª–∏–≤–∞!`;
                }

                const success = await this.sendTelegramMessage(message);
                
                if (success) {
                    this.showTelegramStatus('success', '‚úÖ –°—Ç–∞—Ç—É—Å —Ä–∞—Å—Ç–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
                } else {
                    this.showTelegramStatus('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }
            }

            showTelegramStatus(type, message) {
                const statusDiv = document.getElementById('telegram-connection-status');
                statusDiv.className = `p-3 rounded-lg text-sm whitespace-pre-line ${
                    type === 'success' ? 'bg-green-600/20 border border-green-600/30 text-green-400' :
                    type === 'error' ? 'bg-red-600/20 border border-red-600/30 text-red-400' :
                    'bg-blue-600/20 border border-blue-600/30 text-blue-400'
                }`;
                statusDiv.textContent = message;
                statusDiv.classList.remove('hidden');
                
                if (type !== 'loading') {
                    setTimeout(() => statusDiv.classList.add('hidden'), 8000);
                }
            }

            // Notification triggers
            async notifyWateringNeeded(plantIds) {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.wateringReminders) {
                    return;
                }

                const plants = plantIds.map(id => this.data.plants[id]).filter(plant => plant);
                
                if (plants.length === 0) return;

                let message = `üíß <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–ª–∏–≤–µ</b>\n\n`;
                
                plants.forEach(plant => {
                    const daysSinceWatering = this.getDaysSinceLastWatering(plant.id);
                    const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                    
                    message += `üåø <b>${plant.name}</b>\n`;
                    message += `   ${this.getPhaseIcon(currentPhase?.type || 'unknown')} ${this.getPhaseShortName(currentPhase?.type || 'unknown')}\n`;
                    message += `   ‚è∞ ${daysSinceWatering} –¥–Ω. –±–µ–∑ –ø–æ–ª–∏–≤–∞\n\n`;
                });

                message += `üéØ <i>–û—Ç–∫—Ä–æ–π—Ç–µ Plant Care Pro –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª–∏–≤–∞</i>`;

                await this.sendTelegramMessage(message);
            }

            async notifyPhaseChange(plantId, newPhase) {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.phaseChanges) {
                    return;
                }

                const plant = this.data.plants[plantId];
                if (!plant) return;

                const phaseIcon = this.getPhaseIcon(newPhase.type);
                const phaseName = this.getPhaseDisplayName(newPhase.type);

                let message = `üîÑ <b>–°–º–µ–Ω–∞ —Ñ–∞–∑—ã —Ä–æ—Å—Ç–∞</b>\n\n`;
                message += `üåø <b>${plant.name}</b>\n`;
                message += `${phaseIcon} –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ñ–∞–∑—É: <b>${phaseName}</b>\n`;
                message += `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n`;

                // Recommendations based on phase
                if (newPhase.type === 'flowering') {
                    message += `\nüí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n`;
                    message += `‚Ä¢ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Å–≤–µ—Ç–æ–≤–æ–π —Ä–µ–∂–∏–º –Ω–∞ 12/12\n`;
                    message += `‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –¥–ª—è —Ü–≤–µ—Ç–µ–Ω–∏—è\n`;
                    message += `‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç—å—é`;
                } else if (newPhase.type === 'drying') {
                    message += `\nüí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n`;
                    message += `‚Ä¢ –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ –ø–æ–ª–∏–≤\n`;
                    message += `‚Ä¢ –í—ã–∫–ª—é—á–∏—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ\n`;
                    message += `‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É 18-22¬∞C`;
                }

                await this.sendTelegramMessage(message);
            }

            async sendDailySummary() {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.dailySummary) {
                    return;
                }

                // Check if summary was already sent today
                const today = new Date().toDateString();
                const lastSummary = telegramSettings.lastDailySummary;
                
                if (lastSummary && new Date(lastSummary).toDateString() === today) {
                    return; // Already sent today
                }

                const plants = Object.values(this.data.plants);
                
                if (plants.length === 0) return;

                let message = `üåÖ <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞</b>\n`;
                message += `üìÖ ${new Date().toLocaleDateString('ru-RU', { 
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long' 
                })}\n\n`;

                let activePlants = 0;
                let plantsNeedingWater = 0;
                let plantsWateredToday = 0;

                // Check today's waterings
                const todayStr = this.getLocalDateString(new Date());
                const todayWaterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = this.getLocalDateString(new Date(watering.date));
                    return wateringDate === todayStr;
                });

                const wateredPlantIds = new Set();
                todayWaterings.forEach(watering => {
                    watering.plantIds.forEach(id => wateredPlantIds.add(id));
                });

                plantsWateredToday = wateredPlantIds.size;

                plants.forEach(plant => {
                    const isActive = this.isPlantActive(plant);
                    const needsWatering = this.needsWatering(plant.id);
                    
                    if (isActive) activePlants++;
                    if (needsWatering) plantsNeedingWater++;
                });

                message += `üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n`;
                message += `‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π: ${activePlants}/${plants.length}\n`;
                message += `‚Ä¢ –ü–æ–ª–∏—Ç–æ —Å–µ–≥–æ–¥–Ω—è: ${plantsWateredToday}\n`;
                message += `‚Ä¢ –¢—Ä–µ–±—É—é—Ç –ø–æ–ª–∏–≤–∞: ${plantsNeedingWater}\n`;

                if (plantsNeedingWater > 0) {
                    message += `\n‚ö†Ô∏è <b>–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è:</b>\n`;
                    plants.forEach(plant => {
                        if (this.needsWatering(plant.id)) {
                            const daysSinceWatering = this.getDaysSinceLastWatering(plant.id);
                            message += `‚Ä¢ ${plant.name} (${daysSinceWatering} –¥–Ω.)\n`;
                        }
                    });
                }

                if (todayWaterings.length > 0) {
                    message += `\n‚úÖ <b>–ü–æ–ª–∏–≤—ã —Å–µ–≥–æ–¥–Ω—è:</b>\n`;
                    todayWaterings.forEach(watering => {
                        const time = new Date(watering.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                        message += `‚Ä¢ ${time}: ${watering.volume}–ª${recipe ? ` + ${recipe.name}` : ''}\n`;
                    });
                }

                const success = await this.sendTelegramMessage(message);
                
                if (success) {
                    // Update last summary time
                    this.data.settings.telegram.lastDailySummary = new Date().toISOString();
                    this.saveData();
                }
            }

            // Setup daily summary timer
            setupTelegramNotifications() {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.dailySummary) {
                    return;
                }

                // Clear existing timer
                if (this.telegramTimer) {
                    clearInterval(this.telegramTimer);
                }

                // Check every minute for daily summary time
                this.telegramTimer = setInterval(() => {
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5); // HH:MM
                    const summaryTime = telegramSettings.notifications.dailyTime || '09:00';
                    
                    if (currentTime === summaryTime) {
                        this.sendDailySummary();
                    }
                }, 60000); // Check every minute
            }

            // Telegram Integration Methods
            toggleTelegramSettings(enabled) {
                const content = document.getElementById('telegram-settings-content');
                if (enabled) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            }

            toggleDailySummaryTime(enabled) {
                const timeInput = document.getElementById('daily-summary-time');
                if (enabled) {
                    timeInput.classList.remove('hidden');
                } else {
                    timeInput.classList.add('hidden');
                }
            }

            toggleAutoBackupTime(enabled) {
                const timeInput = document.getElementById('auto-backup-time');
                if (enabled) {
                    timeInput.classList.remove('hidden');
                } else {
                    timeInput.classList.add('hidden');
                }
            }

            async sendTelegramMessage(message) {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.botToken || !telegramSettings.chatId) {
                    console.log('Telegram not configured, skipping message');
                    return false;
                }

                try {
                    const response = await fetch(`https://api.telegram.org/bot${telegramSettings.botToken}/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: telegramSettings.chatId,
                            text: message,
                            parse_mode: 'HTML',
                            disable_web_page_preview: true
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.description || `HTTP ${response.status}`);
                    }

                    return true;
                } catch (error) {
                    console.error('Failed to send Telegram message:', error);
                    return false;
                }
            }

            async testTelegramConnection() {
                const statusDiv = document.getElementById('telegram-connection-status');
                const token = document.getElementById('settings-telegram-token').value.trim();
                const chatId = document.getElementById('settings-telegram-chat-id').value.trim();
                
                if (!token || !chatId) {
                    this.showTelegramStatus('error', '‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ Chat ID');
                    return;
                }
                
                this.showTelegramStatus('loading', '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...');
                
                try {
                    const testMessage = `üß™ <b>–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b>\n\n` +
                        `‚úÖ Telegram –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Plant Care Pro!\n` +
                        `üìÖ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}\n` +
                        `üåø –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –≤–∞—à–∏—Ö —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö.`;

                    const response = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: testMessage,
                            parse_mode: 'HTML',
                            disable_web_page_preview: true
                        })
                    });

                    if (response.ok) {
                        this.showTelegramStatus('success', '‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    } else {
                        const error = await response.json();
                        this.showTelegramStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${error.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    }
                } catch (error) {
                    this.showTelegramStatus('error', `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
                }
            }

            async getTelegramChatId() {
                const token = document.getElementById('settings-telegram-token').value.trim();
                
                if (!token) {
                    this.showTelegramStatus('error', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
                    return;
                }
                
                this.showTelegramStatus('loading', '‚è≥ –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞...');
                
                try {
                    const response = await fetch(`https://api.telegram.org/bot${token}/getUpdates?limit=1&offset=-1`);
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.description || '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω');
                    }
                    
                    const data = await response.json();
                    
                    if (data.result && data.result.length > 0) {
                        const chatId = data.result[0].message?.chat?.id || data.result[0].message?.from?.id;
                        
                        if (chatId) {
                            document.getElementById('settings-telegram-chat-id').value = chatId;
                            this.showTelegramStatus('success', `‚úÖ Chat ID –ø–æ–ª—É—á–µ–Ω: ${chatId}\n\n–¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏`);
                        } else {
                            this.showTelegramStatus('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ Chat ID.\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –±–æ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        }
                    } else {
                        this.showTelegramStatus('error', '‚ùå –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞.\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start —Å–≤–æ–µ–º—É –±–æ—Ç—É –≤ Telegram –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                } catch (error) {
                    this.showTelegramStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                }
            }

            async sendPlantStatusToTelegram() {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.botToken || !telegramSettings.chatId) {
                    this.showTelegramStatus('error', '‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é');
                    return;
                }

                this.showTelegramStatus('loading', 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π...');

                const plants = Object.values(this.data.plants);
                
                if (plants.length === 0) {
                    this.showTelegramStatus('error', '‚ùå –ù–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                    return;
                }

                let message = `üåø <b>–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Ç–µ–Ω–∏–π</b>\n`;
                message += `üìÖ ${new Date().toLocaleDateString('ru-RU', { 
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric' 
                })}\n\n`;

                let activePlantsCount = 0;
                let plantsNeedingWater = 0;

                plants.forEach((plant, index) => {
                    const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                    const daysSince = this.getDaysSincePlanting(plant.id, new Date());
                    const needsWatering = this.needsWatering(plant.id);
                    const daysSinceWatering = this.getDaysSinceLastWatering(plant.id);
                    const isActive = this.isPlantActive(plant);

                    if (isActive) activePlantsCount++;
                    if (needsWatering) plantsNeedingWater++;

                    const phaseIcon = this.getPhaseIcon(currentPhase?.type || 'unknown');
                    const statusIcon = needsWatering ? 'üíß' : isActive ? 'üü¢' : 'üî¥';

                    message += `${statusIcon} <b>${plant.name}</b>\n`;
                    if (plant.strain) message += `   üß¨ ${plant.strain}\n`;
                    message += `   üìÖ –î–µ–Ω—å ${daysSince} —Å –ø–æ—Å–∞–¥–∫–∏\n`;
                    message += `   ${phaseIcon} ${this.getPhaseDisplayName(currentPhase?.type || 'unknown')}\n`;
                    
                    if (needsWatering) {
                        message += `   ‚ö†Ô∏è <b>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–∏–≤!</b> (${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥)\n`;
                    } else if (daysSinceWatering <= 1) {
                        message += `   ‚úÖ –ù–µ–¥–∞–≤–Ω–æ –ø–æ–ª–∏—Ç–æ (${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥)\n`;
                    } else {
                        message += `   üíß –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤: ${daysSinceWatering} –¥–Ω. –Ω–∞–∑–∞–¥\n`;
                    }
                    
                    message += '\n';
                });

                // Summary
                message += `üìä <b>–°–≤–æ–¥–∫–∞:</b>\n`;
                message += `‚Ä¢ –í—Å–µ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏–π: ${plants.length}\n`;
                message += `‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activePlantsCount}\n`;
                message += `‚Ä¢ –¢—Ä–µ–±—É—é—Ç –ø–æ–ª–∏–≤–∞: ${plantsNeedingWater}\n`;

                if (plantsNeedingWater > 0) {
                    message += `\n‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> ${plantsNeedingWater} —Ä–∞—Å—Ç–µ–Ω–∏${plantsNeedingWater === 1 ? '–µ —Ç—Ä–µ–±—É–µ—Ç' : plantsNeedingWater < 5 ? '—è —Ç—Ä–µ–±—É—é—Ç' : '–π —Ç—Ä–µ–±—É—é—Ç'} –ø–æ–ª–∏–≤–∞!`;
                }

                const success = await this.sendTelegramMessage(message);
                
                if (success) {
                    this.showTelegramStatus('success', '‚úÖ –°—Ç–∞—Ç—É—Å —Ä–∞—Å—Ç–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
                } else {
                    this.showTelegramStatus('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }
            }

            showTelegramStatus(type, message) {
                const statusDiv = document.getElementById('telegram-connection-status');
                statusDiv.className = `p-3 rounded-lg text-sm whitespace-pre-line ${
                    type === 'success' ? 'bg-green-600/20 border border-green-600/30 text-green-400' :
                    type === 'error' ? 'bg-red-600/20 border border-red-600/30 text-red-400' :
                    'bg-blue-600/20 border border-blue-600/30 text-blue-400'
                }`;
                statusDiv.textContent = message;
                statusDiv.classList.remove('hidden');
                
                if (type !== 'loading') {
                    setTimeout(() => statusDiv.classList.add('hidden'), 8000);
                }
            }

            // Notification triggers
            async notifyWateringNeeded(plantIds) {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.wateringReminders) {
                    return;
                }

                const plants = plantIds.map(id => this.data.plants[id]).filter(plant => plant);
                
                if (plants.length === 0) return;

                let message = `üíß <b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–æ–ª–∏–≤–µ</b>\n\n`;
                
                plants.forEach(plant => {
                    const daysSinceWatering = this.getDaysSinceLastWatering(plant.id);
                    const currentPhase = this.getCurrentLightPhase(plant.id, new Date());
                    
                    message += `üåø <b>${plant.name}</b>\n`;
                    message += `   ${this.getPhaseIcon(currentPhase?.type || 'unknown')} ${this.getPhaseShortName(currentPhase?.type || 'unknown')}\n`;
                    message += `   ‚è∞ ${daysSinceWatering} –¥–Ω. –±–µ–∑ –ø–æ–ª–∏–≤–∞\n\n`;
                });

                message += `üéØ <i>–û—Ç–∫—Ä–æ–π—Ç–µ Plant Care Pro –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª–∏–≤–∞</i>`;

                await this.sendTelegramMessage(message);
            }

            async notifyPhaseChange(plantId, newPhase) {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.phaseChanges) {
                    return;
                }

                const plant = this.data.plants[plantId];
                if (!plant) return;

                const phaseIcon = this.getPhaseIcon(newPhase.type);
                const phaseName = this.getPhaseDisplayName(newPhase.type);

                let message = `üîÑ <b>–°–º–µ–Ω–∞ —Ñ–∞–∑—ã —Ä–æ—Å—Ç–∞</b>\n\n`;
                message += `üåø <b>${plant.name}</b>\n`;
                message += `${phaseIcon} –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ñ–∞–∑—É: <b>${phaseName}</b>\n`;
                message += `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n`;

                // Recommendations based on phase
                if (newPhase.type === 'flowering') {
                    message += `\nüí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n`;
                    message += `‚Ä¢ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Å–≤–µ—Ç–æ–≤–æ–π —Ä–µ–∂–∏–º –Ω–∞ 12/12\n`;
                    message += `‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –¥–ª—è —Ü–≤–µ—Ç–µ–Ω–∏—è\n`;
                    message += `‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç—å—é`;
                } else if (newPhase.type === 'drying') {
                    message += `\nüí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b>\n`;
                    message += `‚Ä¢ –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ –ø–æ–ª–∏–≤\n`;
                    message += `‚Ä¢ –í—ã–∫–ª—é—á–∏—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ\n`;
                    message += `‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É 18-22¬∞C`;
                }

                await this.sendTelegramMessage(message);
            }

            async sendDailySummary() {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.dailySummary) {
                    return;
                }

                // Check if summary was already sent today
                const today = new Date().toDateString();
                const lastSummary = telegramSettings.lastDailySummary;
                
                if (lastSummary && new Date(lastSummary).toDateString() === today) {
                    return; // Already sent today
                }

                const plants = Object.values(this.data.plants);
                
                if (plants.length === 0) return;

                let message = `üåÖ <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞</b>\n`;
                message += `üìÖ ${new Date().toLocaleDateString('ru-RU', { 
                    weekday: 'long', 
                    day: '2-digit', 
                    month: 'long' 
                })}\n\n`;

                let activePlants = 0;
                let plantsNeedingWater = 0;
                let plantsWateredToday = 0;

                // Check today's waterings
                const todayStr = this.getLocalDateString(new Date());
                const todayWaterings = Object.values(this.data.wateringHistory).filter(watering => {
                    const wateringDate = this.getLocalDateString(new Date(watering.date));
                    return wateringDate === todayStr;
                });

                const wateredPlantIds = new Set();
                todayWaterings.forEach(watering => {
                    watering.plantIds.forEach(id => wateredPlantIds.add(id));
                });

                plantsWateredToday = wateredPlantIds.size;

                plants.forEach(plant => {
                    const isActive = this.isPlantActive(plant);
                    const needsWatering = this.needsWatering(plant.id);
                    
                    if (isActive) activePlants++;
                    if (needsWatering) plantsNeedingWater++;
                });

                message += `üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n`;
                message += `‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π: ${activePlants}/${plants.length}\n`;
                message += `‚Ä¢ –ü–æ–ª–∏—Ç–æ —Å–µ–≥–æ–¥–Ω—è: ${plantsWateredToday}\n`;
                message += `‚Ä¢ –¢—Ä–µ–±—É—é—Ç –ø–æ–ª–∏–≤–∞: ${plantsNeedingWater}\n`;

                if (plantsNeedingWater > 0) {
                    message += `\n‚ö†Ô∏è <b>–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è:</b>\n`;
                    plants.forEach(plant => {
                        if (this.needsWatering(plant.id)) {
                            const daysSinceWatering = this.getDaysSinceLastWatering(plant.id);
                            message += `‚Ä¢ ${plant.name} (${daysSinceWatering} –¥–Ω.)\n`;
                        }
                    });
                }

                if (todayWaterings.length > 0) {
                    message += `\n‚úÖ <b>–ü–æ–ª–∏–≤—ã —Å–µ–≥–æ–¥–Ω—è:</b>\n`;
                    todayWaterings.forEach(watering => {
                        const time = new Date(watering.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                        message += `‚Ä¢ ${time}: ${watering.volume}–ª${recipe ? ` + ${recipe.name}` : ''}\n`;
                    });
                }

                const success = await this.sendTelegramMessage(message);
                
                if (success) {
                    // Update last summary time
                    this.data.settings.telegram.lastDailySummary = new Date().toISOString();
                    this.saveData();
                }
            }

            // Setup daily summary timer
            setupTelegramNotifications() {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.notifications.dailySummary) {
                    return;
                }

                // Clear existing timer
                if (this.telegramTimer) {
                    clearInterval(this.telegramTimer);
                }

                // Check every minute for daily summary time
                this.telegramTimer = setInterval(() => {
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5); // HH:MM
                    const summaryTime = telegramSettings.notifications.dailyTime || '09:00';
                    
                    if (currentTime === summaryTime) {
                        this.sendDailySummary();
                    }
                }, 60000); // Check every minute
            }

            async sendBackupToTelegram() {
                const telegramSettings = this.data.settings.telegram;
                
                if (!telegramSettings.enabled || !telegramSettings.botToken || !telegramSettings.chatId) {
                    this.showTelegramStatus('error', '‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é');
                    return;
                }

                this.showTelegramStatus('loading', 'üì§ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—ç–∫–∞–ø–∞...');

                try {
                    // Create backup JSON
                    const backupData = JSON.stringify(this.data, null, 2);
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    const filename = `plant-care-backup-${timestamp}.json`;
                    
                    // Create file blob
                    const blob = new Blob([backupData], { type: 'application/json' });
                    
                    // Prepare form data for file upload
                    const formData = new FormData();
                    formData.append('chat_id', telegramSettings.chatId);
                    formData.append('document', blob, filename);
                    
                    // Add caption with backup info
                    const plants = Object.values(this.data.plants);
                    const waterings = Object.values(this.data.wateringHistory);
                    const dataSize = Math.round(backupData.length / 1024);
                    
                    const caption = `üìÅ <b>–ë—ç–∫–∞–ø Plant Care Pro</b>\n\n` +
                        `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}\n` +
                        `üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:\n` +
                        `‚Ä¢ –†–∞—Å—Ç–µ–Ω–∏–π: ${plants.length}\n` +
                        `‚Ä¢ –ó–∞–ø–∏—Å–µ–π –ø–æ–ª–∏–≤–æ–≤: ${waterings.length}\n` +
                        `‚Ä¢ –£–¥–æ–±—Ä–µ–Ω–∏–π: ${Object.keys(this.data.fertilizers).length}\n` +
                        `‚Ä¢ –†–µ—Ü–µ–ø—Ç–æ–≤: ${Object.keys(this.data.recipes).length}\n` +
                        `üì¶ –†–∞–∑–º–µ—Ä: ${dataSize} –ö–ë\n\n` +
                        `üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö`;
                    
                    formData.append('caption', caption);
                    formData.append('parse_mode', 'HTML');

                    // Send file to Telegram
                    const response = await fetch(`https://api.telegram.org/bot${telegramSettings.botToken}/sendDocument`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        this.showTelegramStatus('success', '‚úÖ –ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!');
                    } else {
                        const error = await response.json();
                        throw new Error(error.description || `HTTP ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error('Error sending backup to Telegram:', error);
                    this.showTelegramStatus('error', `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ç–∫–∞–ø–∞: ${error.message}`);
                }
            }

            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `plant-care-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification('üìÅ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            }

            importData() {
                document.getElementById('data-import-input').click();
            }

            handleDataImport(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // Validate data structure
                        if (!importedData.plants || !importedData.settings) {
                            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                        }
                        
                        // Confirm import
                        const plantsCount = Object.keys(importedData.plants).length;
                        const wateringsCount = Object.keys(importedData.wateringHistory || {}).length;
                        
                        const confirmMessage = `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?\n\n` +
                            `üìä –ù–∞–π–¥–µ–Ω–æ:\n` +
                            `‚Ä¢ –†–∞—Å—Ç–µ–Ω–∏–π: ${plantsCount}\n` +
                            `‚Ä¢ –ó–∞–ø–∏—Å–µ–π –ø–æ–ª–∏–≤–æ–≤: ${wateringsCount}\n` +
                            `‚Ä¢ –£–¥–æ–±—Ä–µ–Ω–∏–π: ${Object.keys(importedData.fertilizers || {}).length}\n` +
                            `‚Ä¢ –†–µ—Ü–µ–ø—Ç–æ–≤: ${Object.keys(importedData.recipes || {}).length}\n\n` +
                            `‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!`;
                        
                        if (confirm(confirmMessage)) {
                            // Preserve current settings if not in import
                            if (this.data.settings.appTitle && !importedData.settings.appTitle) {
                                importedData.settings.appTitle = this.data.settings.appTitle;
                            }
                            if (this.data.settings.homeAssistant && !importedData.settings.homeAssistant) {
                                importedData.settings.homeAssistant = this.data.settings.homeAssistant;
                            }
                            
                            this.data = importedData;
                            this.data.settings.currentDate = new Date(this.data.settings.currentDate || new Date());
                            this.saveData();
                            
                            // Reinitialize
                            this.initializePlantPhases();
                            this.renderUI();
                            
                            this.showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                        }
                        
                    } catch (error) {
                        this.showNotification(`‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
                    }
                    
                    // Reset file input
                    e.target.value = '';
                };
                
                reader.readAsText(file);
            }

            // History rendering
            renderWateringHistory() {
                this.renderHistoryFilters();
                this.renderHistoryStats();
                this.renderHistoryList();
                
                // Add event listeners for filters
                document.getElementById('history-plant-filter').addEventListener('change', () => this.renderHistoryList());
                document.getElementById('history-period-filter').addEventListener('change', () => this.renderHistoryList());
            }

            renderHistoryFilters() {
                const plantFilter = document.getElementById('history-plant-filter');
                const plants = Object.values(this.data.plants);
                
                plantFilter.innerHTML = '<option value="">–í—Å–µ —Ä–∞—Å—Ç–µ–Ω–∏—è</option>';
                plants.forEach(plant => {
                    const option = document.createElement('option');
                    option.value = plant.id;
                    option.textContent = plant.name;
                    plantFilter.appendChild(option);
                });
            }

            getFilteredWaterings() {
                const plantFilter = document.getElementById('history-plant-filter')?.value || '';
                const periodFilter = document.getElementById('history-period-filter')?.value || '30';
                
                let waterings = Object.values(this.data.wateringHistory);
                
                // Filter by plant
                if (plantFilter) {
                    waterings = waterings.filter(watering => watering.plantIds.includes(plantFilter));
                }
                
                // Filter by period
                if (periodFilter !== 'all') {
                    const daysAgo = parseInt(periodFilter);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                    
                    waterings = waterings.filter(watering => new Date(watering.date) >= cutoffDate);
                }
                
                // Sort by date (newest first)
                return waterings.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            renderHistoryStats() {
                const waterings = this.getFilteredWaterings();
                
                const totalWaterings = waterings.length;
                const totalVolume = waterings.reduce((sum, w) => sum + w.volume, 0);
                const averageVolume = totalWaterings > 0 ? totalVolume / totalWaterings : 0;
                
                // Find most popular recipe
                const recipeCounts = {};
                waterings.forEach(watering => {
                    if (watering.recipeId) {
                        recipeCounts[watering.recipeId] = (recipeCounts[watering.recipeId] || 0) + 1;
                    }
                });
                
                let popularRecipe = '–¢–æ–ª—å–∫–æ –≤–æ–¥–∞';
                let maxCount = 0;
                Object.entries(recipeCounts).forEach(([recipeId, count]) => {
                    if (count > maxCount) {
                        maxCount = count;
                        const recipe = this.data.recipes[recipeId];
                        if (recipe) {
                            popularRecipe = recipe.name;
                        }
                    }
                });
                
                document.getElementById('total-waterings').textContent = totalWaterings;
                document.getElementById('total-volume').textContent = totalVolume.toFixed(1) + '–ª';
                document.getElementById('average-volume').textContent = averageVolume.toFixed(1) + '–ª';
                document.getElementById('popular-recipe').textContent = popularRecipe;
            }

            renderHistoryList() {
                const container = document.getElementById('watering-history-list');
                const waterings = this.getFilteredWaterings();
                
                container.innerHTML = '';
                
                if (waterings.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <div class="text-lg font-medium mb-2">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–æ–ª–∏–≤–µ</div>
                            <div class="text-sm">–ó–∞–ø–∏—Å–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–∏–≤–æ–≤</div>
                        </div>
                    `;
                    this.renderHistoryStats(); // Update stats for empty state
                    return;
                }
                
                // Group waterings by date
                const wateringsByDate = {};
                waterings.forEach(watering => {
                    const dateStr = new Date(watering.date).toLocaleDateString('ru-RU');
                    if (!wateringsByDate[dateStr]) {
                        wateringsByDate[dateStr] = [];
                    }
                    wateringsByDate[dateStr].push(watering);
                });
                
                Object.entries(wateringsByDate).forEach(([dateStr, dayWaterings]) => {
                    // Date header
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'flex items-center gap-3 py-3 px-4 bg-gray-800 rounded-lg mb-2 sticky top-0 z-10';
                    
                    const date = new Date(dayWaterings[0].date);
                    const isToday = date.toLocaleDateString('ru-RU') === new Date().toLocaleDateString('ru-RU');
                    const isYesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU') === date.toLocaleDateString('ru-RU');
                    
                    let dateLabel = dateStr;
                    if (isToday) dateLabel = `–°–µ–≥–æ–¥–Ω—è ‚Ä¢ ${dateStr}`;
                    else if (isYesterday) dateLabel = `–í—á–µ—Ä–∞ ‚Ä¢ ${dateStr}`;
                    
                    dateHeader.innerHTML = `
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="font-medium">${dateLabel}</span>
                        <span class="text-sm text-gray-400">${dayWaterings.length} –ø–æ–ª–∏–≤${dayWaterings.length === 1 ? '' : dayWaterings.length < 5 ? '–∞' : '–æ–≤'}</span>
                    `;
                    container.appendChild(dateHeader);
                    
                    // Waterings for this date
                    dayWaterings.forEach(watering => {
                        const time = new Date(watering.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        const recipe = watering.recipeId ? this.data.recipes[watering.recipeId] : null;
                        const plantsNames = watering.plantIds.map(id => this.data.plants[id]?.name || '–£–¥–∞–ª–µ–Ω–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ').join(', ');
                        
                        const wateringCard = document.createElement('div');
                        wateringCard.className = 'bg-dark p-4 rounded-lg ml-8 mb-2 group hover:bg-gray-800 transition-colors';
                        wateringCard.innerHTML = `
                            <div class="flex items-start justify-between">
                                <div class="flex items-start gap-3 flex-1">
                                    <div class="bg-blue-600/20 p-2 rounded-lg">
                                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-medium text-lg">${watering.volume}–ª</span>
                                            <span class="text-gray-400">‚Ä¢</span>
                                            <span class="text-gray-300">${time}</span>
                                            ${recipe ? `
                                                <span class="text-gray-400">‚Ä¢</span>
                                                <span class="text-primary text-sm font-medium">${recipe.name}</span>
                                            ` : `
                                                <span class="text-gray-400">‚Ä¢</span>
                                                <span class="text-gray-500 text-sm">—Ç–æ–ª—å–∫–æ –≤–æ–¥–∞</span>
                                            `}
                                        </div>
                                        <div class="text-sm text-gray-400 mb-2">
                                            üåø ${plantsNames}
                                        </div>
                                        ${watering.notes ? `
                                            <div class="text-sm text-gray-300 bg-gray-700/50 p-2 rounded italic">
                                                "${watering.notes}"
                                            </div>
                                        ` : ''}
                                        ${recipe ? `
                                            <div class="mt-2 text-xs text-gray-500">
                                                ${recipe.fertilizers.map(fert => {
                                                    const fertilizer = this.data.fertilizers[fert.fertilizerId];
                                                    if (fertilizer) {
                                                        const totalAmount = (fert.dose * watering.volume).toFixed(1);
                                                        return `${fertilizer.name}: ${totalAmount}–º–ª`;
                                                    }
                                                    return '';
                                                }).filter(Boolean).join(' ‚Ä¢ ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <button onclick="app.deleteWateringConfirm('${watering.id}')" 
                                        class="opacity-0 group-hover:opacity-100 p-2 bg-red-600/20 hover:bg-red-600/40 rounded-lg transition-all duration-200"
                                        title="–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –ø–æ–ª–∏–≤–µ">
                                    <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        `;
                        container.appendChild(wateringCard);
                    });
                });
                
                this.renderHistoryStats(); // Update stats after rendering
            }
        }

        // Initialize app
        window.app = new PlantCareApp();
    </script>
</body>
</html>